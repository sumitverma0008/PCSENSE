<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>PCSensei | Intelligent PC & Laptop Consultant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXX"
            crossorigin="anonymous"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            dark: '#0f172a',
                            accent: '#3b82f6',
                            glass: 'rgba(15, 23, 42, 0.8)'
                        }
                    },
                    animation: {
                        'slide-up': 'slideUp 0.5s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }
        .dark-glass {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        .ad-container {
            margin: 20px auto;
            text-align: center;
            min-height: 100px;
            background: rgba(248, 250, 252, 0.5);
            border-radius: 8px;
            padding: 10px;
            border: 1px dashed rgba(203, 213, 225, 0.5);
        }
        .ad-label {
            font-size: 10px;
            color: #94a3b8;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .shop-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            animation: fadeIn 0.2s ease-out;
        }
        .shop-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }
        .store-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            transition: all 0.2s;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
        }
        .store-btn:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
            transform: translateX(4px);
        }
        .store-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .chat-msg {
            animation: slideUp 0.3s ease-out;
        }
        
        /* Enhanced hover effects */
        button, a {
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        /* Currency styling */
        .price-value {
            font-variant-numeric: tabular-nums;
        }
        
        /* Improved responsive design */
        @media (max-width: 640px) {
            #ai-chat-panel {
                width: calc(100vw - 32px);
                right: 16px;
                left: 16px;
            }
            
            .glass-panel {
                backdrop-filter: blur(8px);
            }
            
            h2, h3 {
                font-size: 1.5rem;
            }
        }
        
        @media (max-width: 768px) {
            .max-w-7xl {
                padding-left: 1rem;
                padding-right: 1rem;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans selection:bg-blue-200">

    <!-- Navbar -->
    <nav class="fixed w-full z-50 glass-panel shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2 cursor-pointer" onclick="goHome()">
                    <div class="w-10 h-10 bg-brand-dark rounded-lg flex items-center justify-center text-blue-400">
                        <i class="fa-solid fa-cube text-xl"></i>
                    </div>
                    <span class="font-bold text-xl tracking-tight text-slate-900">PCSensei</span>
                </div>
                
                <div class="hidden md:flex space-x-8 items-center">
                    <a href="#" onclick="goHome()" class="text-slate-600 hover:text-blue-600 transition font-medium">Home</a>
                    <a href="#builder" onclick="startWizard()" class="text-slate-600 hover:text-blue-600 transition font-medium">Builder</a>
                    <a href="admin.html" class="text-slate-600 hover:text-blue-600 transition font-medium flex items-center gap-1">
                        <i class="fa-solid fa-user-shield"></i> Admin
                    </a>
                    <div class="h-6 w-px bg-slate-300"></div>
                    <button onclick="toggleLiveSupport()" class="flex items-center gap-2 text-green-600 font-bold hover:text-green-700 transition">
                        <span class="relative flex h-3 w-3">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                        </span>
                        Talk to Expert
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="pt-16 min-h-screen relative">
        
        <!-- View: Landing Page -->
        <div id="view-landing" class="block">
            <div class="relative bg-slate-900 h-[600px] overflow-hidden">
                <div class="absolute inset-0">
                    <img src="https://images.unsplash.com/photo-1593640408182-31c70c8268f5?auto=format&fit=crop&q=80" class="w-full h-full object-cover opacity-20">
                    <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/80 to-transparent"></div>
                </div>
                
                <div class="relative max-w-7xl mx-auto px-4 pt-32 text-center text-white">
                    <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-blue-500/10 border border-blue-500/30 text-blue-400 text-sm font-medium mb-6">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> AI-Powered Recommendations
                    </div>
                    <h1 class="text-4xl md:text-6xl font-extrabold tracking-tight mb-6">
                        Build Your Dream PC.<br>
                        <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">Or Find the Perfect Laptop.</span>
                    </h1>
                    <p class="text-xl text-slate-400 max-w-2xl mx-auto mb-6">
                        Tell us your budget (starting at ‚Çπ15,000) and goals. We predict performance and find compatible parts instantly.
                    </p>
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button onclick="startWizard()" class="px-8 py-4 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold text-lg transition shadow-lg shadow-blue-500/25 flex items-center justify-center gap-2">
                            Start Consultation <i class="fa-solid fa-arrow-right"></i>
                        </button>
                        <button onclick="toggleAI()" class="px-8 py-4 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl font-bold text-lg transition backdrop-blur-sm flex items-center justify-center gap-2">
                            <i class="fa-solid fa-robot"></i> Ask AI Assistant
                        </button>
                    </div>
                </div>
            </div>

            <!-- Ad: Top Banner (After Hero) -->
            <div class="max-w-7xl mx-auto px-4 py-6">
                <div class="ad-container">
                    <div class="ad-label">Advertisement</div>
                    <!-- Google AdSense Banner Ad (728x90 or Responsive) -->
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-XXXXXXXXXX"
                         data-ad-slot="XXXXXXXXXX"
                         data-ad-format="horizontal"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
            </div>

            <!-- Features Grid -->
            <div class="py-20 max-w-7xl mx-auto px-4">
                <div class="grid md:grid-cols-3 gap-8">
                    <div class="p-6 rounded-2xl bg-white border border-slate-200 shadow-sm hover:shadow-md transition">
                        <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center text-xl mb-4"><i class="fa-solid fa-gauge-high"></i></div>
                        <h3 class="text-xl font-bold mb-2">Performance Prediction</h3>
                        <p class="text-slate-500">See estimated FPS for games or software performance for Workstations/Dev.</p>
                    </div>
                    <div class="p-6 rounded-2xl bg-white border border-slate-200 shadow-sm hover:shadow-md transition">
                        <div class="w-12 h-12 bg-purple-100 text-purple-600 rounded-lg flex items-center justify-center text-xl mb-4"><i class="fa-solid fa-indian-rupee-sign"></i></div>
                        <h3 class="text-xl font-bold mb-2">Budget Friendly</h3>
                        <p class="text-slate-500">Support for builds starting from ‚Çπ15,000 up to ultra-high-end workstations (5L+).</p>
                    </div>
                    <div class="p-6 rounded-2xl bg-white border border-slate-200 shadow-sm hover:shadow-md transition">
                        <div class="w-12 h-12 bg-emerald-100 text-emerald-600 rounded-lg flex items-center justify-center text-xl mb-4"><i class="fa-solid fa-headset"></i></div>
                        <h3 class="text-xl font-bold mb-2">Expert Support</h3>
                        <p class="text-slate-500">Stuck? Chat with our AI instantly or request a live session with a human hardware expert.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- View: Wizard -->
        <div id="view-wizard" class="hidden min-h-[80vh] bg-slate-100 py-12">
            <div class="max-w-3xl mx-auto px-4">
                <div class="mb-8 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-slate-800">Configuration Wizard</h2>
                    <div class="text-sm text-slate-500">Step <span id="wiz-step-num">1</span> of 4</div>
                </div>
                
                <!-- Progress Bar -->
                <div class="w-full bg-slate-200 h-2 rounded-full mb-8">
                    <div id="wiz-progress" class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: 25%"></div>
                </div>

                <div class="bg-white rounded-2xl shadow-xl p-8 animate-slide-up relative overflow-hidden">
                    
                    <!-- Step 1: Form Factor -->
                    <div id="step-1" class="wizard-step">
                        <h3 class="text-xl font-bold mb-6">What type of computer do you need?</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <button onclick="setFormFactor('desktop')" class="p-8 border-2 border-slate-100 hover:border-blue-500 rounded-2xl text-center hover:bg-blue-50 transition group">
                                <i class="fa-solid fa-desktop text-5xl text-slate-300 group-hover:text-blue-600 mb-4 transition"></i>
                                <div class="font-bold text-xl text-slate-800">Desktop PC</div>
                                <p class="text-sm text-slate-500 mt-2">Best performance & upgradability.</p>
                            </button>
                            <button onclick="setFormFactor('laptop')" class="p-8 border-2 border-slate-100 hover:border-blue-500 rounded-2xl text-center hover:bg-blue-50 transition group">
                                <i class="fa-solid fa-laptop text-5xl text-slate-300 group-hover:text-blue-600 mb-4 transition"></i>
                                <div class="font-bold text-xl text-slate-800">Laptop</div>
                                <p class="text-sm text-slate-500 mt-2">Portability & convenience.</p>
                            </button>
                        </div>
                    </div>

                    <!-- Step 2: Usage -->
                    <div id="step-2" class="wizard-step hidden">
                        <h3 class="text-xl font-bold mb-6">What is your primary use case?</h3>
                        <div class="grid gap-4">
                            <button onclick="setUsage('gaming')" class="w-full p-4 border-2 border-slate-100 hover:border-blue-500 rounded-xl text-left hover:bg-blue-50 transition group flex items-center gap-4">
                                <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center text-slate-600 group-hover:bg-blue-100 group-hover:text-blue-600"><i class="fa-solid fa-gamepad"></i></div>
                                <div>
                                    <div class="font-bold text-slate-800">Gaming & Streaming</div>
                                    <div class="text-sm text-slate-500">High FPS, AAA Titles, 1440p/4K</div>
                                </div>
                            </button>
                            <button onclick="setUsage('productivity')" class="w-full p-4 border-2 border-slate-100 hover:border-blue-500 rounded-xl text-left hover:bg-blue-50 transition group flex items-center gap-4">
                                <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center text-slate-600 group-hover:bg-blue-100 group-hover:text-blue-600"><i class="fa-solid fa-briefcase"></i></div>
                                <div>
                                    <div class="font-bold text-slate-800">Workstation / Office</div>
                                    <div class="text-sm text-slate-500">Video Editing, 3D, Office Apps, Student work</div>
                                </div>
                            </button>
                            <button onclick="setUsage('coding')" class="w-full p-4 border-2 border-slate-100 hover:border-blue-500 rounded-xl text-left hover:bg-blue-50 transition group flex items-center gap-4">
                                <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center text-slate-600 group-hover:bg-blue-100 group-hover:text-blue-600"><i class="fa-solid fa-code"></i></div>
                                <div>
                                    <div class="font-bold text-slate-800">Programming & Dev</div>
                                    <div class="text-sm text-slate-500">Virtual Machines, Docker, Compiling</div>
                                </div>
                            </button>
                            <div class="pt-4">
                                <button onclick="navWizard(1)" class="text-slate-500 hover:text-slate-800">Back</button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Budget -->
                    <div id="step-3" class="wizard-step hidden">
                        <h3 class="text-xl font-bold mb-6">What is your maximum budget? (INR)</h3>
                        <div class="space-y-6">
                            <input type="range" min="15000" max="500000" step="5000" value="50000" id="budget-range" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600" oninput="updateBudget(this.value)">
                            <div class="text-center">
                                <div class="price-value">
                                    <span class="text-4xl font-bold text-blue-600"><span style="font-size: 0.7em; opacity: 0.8;">‚Çπ</span><span id="budget-val">50,000</span></span>
                                </div>
                                <p class="text-slate-400 mt-2 text-sm flex items-center justify-center gap-2"><i class="fa-solid fa-info-circle"></i> We'll find the best <span id="budget-type-text">PC</span> within this limit.</p>
                            </div>
                            <div class="flex justify-between pt-6">
                                <button onclick="navWizard(2)" class="text-slate-500 hover:text-slate-800">Back</button>
                                <button onclick="navWizard(4)" class="bg-slate-900 text-white px-6 py-2 rounded-lg hover:bg-slate-800">Next Step</button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Brand & Aesthetics -->
                    <div id="step-4" class="wizard-step hidden">
                        <h3 class="text-xl font-bold mb-4">Final Preferences</h3>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-slate-700 mb-2">CPU Preference</label>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="setPref('cpu', 'Intel')" id="btn-cpu-intel" class="pref-btn border rounded-lg p-3 text-center hover:bg-slate-50">Intel</button>
                                <button onclick="setPref('cpu', 'AMD')" id="btn-cpu-amd" class="pref-btn border rounded-lg p-3 text-center hover:bg-slate-50">AMD</button>
                                <button onclick="setPref('cpu', 'Any')" id="btn-cpu-any" class="pref-btn bg-blue-50 border-blue-500 border rounded-lg p-3 text-center text-blue-700 font-bold">Any</button>
                            </div>
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-slate-700 mb-2">GPU Preference</label>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="setPref('gpu', 'NVIDIA')" id="btn-gpu-nvidia" class="pref-btn border rounded-lg p-3 text-center hover:bg-slate-50">NVIDIA</button>
                                <button onclick="setPref('gpu', 'AMD')" id="btn-gpu-amd" class="pref-btn border rounded-lg p-3 text-center hover:bg-slate-50">AMD</button>
                                <button onclick="setPref('gpu', 'Any')" id="btn-gpu-any" class="pref-btn bg-blue-50 border-blue-500 border rounded-lg p-3 text-center text-blue-700 font-bold">Any</button>
                            </div>
                        </div>

                        <div class="flex justify-between pt-4">
                            <button onclick="navWizard(3)" class="text-slate-500 hover:text-slate-800 transition-colors flex items-center gap-2 px-4 py-2 hover:bg-slate-100 rounded-lg"><i class="fa-solid fa-arrow-left"></i> Back</button>
                            <button onclick="generateBuild()" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 font-bold shadow-lg shadow-blue-500/30 transition-all hover:shadow-xl flex items-center gap-2">
                                <i class="fa-solid fa-magic"></i> See Recommendation
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- View: Results -->
        <div id="view-results" class="hidden min-h-screen bg-slate-50 pb-20">
            <div class="bg-slate-900 text-white py-12 px-4">
                <div class="max-w-7xl mx-auto text-center">
                    <h2 class="text-3xl font-bold mb-2">Your Recommendation</h2>
                    <p class="text-slate-400">Optimized for <span id="res-usage" class="text-white font-bold capitalize">Gaming</span> ‚Ä¢ Budget: <span id="res-budget"></span></p>
                </div>
            </div>

            <div class="max-w-7xl mx-auto px-4 -mt-8">
                <div class="bg-white rounded-xl shadow-xl overflow-hidden border border-slate-200">
                    
                    <!-- Build Summary Header -->
                    <div class="bg-blue-50 p-6 border-b border-blue-100 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="flex items-center gap-3">
                            <div class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-bold flex items-center gap-2">
                                <i class="fa-solid fa-check-circle"></i> Best Match Found
                            </div>
                            <span class="text-sm text-slate-500">Generated by PCSensei Engine</span>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-slate-500">Estimated Price</div>
                            <div class="text-3xl font-bold text-slate-900" id="total-price">‚Çπ0</div>
                        </div>
                    </div>

                    <!-- Dynamic Performance Section -->
                    <div id="performance-section" class="p-6 bg-slate-50 border-b border-slate-200">
                        <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <span id="perf-icon"></span>
                            <span id="perf-title">Performance Estimates</span>
                        </h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" id="benchmark-cards">
                            <!-- Injected via JS -->
                        </div>
                    </div>

                    <!-- Parts List Container -->
                    <div class="p-0" id="parts-container">
                        <!-- Parts injected via JS -->
                    </div>

                    <!-- Actions -->
                    <div class="p-6 bg-slate-50 border-t border-slate-200 flex flex-wrap justify-end gap-4">
                        <button onclick="startWizard()" class="px-6 py-2 border border-slate-300 rounded-lg hover:bg-white text-slate-600 transition-all hover:shadow-md flex items-center gap-2"><i class="fa-solid fa-edit"></i> Edit Preferences</button>
                        <button onclick="window.print()" class="px-6 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition-all hover:shadow-lg flex items-center gap-2"><i class="fa-solid fa-print"></i> Save Details</button>
                    </div>
                </div>
                
                <!-- Ad: Results Page Sidebar -->
                <div class="mt-8">
                    <div class="ad-container">
                        <div class="ad-label">Advertisement</div>
                        <!-- Google AdSense Sidebar Ad (300x250 or Responsive) -->
                        <ins class="adsbygoogle"
                             style="display:block"
                             data-ad-client="ca-pub-XXXXXXXXXX"
                             data-ad-slot="XXXXXXXXXX"
                             data-ad-format="auto"
                             data-full-width-responsive="true"></ins>
                        <script>
                             (adsbygoogle = window.adsbygoogle || []).push({});
                        </script>
                    </div>
                </div>

                <!-- AI Explanation -->
                <div class="mt-8 bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex gap-4">
                    <div class="w-12 h-12 bg-purple-100 text-purple-600 rounded-full flex-shrink-0 flex items-center justify-center text-xl">
                        <i class="fa-solid fa-robot"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-slate-800 mb-2">Why this choice?</h4>
                        <p class="text-slate-600 leading-relaxed" id="build-reasoning">
                            Loading reasoning...
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ad: Before Footer -->
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="ad-container">
                <div class="ad-label">Advertisement</div>
                <!-- Google AdSense Large Rectangle Ad (336x280 or Responsive) -->
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-XXXXXXXXXX"
                     data-ad-slot="XXXXXXXXXX"
                     data-ad-format="rectangle"
                     data-full-width-responsive="true"></ins>
                <script>
                     (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
            </div>
        </div>

        <!-- Footer -->
        <footer class="bg-slate-900 text-white py-8 mt-20">
            <div class="max-w-7xl mx-auto px-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div>
                        <div class="flex items-center gap-2 mb-4">
                            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                                <i class="fa-solid fa-cube text-xl"></i>
                            </div>
                            <span class="font-bold text-xl">PCSensei</span>
                        </div>
                        <p class="text-slate-400 text-sm">AI-powered PC building assistant with smart recommendations and automated price monitoring.</p>
                    </div>
                    <div>
                        <h4 class="font-bold mb-4">Quick Links</h4>
                        <ul class="space-y-2 text-slate-400 text-sm">
                            <li><a href="#" onclick="goHome()" class="hover:text-white transition">Home</a></li>
                            <li><a href="#builder" onclick="startWizard()" class="hover:text-white transition">Build PC</a></li>
                            <li><a href="price-dashboard.html" class="hover:text-white transition">Price Updates</a></li>
                            <li><a href="https://github.com/sumitverma0008/PCSENSE" target="_blank" class="hover:text-white transition">GitHub</a></li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold mb-4">Admin Access</h4>
                        <a href="admin.html" class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg transition font-semibold">
                            <i class="fa-solid fa-user-shield"></i> Admin Panel
                        </a>
                        <p class="text-slate-400 text-xs mt-4">Manage components, view analytics, and monitor price updates.</p>
                    </div>
                </div>
                <div class="border-t border-slate-800 mt-8 pt-6 text-center text-slate-400 text-sm">
                    <p>¬© 2025 PCSensei. Built with ‚ù§Ô∏è for PC enthusiasts.</p>
                </div>
            </div>
        </footer>

    </main>

    <!-- Shopping Options Modal -->
    <div id="shop-modal" class="shop-modal" onclick="closeShopModal(event)">
        <div class="shop-modal-content" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-slate-800">Compare & Buy</h3>
                <button onclick="closeShopModal()" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center text-slate-400 hover:text-slate-600">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <p class="text-sm text-slate-600 mb-6" id="shop-product-name"></p>
            <div class="space-y-3" id="shop-links-container">
                <!-- Store links will be injected here -->
            </div>
        </div>
    </div>

    <!-- Floating UI: AI Chat -->
    <div id="ai-chat-panel" class="fixed bottom-24 right-6 w-96 h-[500px] glass-panel rounded-2xl shadow-2xl transform translate-y-[120%] transition-transform duration-300 z-40 flex flex-col">
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 p-4 rounded-t-2xl flex justify-between items-center text-white shadow-lg">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                    <i class="fa-solid fa-robot"></i>
                </div>
                <div>
                    <span class="font-bold block">PCSensei AI</span>
                    <span class="text-xs opacity-80">Online ‚Ä¢ Ready to help</span>
                </div>
            </div>
            <button onclick="toggleAI()" class="hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all"><i class="fa-solid fa-times"></i></button>
        </div>
        <div id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50/50">
            <!-- Msgs -->
            <div class="flex gap-2">
                <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 text-xs"><i class="fa-solid fa-robot"></i></div>
                <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-700 max-w-[80%] border border-slate-100">
                    Hello! I can help you verify compatibility or suggest alternatives. Ask me anything!
                </div>
            </div>
        </div>
        <div class="p-3 bg-white border-t border-slate-200 rounded-b-2xl">
            <div class="flex gap-2">
                <input type="text" id="chat-input" placeholder="Ask about laptop specs..." class="flex-1 bg-slate-100 border-0 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 text-sm" onkeypress="handleChat(event)">
                <button onclick="sendMessage()" class="bg-purple-600 text-white w-10 h-10 rounded-lg hover:bg-purple-700"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- Floating UI: Live Support -->
    <div id="live-support-panel" class="fixed top-20 right-6 w-96 bg-white rounded-xl shadow-2xl border border-slate-200 z-50 hidden animate-slide-up">
        <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-gradient-to-r from-green-500 to-green-600 rounded-t-xl">
            <div class="flex items-center gap-2">
                <div class="relative">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-white opacity-30"></span>
                    <i class="fa-solid fa-headset text-white text-lg"></i>
                </div>
                <div>
                    <h3 class="font-bold text-white">Expert Support</h3>
                    <p class="text-xs text-green-100">Available Now</p>
                </div>
            </div>
            <button onclick="toggleLiveSupport()" class="text-white hover:text-green-100"><i class="fa-solid fa-times"></i></button>
        </div>
        <div id="expert-chat-messages" class="p-4 h-96 overflow-y-auto bg-slate-50 space-y-3">
            <div class="flex items-start gap-2">
                <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-xs flex-shrink-0">
                    <i class="fa-solid fa-user-tie"></i>
                </div>
                <div class="bg-white rounded-lg p-3 shadow-sm max-w-[80%]">
                    <p class="text-sm text-slate-700">üëã Hi! I'm your PC building expert. I can help you with:</p>
                    <ul class="text-xs text-slate-600 mt-2 space-y-1">
                        <li>‚Ä¢ Component compatibility</li>
                        <li>‚Ä¢ Performance optimization</li>
                        <li>‚Ä¢ Budget recommendations</li>
                        <li>‚Ä¢ Troubleshooting builds</li>
                        <li>‚Ä¢ Gaming/workstation advice</li>
                    </ul>
                    <p class="text-sm text-slate-700 mt-2">How can I help you today?</p>
                    <div class="flex flex-wrap gap-2 mt-3">
                        <button onclick="sendQuickQuestion('Review my build')" class="text-xs bg-green-50 hover:bg-green-100 text-green-700 px-3 py-1.5 rounded-full border border-green-200 transition">Review my build</button>
                        <button onclick="sendQuickQuestion('My PC won\\'t boot')" class="text-xs bg-green-50 hover:bg-green-100 text-green-700 px-3 py-1.5 rounded-full border border-green-200 transition">My PC won't boot</button>
                        <button onclick="sendQuickQuestion('Should I upgrade my GPU?')" class="text-xs bg-green-50 hover:bg-green-100 text-green-700 px-3 py-1.5 rounded-full border border-green-200 transition">Should I upgrade my GPU?</button>
                        <button onclick="sendQuickQuestion('Best motherboard for Ryzen 7?')" class="text-xs bg-green-50 hover:bg-green-100 text-green-700 px-3 py-1.5 rounded-full border border-green-200 transition">Best motherboard for Ryzen 7?</button>
                        <button onclick="sendQuickQuestion('How to fix overheating?')" class="text-xs bg-green-50 hover:bg-green-100 text-green-700 px-3 py-1.5 rounded-full border border-green-200 transition">How to fix overheating?</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="p-3 border-t border-slate-100 bg-white rounded-b-xl">
            <div class="flex gap-2">
                <input type="text" id="expert-chat-input" placeholder="Ask an expert..." class="flex-1 bg-slate-100 border-0 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 text-sm" onkeypress="handleExpertChat(event)">
                <button onclick="sendExpertMessage()" class="bg-green-600 text-white w-10 h-10 rounded-lg hover:bg-green-700 transition"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- Floating Buttons -->
    <button onclick="toggleAI()" class="fixed bottom-6 right-6 w-14 h-14 bg-gradient-to-r from-purple-600 to-blue-600 rounded-full text-white shadow-lg hover:shadow-xl hover:scale-105 transition flex items-center justify-center text-2xl z-30">
        <i class="fa-solid fa-robot"></i>
    </button>

    <script>
        // --- SECURITY UTILITIES ---
        const Security = {
            sanitizeHTML(str) {
                if (typeof str !== 'string') return str;
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            },
            
            sanitizeNumber(value, min = 0, max = Infinity) {
                const num = parseFloat(value);
                if (isNaN(num)) return min;
                return Math.max(min, Math.min(max, num));
            },
            
            validateBudget(budget) {
                return this.sanitizeNumber(budget, 15000, 500000);
            },
            
            sanitizeObject(obj) {
                if (typeof obj !== 'object' || obj === null) return {};
                const sanitized = {};
                for (let key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        if (typeof obj[key] === 'string') {
                            sanitized[key] = this.sanitizeHTML(obj[key]);
                        } else if (typeof obj[key] === 'number') {
                            sanitized[key] = this.sanitizeNumber(obj[key]);
                        } else {
                            sanitized[key] = obj[key];
                        }
                    }
                }
                return sanitized;
            },
            
            rateLimit: {
                lastRequest: 0,
                minDelay: 1000,
                
                check() {
                    const now = Date.now();
                    if (now - this.lastRequest < this.minDelay) {
                        return false;
                    }
                    this.lastRequest = now;
                    return true;
                }
            }
        };

        // --- 1. DATABASE LOADER ---
        let db = null;
        let dbLoaded = false;

        async function loadDb() {
            if (dbLoaded && db) return db;
            
            try {
                const response = await fetch('data/components.json', {
                    headers: { 'Cache-Control': 'no-cache' }
                });
                if (!response.ok) throw new Error('Failed to load components database');
                
                const data = await response.json();
                
                // Validate database structure
                const requiredKeys = ['laptops', 'cpus', 'gpus', 'mobos', 'ram', 'storage', 'psu', 'case'];
                const isValid = requiredKeys.every(key => Array.isArray(data[key]));
                
                if (!isValid) {
                    throw new Error('Invalid database structure');
                }
                
                // Sanitize all data
                db = {};
                for (let key of requiredKeys) {
                    db[key] = data[key].map(item => Security.sanitizeObject(item));
                }
                
                dbLoaded = true;
                return db;
            } catch (error) {
                console.error('Database load error:', error);
                alert('Failed to load component database. Please refresh the page.');
                throw error;
            }
        }

        // --- 2. METRICS ---
        const PERFORMANCE_METRICS = {
            gaming: {
                label: "Estimated Gaming Performance",
                icon: '<i class="fa-solid fa-gamepad text-purple-600"></i>',
                metrics: {
                    integrated: [
                        { name: "GTA V", value: "30-40 FPS (720p)", color: "text-green-600" },
                        { name: "Valorant", value: "60+ FPS (Low)", color: "text-blue-600" },
                        { name: "Cyberpunk", value: "Unplayable", color: "text-red-600" },
                        { name: "Live Streaming", value: "Not Supported", color: "text-red-600" }
                    ],
                    entry: [
                        { name: "GTA V", value: "60+ FPS (1080p)", color: "text-green-600" },
                        { name: "Valorant", value: "144+ FPS (High)", color: "text-blue-600" },
                        { name: "Cyberpunk", value: "30-45 FPS (Low)", color: "text-orange-600" },
                        { name: "Live Streaming", value: "720p 30FPS (Basic)", color: "text-orange-600" }
                    ],
                    mid: [
                        { name: "GTA V", value: "100+ FPS (Ultra)", color: "text-green-600" },
                        { name: "Valorant", value: "240+ FPS (High)", color: "text-blue-600" },
                        { name: "Cyberpunk", value: "60+ FPS (High)", color: "text-green-600" },
                        { name: "Live Streaming", value: "1080p 60FPS (Smooth)", color: "text-green-600" }
                    ],
                    high: [
                        { name: "GTA V", value: "140+ FPS (1440p)", color: "text-green-600" },
                        { name: "Valorant", value: "300+ FPS (High)", color: "text-blue-600" },
                        { name: "Cyberpunk", value: "80+ FPS (1440p)", color: "text-green-600" },
                        { name: "Live Streaming", value: "1080p/1440p (Pro)", color: "text-blue-600" }
                    ],
                    ultra: [
                        { name: "GTA V", value: "165+ FPS (4K)", color: "text-green-600" },
                        { name: "Valorant", value: "500+ FPS (High)", color: "text-blue-600" },
                        { name: "Cyberpunk", value: "100+ FPS (4K)", color: "text-green-600" },
                        { name: "Live Streaming", value: "4K / Multi-Stream", color: "text-purple-600" }
                    ]
                }
            },
            productivity: {
                label: "Workstation Software Capability",
                icon: '<i class="fa-solid fa-pen-ruler text-blue-600"></i>',
                metrics: {
                    integrated: [
                        { name: "Video Editing", value: "1080p Basic", color: "text-orange-600" },
                        { name: "Graphic Design", value: "Canva/Basic", color: "text-blue-600" },
                        { name: "3D Rendering", value: "Not Recommended", color: "text-red-600" },
                        { name: "Multitasking", value: "Basic", color: "text-orange-600" }
                    ],
                    entry: [
                        { name: "Video Editing", value: "1080p Smooth", color: "text-green-600" },
                        { name: "Graphic Design", value: "Photoshop (Fast)", color: "text-blue-600" },
                        { name: "3D Rendering", value: "Blender (Basic)", color: "text-orange-600" },
                        { name: "Multitasking", value: "Standard", color: "text-blue-600" }
                    ],
                    mid: [
                        { name: "Video Editing", value: "4K Editing", color: "text-green-600" },
                        { name: "Graphic Design", value: "Complex Vector", color: "text-blue-600" },
                        { name: "3D Rendering", value: "Blender Cycles", color: "text-green-600" },
                        { name: "Multitasking", value: "Heavy", color: "text-green-600" }
                    ],
                    high: [
                        { name: "Video Editing", value: "6K/RAW Editing", color: "text-green-600" },
                        { name: "Graphic Design", value: "Professional", color: "text-blue-600" },
                        { name: "3D Rendering", value: "Fast Rendering", color: "text-green-600" },
                        { name: "Multitasking", value: "Extreme", color: "text-purple-600" }
                    ],
                    ultra: [
                        { name: "Video Editing", value: "8K Cinema", color: "text-green-600" },
                        { name: "Graphic Design", value: "Industry Std", color: "text-blue-600" },
                        { name: "3D Rendering", value: "Studio Grade", color: "text-green-600" },
                        { name: "Multitasking", value: "Limitless", color: "text-purple-600" }
                    ]
                }
            },
            coding: {
                label: "Development Environment",
                icon: '<i class="fa-solid fa-code text-green-600"></i>',
                metrics: {
                    integrated: [
                        { name: "Web Dev", value: "HTML/JS (Fast)", color: "text-green-600" },
                        { name: "Virtualization", value: "Not Recommended", color: "text-red-600" },
                        { name: "IDE Speed", value: "VS Code (Good)", color: "text-blue-600" },
                        { name: "Local Server", value: "Simple", color: "text-orange-600" }
                    ],
                    entry: [
                        { name: "Web Dev", value: "Full Stack", color: "text-green-600" },
                        { name: "Virtualization", value: "1 Light VM", color: "text-orange-600" },
                        { name: "IDE Speed", value: "Standard", color: "text-blue-600" },
                        { name: "Local Server", value: "Standard", color: "text-blue-600" }
                    ],
                    mid: [
                        { name: "Web Dev", value: "Heavy Backend", color: "text-green-600" },
                        { name: "Virtualization", value: "Docker / 2 VMs", color: "text-green-600" },
                        { name: "Mobile Dev", value: "Android Studio", color: "text-blue-600" },
                        { name: "Local Server", value: "Docker Containers", color: "text-green-600" }
                    ],
                    high: [
                        { name: "Web Dev", value: "Enterprise", color: "text-green-600" },
                        { name: "Virtualization", value: "Multiple VMs", color: "text-green-600" },
                        { name: "Compilation", value: "Fast Compile", color: "text-blue-600" },
                        { name: "Local Server", value: "K8s Cluster", color: "text-purple-600" }
                    ],
                    ultra: [
                        { name: "Web Dev", value: "Server Load", color: "text-green-600" },
                        { name: "Virtualization", value: "Data Center Sim", color: "text-green-600" },
                        { name: "Compilation", value: "Instant", color: "text-blue-600" },
                        { name: "Local Server", value: "Data Center", color: "text-purple-600" }
                    ]
                }
            }
        };

        // --- 3. STATE & UI LOGIC ---
        let state = { formFactor: 'desktop', usage: 'gaming', budget: 50000, prefs: { cpu: 'Any', gpu: 'Any' }, currentBuild: null };

        function goHome() {
            document.getElementById('view-landing').classList.remove('hidden');
            document.getElementById('view-wizard').classList.add('hidden');
            document.getElementById('view-results').classList.add('hidden');
        }

        // Shopping Modal Functions
        function openShopModal(shopLinks, productName) {
            const modal = document.getElementById('shop-modal');
            const productNameEl = document.getElementById('shop-product-name');
            const linksContainer = document.getElementById('shop-links-container');
            
            productNameEl.textContent = productName;
            
            const stores = [
                { name: 'Amazon India', key: 'amazon', color: '#FF9900', icon: 'üõí' },
                { name: 'Flipkart', key: 'flipkart', color: '#2874F0', icon: 'üõçÔ∏è' },
                { name: 'Reliance Digital', key: 'reliance', color: '#E42529', icon: 'üè¨' },
                { name: 'Croma', key: 'croma', color: '#8CC63F', icon: 'üè™' },
                { name: 'Vijay Sales', key: 'vijay', color: '#FF6B00', icon: 'üõí' },
                { name: 'MD Computers', key: 'mdcomputers', color: '#0066CC', icon: 'üíª' }
            ];
            
            let html = '';
            stores.forEach(store => {
                if (shopLinks && shopLinks[store.key]) {
                    html += `
                        <a href="${shopLinks[store.key]}" target="_blank" rel="noopener noreferrer" class="store-btn">
                            <div class="store-logo" style="background: ${store.color}; color: white;">
                                ${store.icon}
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-slate-800">${store.name}</div>
                                <div class="text-xs text-slate-500">Compare prices & deals</div>
                            </div>
                            <i class="fa-solid fa-arrow-right text-slate-400"></i>
                        </a>
                    `;
                }
            });
            
            linksContainer.innerHTML = html;
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        function closeShopModal(event) {
            if (!event || event.target.id === 'shop-modal') {
                const modal = document.getElementById('shop-modal');
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        function startWizard() {
            document.getElementById('view-landing').classList.add('hidden');
            document.getElementById('view-results').classList.add('hidden');
            document.getElementById('view-wizard').classList.remove('hidden');
            navWizard(1);
        }

        function navWizard(step) {
            document.querySelectorAll('.wizard-step').forEach(el => el.classList.add('hidden'));
            document.getElementById(`step-${step}`).classList.remove('hidden');
            document.getElementById('wiz-step-num').innerText = step;
            document.getElementById('wiz-progress').style.width = (step / 4 * 100) + '%';
        }

        function setFormFactor(ff) {
            state.formFactor = ff;
            document.getElementById('budget-type-text').innerText = ff === 'laptop' ? 'Laptop' : 'PC';
            navWizard(2);
        }

        function setUsage(u) {
            state.usage = u;
            navWizard(3);
        }

        function updateBudget(val) {
            const sanitized = Security.validateBudget(val);
            state.budget = parseInt(sanitized);
            document.getElementById('budget-val').innerText = state.budget.toLocaleString('en-IN');
        }

        function setPref(type, val) {
            // Validate inputs
            const validTypes = ['cpu', 'gpu'];
            const validValues = ['Intel', 'AMD', 'NVIDIA', 'Any'];
            
            if (!validTypes.includes(type) || !validValues.includes(val)) {
                console.error('Invalid preference');
                return;
            }
            
            state.prefs[type] = val;
            document.querySelectorAll(`#step-4 button[id^='btn-${type}']`).forEach(b => {
                b.classList.remove('bg-blue-50', 'border-blue-500', 'text-blue-700', 'font-bold');
                b.classList.add('border-gray-200');
            });
            const btn = document.getElementById(`btn-${type.toLowerCase()}-${val.toLowerCase()}`);
            if (btn) {
                btn.classList.add('bg-blue-50', 'border-blue-500', 'text-blue-700', 'font-bold');
                btn.classList.remove('border-gray-200');
            }
        }

        // --- 4. GENERATE BUILD ---
        async function generateBuild() {
            // Rate limiting
            if (!Security.rateLimit.check()) {
                alert('Please wait a moment before generating another build.');
                return;
            }
            
            await loadDb();
            
            if (!db) {
                alert('Database not loaded. Please try again.');
                return;
            }
            
            const { budget, prefs, usage, formFactor } = state;
            
            // Comprehensive input validation
            const validationErrors = [];
            
            if (!formFactor || !['laptop', 'desktop'].includes(formFactor)) {
                validationErrors.push('Invalid form factor selected');
            }
            
            const validUsages = ['gaming', 'productivity', 'coding', 'content'];
            if (!usage || !validUsages.includes(usage)) {
                validationErrors.push('Invalid usage type selected');
            }
            
            if (!budget || isNaN(budget)) {
                validationErrors.push('Invalid budget amount');
            } else if (budget < 15000) {
                validationErrors.push('Minimum budget is ‚Çπ15,000');
            } else if (budget > 10000000) {
                validationErrors.push('Maximum budget is ‚Çπ1,00,00,000');
            }
            
            if (validationErrors.length > 0) {
                alert('‚ö†Ô∏è Validation Error:\n\n' + validationErrors.join('\n'));
                return;
            }
            
            if (formFactor === 'laptop') {
                // Filter laptops within budget range (allow 5% over for better options)
                let potentialLaptops = db.laptops.filter(l => l.price <= budget * 1.05);
                if (potentialLaptops.length === 0) {
                    // If no laptops in budget, show closest options
                    potentialLaptops = db.laptops.filter(l => l.price <= budget * 1.2).slice(0, 3);
                    if (potentialLaptops.length === 0) potentialLaptops = db.laptops.slice(0, 3);
                }

                // Score laptops based on usage and specs
                let scoredLaptops = potentialLaptops.map(laptop => {
                    let score = 0;
                    
                    // Usage-based scoring
                    if (usage === 'gaming') {
                        if (laptop.type === 'gaming') score += 50;
                        if (laptop.gpuTier === 'high' || laptop.gpuTier === 'ultra') score += 30;
                        else if (laptop.gpuTier === 'mid') score += 20;
                        else if (laptop.gpuTier === 'entry') score += 10;
                        if (laptop.refresh && parseInt(laptop.refresh) >= 144) score += 15;
                    } else if (usage === 'productivity') {
                        if (laptop.type === 'office' || laptop.type === 'creative') score += 50;
                        if (laptop.ram && laptop.ram.includes('16GB')) score += 20;
                        if (laptop.ram && laptop.ram.includes('32GB')) score += 30;
                        if (laptop.storage && laptop.storage.includes('1TB')) score += 10;
                    } else if (usage === 'coding') {
                        if (laptop.type === 'office' || laptop.type === 'creative') score += 40;
                        if (laptop.ram && (laptop.ram.includes('16GB') || laptop.ram.includes('32GB'))) score += 25;
                        if (laptop.storage && laptop.storage.includes('SSD')) score += 15;
                        if (laptop.battery && parseInt(laptop.battery) >= 8) score += 10;
                    } else if (usage === 'content') {
                        if (laptop.type === 'creative') score += 50;
                        if (laptop.screen && laptop.screen.includes('OLED')) score += 20;
                        if (laptop.ram && laptop.ram.includes('32GB')) score += 15;
                    }
                    
                    // Budget efficiency scoring
                    const budgetUtilization = laptop.price / budget;
                    if (budgetUtilization >= 0.85 && budgetUtilization <= 1.0) score += 25;
                    else if (budgetUtilization >= 0.70 && budgetUtilization < 0.85) score += 15;
                    else if (budgetUtilization >= 0.50 && budgetUtilization < 0.70) score += 10;
                    
                    // Brand preference
                    if (prefs.gpu !== 'Any') {
                        if (laptop.brand === prefs.gpu) score += 10;
                    }
                    
                    return { ...laptop, aiScore: score };
                });

                // Sort by AI score, then by price
                scoredLaptops.sort((a, b) => {
                    if (Math.abs(a.aiScore - b.aiScore) > 10) return b.aiScore - a.aiScore;
                    return b.price - a.price;
                });
                
                let topPicks = scoredLaptops.slice(0, 3);

                state.currentBuild = { type: 'laptop', data: topPicks };
                const best = topPicks[0];
                
                // Generate intelligent reasoning
                let reasoning = `Based on your ${usage} requirements with a ‚Çπ${budget.toLocaleString('en-IN')} budget, `;
                reasoning += `our AI analyzed ${potentialLaptops.length} laptops and scored them on performance, value, and compatibility. `;
                reasoning += `The ${best.name} (Score: ${best.aiScore}/100) is our top recommendation because it offers `;
                if (usage === 'gaming') reasoning += `excellent gaming performance with ${best.spec}.`;
                else if (usage === 'productivity') reasoning += `outstanding productivity features and battery life for work.`;
                else if (usage === 'coding') reasoning += `perfect development specs with great RAM and storage.`;
                else reasoning += `the best overall value for your use case.`;
                
                document.getElementById('build-reasoning').innerText = reasoning;
                renderResults();
                return;
            }

            // DESKTOP LOGIC
            let cpu, gpu, mobo, ram, storage, psu, userCase;
            let buildReason = "";

            if (budget <= 20000) {
                cpu = db.cpus.find(c => c.name.includes('Athlon')) || db.cpus[0];
                gpu = db.gpus.find(g => g.price === 0); 
                mobo = db.mobos.find(m => m.socket === 'AM4' && m.price < 4000) || db.mobos[0];
                ram = db.ram.find(r => r.price < 1500) || db.ram[0]; 
                storage = db.storage[0]; 
                psu = db.psu[0];
                userCase = db.case[0];
                buildReason = "For this ultra-budget entry point, we used an AMD Athlon APU. It handles web browsing, movies, and office work perfectly for a very low cost.";
            }
            else if (budget < 45000) {
                cpu = db.cpus.find(c => c.name.includes('5600G')) || db.cpus[0];
                gpu = db.gpus.find(g => g.price === 0); 
                mobo = db.mobos.filter(m => m.socket === cpu.socket).sort((a,b) => a.price - b.price)[0];
                ram = db.ram.find(r => r.name.includes('8GB')) || db.ram[1]; 
                storage = db.storage[0];
                psu = db.psu[0];
                userCase = db.case[0];
                buildReason = "Given the tight budget, we selected a Processor with high-performance Integrated Graphics (APU). This allows you to game and work without buying an expensive graphics card right now.";
            } 
            else {
                // STANDARD LOGIC
                let gpuBudget = usage === 'gaming' ? budget * 0.45 : budget * 0.25;
                let cpuBudget = usage === 'productivity' ? budget * 0.30 : budget * 0.20;

                if (budget > 200000) {
                    gpuBudget = budget * 0.50;
                    cpuBudget = budget * 0.20;
                }
                if (budget > 400000) gpuBudget = 200000;

                // Smart CPU selection with workload optimization
                let cpuList = db.cpus.filter(c => {
                    const inBudget = c.price <= cpuBudget * 1.5 && c.price >= cpuBudget * 0.4;
                    const notApu = !c.integrated && !c.name.includes('Athlon');
                    return inBudget && notApu;
                });
                
                if(cpuList.length === 0) {
                    cpuList = db.cpus.filter(c => !c.integrated && !c.name.includes('Athlon'));
                }
                
                // Apply brand preference
                if(prefs.cpu !== 'Any') {
                    let filtered = cpuList.filter(c => c.brand === prefs.cpu);
                    if(filtered.length > 0) cpuList = filtered;
                }
                
                // Score CPUs based on usage
                let scoredCPUs = cpuList.map(c => {
                    let score = 0;
                    const cores = parseInt(c.cores || 0);
                    const price = c.price;
                    
                    // Core count scoring for different workloads
                    if (usage === 'content' || usage === 'productivity') {
                        if (cores >= 16) score += 35;
                        else if (cores >= 12) score += 30;
                        else if (cores >= 8) score += 20;
                        else if (cores >= 6) score += 10;
                    } else if (usage === 'gaming') {
                        if (cores >= 8) score += 30;
                        else if (cores >= 6) score += 25;
                        else if (cores >= 4) score += 15;
                    } else if (usage === 'coding') {
                        if (cores >= 12) score += 30;
                        else if (cores >= 8) score += 25;
                        else if (cores >= 6) score += 15;
                    }
                    
                    // Budget utilization score
                    const budgetRatio = price / cpuBudget;
                    if (budgetRatio >= 0.85 && budgetRatio <= 1.2) score += 25;
                    else if (budgetRatio >= 0.7 && budgetRatio < 0.85) score += 15;
                    else if (budgetRatio >= 0.5 && budgetRatio < 0.7) score += 10;
                    
                    return { ...c, cpuScore: score };
                });
                
                cpu = scoredCPUs.sort((a,b) => {
                    if (Math.abs(a.cpuScore - b.cpuScore) > 5) return b.cpuScore - a.cpuScore;
                    return b.price - a.price;
                })[0] || db.cpus[2];

                let gpuList = db.gpus.filter(g => {
                    const inBudget = g.price <= gpuBudget * 1.3 && g.price >= gpuBudget * 0.5 && g.price > 0;
                    return inBudget;
                });
                
                if(gpuList.length === 0) {
                    gpuList = db.gpus.filter(g => g.price > 0 && g.price <= gpuBudget * 1.5);
                }
                if(gpuList.length === 0) gpuList = db.gpus.filter(g => g.price > 0);
                
                // Apply brand preference
                if(prefs.gpu !== 'Any') {
                    let filtered = gpuList.filter(g => g.brand === prefs.gpu);
                    if(filtered.length > 0) gpuList = filtered;
                }
                
                // Score GPUs for optimal selection
                let scoredGPUs = gpuList.map(g => {
                    let score = 0;
                    const vram = parseInt(g.vram?.match(/\d+/)?.[0] || 0);
                    const price = g.price;
                    
                    // VRAM scoring based on usage
                    if (usage === 'gaming') {
                        if (vram >= 16) score += 35;
                        else if (vram >= 12) score += 30;
                        else if (vram >= 8) score += 20;
                        else if (vram >= 6) score += 15;
                        else if (vram >= 4) score += 10;
                    } else if (usage === 'content') {
                        if (vram >= 24) score += 40;
                        else if (vram >= 16) score += 35;
                        else if (vram >= 12) score += 25;
                        else if (vram >= 8) score += 15;
                    } else {
                        if (vram >= 8) score += 25;
                        else if (vram >= 6) score += 20;
                        else if (vram >= 4) score += 15;
                    }
                    
                    // Budget efficiency
                    const budgetRatio = price / gpuBudget;
                    if (budgetRatio >= 0.85 && budgetRatio <= 1.15) score += 30;
                    else if (budgetRatio >= 0.7 && budgetRatio < 0.85) score += 20;
                    else if (budgetRatio >= 0.5 && budgetRatio < 0.7) score += 10;
                    
                    return { ...g, gpuScore: score };
                });
                
                gpu = scoredGPUs.sort((a,b) => {
                    if (Math.abs(a.gpuScore - b.gpuScore) > 5) return b.gpuScore - a.gpuScore;
                    return b.price - a.price;
                })[0] || db.gpus[1];

                let validMobos = db.mobos.filter(m => m.socket === cpu.socket);
                validMobos.sort((a,b) => a.price - b.price); // Sort by price ascending
                
                if (budget > 300000) {
                    // High-end: pick top-tier boards
                    let highEnd = validMobos.filter(m => m.price > 25000);
                    mobo = highEnd[Math.floor(highEnd.length * 0.7)] || validMobos[validMobos.length - 1];
                } else if (budget > 150000) {
                    // Mid-range: 15k-30k boards
                    let midRange = validMobos.filter(m => m.price >= 15000 && m.price <= 30000);
                    mobo = midRange[Math.floor(midRange.length / 2)] || validMobos[Math.floor(validMobos.length / 2)];
                } else if (budget > 80000) {
                    // Budget: 8k-18k boards
                    let budgetRange = validMobos.filter(m => m.price >= 8000 && m.price <= 18000);
                    mobo = budgetRange[Math.floor(budgetRange.length / 3)] || validMobos[Math.floor(validMobos.length / 3)];
                } else {
                    // Very low budget: cheapest compatible boards
                    let lowBudget = validMobos.filter(m => m.price < 10000);
                    mobo = lowBudget[Math.floor(lowBudget.length / 2)] || validMobos[0];
                }

                // Smart RAM selection based on motherboard and usage
                let validRam = db.ram.filter(r => {
                    // Check DDR generation compatibility
                    if (mobo.name.includes('DDR5')) return r.name.includes('DDR5');
                    if (mobo.name.includes('DDR4')) return r.name.includes('DDR4');
                    return true;
                });
                if (validRam.length === 0) validRam = db.ram;
                
                // Determine optimal RAM based on usage
                let targetRamSize = '16GB';
                if (usage === 'content' || usage === 'productivity') {
                    if (budget > 250000) targetRamSize = '64GB';
                    else if (budget > 120000) targetRamSize = '32GB';
                    else targetRamSize = '16GB';
                } else if (usage === 'gaming') {
                    if (budget > 200000) targetRamSize = '32GB';
                    else targetRamSize = '16GB';
                } else {
                    if (budget > 300000) targetRamSize = '32GB';
                    else targetRamSize = '16GB';
                }
                
                // Find RAM matching target size with good speed
                let targetRam = validRam.filter(r => r.name.includes(targetRamSize));
                if (targetRam.length > 0) {
                    // Prefer higher speed RAM for gaming
                    if (usage === 'gaming') {
                        ram = targetRam.sort((a, b) => {
                            const speedA = parseInt(a.name.match(/\d{4,5}MHz/)?.[0] || 3200);
                            const speedB = parseInt(b.name.match(/\d{4,5}MHz/)?.[0] || 3200);
                            return speedB - speedA;
                        })[0];
                    } else {
                        // For other uses, balance speed and price
                        ram = targetRam.sort((a, b) => a.price - b.price)[Math.floor(targetRam.length / 2)];
                    }
                } else {
                    ram = validRam.sort((a, b) => b.price - a.price)[0];
                }
                if (ram.price < 1500) ram = validRam[1] || validRam[0];

                // Intelligent storage selection
                let targetCapacity = '500GB';
                let needSpeed = usage === 'gaming' || usage === 'content' || usage === 'coding';
                
                if (budget > 300000) targetCapacity = '2TB';
                else if (budget > 150000) targetCapacity = '1TB';
                else if (budget > 80000) targetCapacity = '500GB';
                else targetCapacity = '256GB';
                
                // Prioritize NVMe Gen4 for high-end, Gen3 for mid-range
                let storageOptions = db.storage.filter(s => {
                    const hasTargetCapacity = s.name.includes(targetCapacity);
                    if (needSpeed) {
                        if (budget > 200000) return hasTargetCapacity && s.name.includes('Gen4');
                        else if (budget > 80000) return hasTargetCapacity && s.name.includes('NVMe');
                        else return hasTargetCapacity && s.name.includes('SSD');
                    }
                    return hasTargetCapacity;
                });
                
                if (storageOptions.length === 0) {
                    storageOptions = db.storage.filter(s => s.name.includes(targetCapacity));
                }
                
                if (storageOptions.length > 0) {
                    // Choose mid-range option for best value
                    storage = storageOptions.sort((a, b) => a.price - b.price)[Math.floor(storageOptions.length / 2)] || storageOptions[0];
                } else {
                    storage = db.storage[2];
                }

                // Intelligent PSU selection based on component power draw
                let estimatedWattage = 100; // Base system
                
                // Add CPU TDP
                if (cpu.tdp) {
                    const cpuWatts = parseInt(cpu.tdp.match(/\d+/)?.[0] || 65);
                    estimatedWattage += cpuWatts;
                }
                
                // Add GPU TDP
                if (gpu.tdp) {
                    const gpuWatts = parseInt(gpu.tdp.match(/\d+/)?.[0] || 150);
                    estimatedWattage += gpuWatts;
                } else if (gpu.price > 80000) {
                    estimatedWattage += 400; // High-end GPU estimate
                } else if (gpu.price > 40000) {
                    estimatedWattage += 250;
                } else if (gpu.price > 20000) {
                    estimatedWattage += 150;
                }
                
                // Add 20% headroom for efficiency and future upgrades
                const recommendedWattage = Math.ceil(estimatedWattage * 1.2);
                
                // Select PSU with appropriate wattage
                let validPSUs = db.psu.filter(p => {
                    const psuWattage = parseInt(p.name.match(/\d+W/)?.[0] || 500);
                    return psuWattage >= recommendedWattage;
                });
                
                if (validPSUs.length === 0) validPSUs = db.psu;
                
                // Choose PSU based on budget and efficiency
                if (budget > 300000) {
                    psu = validPSUs.filter(p => p.name.includes('Platinum') || p.name.includes('Titanium')).sort((a,b) => b.price - a.price)[0] || validPSUs[Math.floor(validPSUs.length * 0.7)];
                } else if (budget > 150000) {
                    psu = validPSUs.filter(p => p.name.includes('Gold')).sort((a,b) => a.price - b.price)[Math.floor(validPSUs.filter(p => p.name.includes('Gold')).length / 2)] || validPSUs[Math.floor(validPSUs.length / 2)];
                } else {
                    psu = validPSUs.sort((a,b) => a.price - b.price)[Math.floor(validPSUs.length / 3)] || validPSUs[0];
                }

                if (budget > 350000) userCase = db.case[7];
                else if (budget > 200000) userCase = db.case[6];
                else if (budget > 100000) userCase = db.case[4];
                else userCase = db.case[2];

                // --- CRITICAL BUDGET CHECK & DOWNGRADE LOGIC ---
                let totalCost = cpu.price + gpu.price + mobo.price + ram.price + storage.price + psu.price + userCase.price;
                
                // If Over Budget, Downgrade GPU first (most expensive part usually)
                while (totalCost > budget) {
                    // Try downgrading GPU
                    let currentGpuIndex = db.gpus.findIndex(g => g.id === gpu.id);
                    if (currentGpuIndex > 1) { // Don't go below entry discrete
                        let nextGpu = db.gpus[currentGpuIndex - 1];
                        if (nextGpu.price < gpu.price) {
                            gpu = nextGpu;
                            totalCost = cpu.price + gpu.price + mobo.price + ram.price + storage.price + psu.price + userCase.price;
                            continue;
                        }
                    }
                    
                    // If GPU can't go lower or still over budget, try CPU
                    let currentCpuIndex = db.cpus.findIndex(c => c.id === cpu.id);
                    if (currentCpuIndex > 2) {
                         let nextCpu = db.cpus[currentCpuIndex - 1];
                         // Ensure socket compatibility matches mobo or re-pick mobo
                         if (nextCpu.socket === mobo.socket && nextCpu.price < cpu.price) {
                             cpu = nextCpu;
                             totalCost = cpu.price + gpu.price + mobo.price + ram.price + storage.price + psu.price + userCase.price;
                             continue;
                         }
                    }

                    // Last Resort: Downgrade RAM/Storage/Case to basic
                    if (ram.price > 2000) ram = validRam[0];
                    if (storage.price > 3000) storage = db.storage[0];
                    if (userCase.price > 2000) userCase = db.case[0];
                    
                    // Re-calc and break to avoid infinite loop if impossible
                    totalCost = cpu.price + gpu.price + mobo.price + ram.price + storage.price + psu.price + userCase.price;
                    break; 
                }

                // Generate intelligent build reasoning with validation
                let warnings = [];
                let highlights = [];
                
                // CPU-GPU balance check
                if (usage === 'gaming') {
                    const cpuGpuRatio = cpu.price / gpu.price;
                    if (cpuGpuRatio > 1.8) warnings.push('CPU is significantly more expensive than GPU - may not be optimal for gaming');
                    if (cpuGpuRatio < 0.25) warnings.push('GPU may experience bottleneck with this CPU at high resolutions');
                }
                
                // Power supply validation
                const psuWattage = parseInt(psu.name.match(/\d+W/)?.[0] || 500);
                const cpuTdp = parseInt(cpu.tdp?.match(/\d+/)?.[0] || 65);
                const gpuTdp = parseInt(gpu.tdp?.match(/\d+/)?.[0] || 150);
                const totalTdp = cpuTdp + gpuTdp + 100;
                if (psuWattage < totalTdp * 1.1) warnings.push('PSU may be close to limit under full load');
                
                // Highlight key features
                if (gpu.vram && parseInt(gpu.vram) >= 12) highlights.push(`${gpu.vram} VRAM for excellent gaming at high resolutions`);
                if (cpu.cores && parseInt(cpu.cores) >= 12) highlights.push(`${cpu.cores} cores for exceptional multitasking`);
                if (ram.name.includes('32GB') || ram.name.includes('64GB')) highlights.push(`${ram.name.match(/\d+GB/)?.[0]} RAM for professional workloads`);
                if (storage.name.includes('Gen4')) highlights.push('PCIe Gen4 NVMe for blazing fast storage');
                
                // Build comprehensive reasoning
                buildReason = `üéØ ${usage.charAt(0).toUpperCase() + usage.slice(1)} Build Complete!\n\n`;
                buildReason += `üíª Core Components:\n`;
                buildReason += `‚Ä¢ CPU: ${cpu.name} (${cpu.cores || 'Multi'}-core${cpu.threads ? ', ' + cpu.threads + ' threads' : ''})\n`;
                buildReason += `‚Ä¢ GPU: ${gpu.name} (${gpu.vram || 'Dedicated graphics'})\n`;
                buildReason += `‚Ä¢ Motherboard: ${mobo.socket} socket with ${mobo.name.includes('DDR5') ? 'DDR5' : 'DDR4'} support\n\n`;
                
                if (usage === 'gaming') {
                    buildReason += `üéÆ Gaming Performance:\n`;
                    if (gpu.vram) {
                        const vram = parseInt(gpu.vram);
                        if (vram >= 16) buildReason += `‚Ä¢ Excellent 4K gaming with ray tracing\n`;
                        else if (vram >= 12) buildReason += `‚Ä¢ Smooth 1440p-4K gaming experience\n`;
                        else if (vram >= 8) buildReason += `‚Ä¢ Great 1080p-1440p gaming\n`;
                        else buildReason += `‚Ä¢ Solid 1080p gaming performance\n`;
                    }
                } else if (usage === 'content') {
                    buildReason += `üé® Content Creation:\n`;
                    buildReason += `‚Ä¢ GPU-accelerated rendering and editing\n`;
                    buildReason += `‚Ä¢ Multi-core CPU for fast exports\n`;
                } else if (usage === 'coding') {
                    buildReason += `üë®‚Äçüíª Development:\n`;
                    buildReason += `‚Ä¢ Fast compilation with ${cpu.cores}+ cores\n`;
                    buildReason += `‚Ä¢ Plenty of RAM for VMs and containers\n`;
                }
                
                if (highlights.length > 0) {
                    buildReason += `\n‚ú® Key Features:\n`;
                    highlights.forEach(h => buildReason += `‚Ä¢ ${h}\n`);
                }
                
                buildReason += `\n‚ö° Power: ${psu.name} (${psuWattage}W) provides ${Math.round((psuWattage/totalTdp - 1) * 100)}% power headroom\n`;
                buildReason += `üíæ Storage: ${storage.name} for fast boot and load times\n`;
                buildReason += `\nüí∞ Total: ‚Çπ${totalCost.toLocaleString('en-IN')} (${((totalCost/budget)*100).toFixed(1)}% of budget)`;
                
                if (warnings.length > 0) {
                    buildReason += `\n\n‚ö†Ô∏è Notes:\n`;
                    warnings.forEach(w => buildReason += `‚Ä¢ ${w}\n`);
                }
            }

            state.currentBuild = { type: 'desktop', data: { cpu, gpu, mobo, ram, storage, psu, userCase } };
            document.getElementById('build-reasoning').innerText = buildReason;
            renderResults();
        }

        // --- 5. RENDER FUNCTIONS ---
        function renderResults() {
            const container = document.getElementById('parts-container');
            const res = state.currentBuild;

            document.getElementById('view-wizard').classList.add('hidden');
            document.getElementById('view-results').classList.remove('hidden');
            document.getElementById('res-usage').innerText = state.usage;
            document.getElementById('res-budget').innerHTML = '<span style="font-size: 0.9em; opacity: 0.9;">‚Çπ</span>' + state.budget.toLocaleString('en-IN');

            renderBenchmarks(res);

            if (res.type === 'laptop') {
                const laptops = res.data;
                document.getElementById('total-price').innerText = "Multiple Options";
                
                let html = '<div class="grid grid-cols-1 md:grid-cols-3 gap-6 p-6">';
                laptops.forEach((laptop, index) => {
                    const borderClass = index === 0 ? 'border-blue-500 ring-2 ring-blue-500/20' : 'border-slate-200';
                    const badge = index === 0 ? '<div class="absolute top-4 right-4 bg-blue-600 text-white px-3 py-1 rounded-full text-xs font-bold">Top Pick</div>' : '';

                    html += `
                    <div class="bg-white rounded-xl border ${borderClass} shadow-sm p-6 relative flex flex-col h-full hover:shadow-md transition">
                        ${badge}
                        <div class="text-center mb-4">
                            <i class="fa-solid fa-laptop text-4xl text-slate-400 mb-4"></i>
                            <h3 class="font-bold text-slate-800 text-lg leading-tight mb-1">${laptop.name}</h3>
                            <span class="text-xs font-bold text-blue-600 uppercase tracking-wider">${laptop.type} Class</span>
                        </div>
                        <div class="flex-1 space-y-3 mb-6">
                             <div class="bg-slate-50 p-3 rounded-lg text-sm text-slate-600">
                                <span class="block text-xs font-bold text-slate-400 uppercase">Specs</span>
                                ${laptop.spec}
                             </div>
                             <div class="bg-slate-50 p-3 rounded-lg text-sm text-slate-600">
                                <span class="block text-xs font-bold text-slate-400 uppercase">Est. Price</span>
                                <span style="font-size: 0.8em; opacity: 0.8;">‚Çπ</span>${laptop.price.toLocaleString('en-IN')}
                             </div>
                        </div>
                        <button onclick='openShopModal(${JSON.stringify(laptop.shopLinks)}, "${laptop.name.replace(/'/g, "\\'")}")' class="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 rounded-lg font-bold text-sm hover:from-blue-700 hover:to-purple-700 transition shadow-md hover:shadow-lg"><i class="fa-solid fa-store text-lg"></i> Compare & Buy</button>
                    </div>`;
                });
                html += '</div>';
                container.innerHTML = html;
            } else {
                const b = res.data;
                const total = Object.values(b).reduce((acc, part) => acc + part.price, 0);
                document.getElementById('total-price').innerHTML = '<span style="font-size: 0.7em; opacity: 0.8;">‚Çπ</span>' + total.toLocaleString('en-IN');

                const parts = [
                    { type: 'CPU', icon: 'fa-microchip', data: b.cpu },
                    { type: 'GPU', icon: 'fa-display', data: b.gpu },
                    { type: 'Motherboard', icon: 'fa-chess-board', data: b.mobo },
                    { type: 'Memory', icon: 'fa-memory', data: b.ram },
                    { type: 'Storage', icon: 'fa-hard-drive', data: b.storage },
                    { type: 'Power Supply', icon: 'fa-plug', data: b.psu },
                    { type: 'Case', icon: 'fa-box', data: b.userCase },
                ];

                let html = '';
                parts.forEach(p => {
                    html += `
                    <div class="flex items-center gap-4 p-4 border-b border-slate-100 last:border-0 hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 transition-all duration-300 rounded-lg group">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-100 to-purple-100 rounded-lg flex items-center justify-center text-blue-600 text-xl group-hover:scale-110 transition-transform">
                            <i class="fa-solid ${p.icon}"></i>
                        </div>
                        <div class="flex-1">
                            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">${p.type}</div>
                            <div class="font-bold text-slate-800 text-lg">${p.data.name}</div>
                            ${p.type === 'Motherboard' ? `<div class="text-xs text-green-600 mt-1"><i class="fa-solid fa-check-circle"></i> Socket Match: ${p.data.socket}</div>` : ''}
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-lg ${p.data.price === 0 ? 'text-green-600' : 'text-slate-800'}">
                                ${p.data.price === 0 ? '<span class="flex items-center gap-1"><i class="fa-solid fa-gift"></i> Included</span>' : '<span class="text-green-600" style="font-size: 14px;">‚Çπ</span>' + p.data.price.toLocaleString('en-IN')}
                            </div>
                            ${p.data.price > 0 && p.data.shopLinks ? '<button onclick=\'openShopModal(' + JSON.stringify(p.data.shopLinks) + ', "' + p.data.name.replace(/'/g, "\\'") + '")\' class="inline-flex items-center gap-1 text-xs text-blue-600 font-bold hover:text-blue-700 mt-1 bg-blue-50 px-3 py-1 rounded-full hover:bg-blue-100 transition"><i class="fa-solid fa-store"></i> Compare & Buy</button>' : ''}
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
            }
        }

        function renderBenchmarks(res) {
            let tier = 'integrated';
            if (res.type === 'laptop') {
                tier = res.data[0].gpuTier || 'integrated';
            } else {
                tier = res.data.gpu.tier || 'integrated';
            }

            const usageType = state.usage; 
            const categoryData = PERFORMANCE_METRICS[usageType] || PERFORMANCE_METRICS.gaming;
            const metricsList = categoryData.metrics[tier] || categoryData.metrics.integrated;

            document.getElementById('perf-icon').innerHTML = categoryData.icon;
            document.getElementById('perf-title').innerHTML = categoryData.label + ' <i class="fa-solid fa-chart-line ml-2 text-sm"></i>';

            const container = document.getElementById('benchmark-cards');
            container.innerHTML = '';

            metricsList.forEach(metric => {
                container.innerHTML += `
                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm text-center">
                        <div class="font-bold text-slate-800 mb-1">${metric.name}</div>
                        <div class="text-2xl font-black ${metric.color}">${metric.value}</div>
                    </div>`;
            });
        }

        // --- 6. CHAT FUNCTIONS ---
        function toggleAI() {
            document.getElementById('ai-chat-panel').classList.toggle('translate-y-[120%]');
        }

        function toggleLiveSupport() {
            document.getElementById('live-support-panel').classList.toggle('hidden');
        }

        function handleChat(e) {
            if (e.key === 'Enter') sendMessage();
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const rawText = input.value.trim();
            if(!rawText) return;

            // Sanitize input
            const txt = Security.sanitizeHTML(rawText).toLowerCase();
            
            // Rate limiting
            if (!Security.rateLimit.check()) {
                addChatMsg('Please wait a moment before sending another message.', 'ai');
                return;
            }

            addChatMsg(rawText, 'user');
            input.value = '';

            // Show typing indicator
            const typingId = addTypingIndicator();

            setTimeout(() => {
                removeTypingIndicator(typingId);
                const response = generateIntelligentResponse(txt, rawText);
                addChatMsg(response, 'ai');
            }, 600 + Math.random() * 400); // Natural typing delay
        }

        function generateIntelligentResponse(txt, originalText) {
            // Context-aware AI response system with pattern matching
            
            // Greetings
            if (/\b(hello|hi|hey|greetings)\b/.test(txt)) {
                return "üëã Hi! I'm PCSensei AI, your computer building expert. I can help you with:\n‚Ä¢ Budget recommendations\n‚Ä¢ Component compatibility\n‚Ä¢ Performance expectations\n‚Ä¢ Upgrade suggestions\n\nWhat would you like to know?";
            }

            // Budget-related queries
            if (/budget|price|cost|afford|spend|money|expensive|cheap/i.test(txt)) {
                const budgetMatch = txt.match(/(\d+)k|\u20b9\s*(\d+)|rs\s*(\d+)/);
                if (budgetMatch) {
                    const amount = (parseInt(budgetMatch[1] || budgetMatch[2] || budgetMatch[3]) || 50) * 1000;
                    if (amount < 20000) {
                        return `üí∞ For ‚Çπ${amount.toLocaleString('en-IN')}, I recommend:\n‚Ä¢ Laptop: Entry-level Chromebook or used ThinkPad\n‚Ä¢ Desktop: AMD Athlon APU build (no discrete GPU)\n\nThis budget is best for basic tasks like browsing and office work.`;
                    } else if (amount < 50000) {
                        return `üí∞ With ‚Çπ${amount.toLocaleString('en-IN')}, you can get:\n‚Ä¢ Laptop: AMD Ryzen 5 with Vega graphics\n‚Ä¢ Desktop: AMD 5600G APU (integrated graphics)\n\n‚ú® Good for 1080p gaming at medium settings and productivity work.`;
                    } else if (amount < 100000) {
                        return `üí∞ At ‚Çπ${amount.toLocaleString('en-IN')}, excellent options:\n‚Ä¢ Laptop: Gaming laptop with RTX 4050/4060\n‚Ä¢ Desktop: Ryzen 5/i5 + RTX 4060\n\nüéÆ Ideal for 1080p-1440p gaming and content creation!`;
                    } else {
                        return `üí∞ With ‚Çπ${amount.toLocaleString('en-IN')}+, you're in enthusiast territory!\n‚Ä¢ High-end CPU: Ryzen 7/9 or i7/i9\n‚Ä¢ GPU: RTX 4070+ or RX 7800 XT+\n‚Ä¢ Fast DDR5 RAM and Gen4 NVMe\n\nüöÄ Perfect for 4K gaming, streaming, and professional work!`;
                    }
                }
                
                if (state.budget) {
                    return `üí∞ Your current budget is ‚Çπ${state.budget.toLocaleString('en-IN')}.\n\nFor optimal builds, I recommend:\nüéÆ Gaming: 40% GPU, 22% CPU\nüé® Content: 30% GPU, 25% CPU\nüíº Productivity: 20% GPU, 28% CPU\n\nWant specific component recommendations?`;
                }
                
                return "üí∞ Budget allocation tips:\n‚Ä¢ Gaming: Prioritize GPU (40% of budget)\n‚Ä¢ Content Creation: Balance CPU & GPU (25-30% each)\n‚Ä¢ Productivity: Focus on CPU & RAM (28% CPU)\n‚Ä¢ Always leave 10-15% for PSU, storage, and case\n\nWhat's your target budget?";
            }

            // Component compatibility
            if (/compatib|work.*together|match|fit|socket|support/i.test(txt)) {
                if (state.currentBuild && state.currentBuild.type === 'desktop') {
                    const build = state.currentBuild.data;
                    return `‚úÖ Compatibility Check for your build:\n\nüîå CPU-Mobo: ${build.cpu.socket} socket - ‚úì Compatible\nüíæ RAM-Mobo: DDR${build.mobo.name.includes('DDR5') ? '5' : '4'} - ‚úì Compatible\n‚ö° PSU: ${build.psu.name} - ‚úì Adequate for components\nüì¶ All components fit standard ATX cases\n\nEverything looks good! Any specific concerns?`;
                }
                return "üîç To check compatibility, I need to know:\n‚Ä¢ CPU socket type (AM4, AM5, LGA1700, etc.)\n‚Ä¢ Motherboard chipset\n‚Ä¢ RAM generation (DDR4/DDR5)\n‚Ä¢ PSU wattage vs. component TDP\n\nGenerate a build first, or tell me your components!";
            }

            // Performance queries
            if (/fps|frame.*rate|perform|benchmark|how.*fast|speed|run/i.test(txt)) {
                if (txt.includes('4k') || txt.includes('2160p')) {
                    return "üéÆ 4K Gaming Performance:\n‚Ä¢ RTX 4080+: 60-120 FPS (AAA titles)\n‚Ä¢ RTX 4070 Ti: 50-80 FPS (high settings)\n‚Ä¢ RTX 4060 Ti: 30-50 FPS (medium settings)\n\nPair with Ryzen 7/i7+ to avoid bottlenecks!\n\nBudget needed: ‚Çπ1,50,000+";
                } else if (txt.includes('1440p')) {
                    return "üéÆ 1440p Gaming Performance:\n‚Ä¢ RTX 4070: 100-144 FPS (AAA titles)\n‚Ä¢ RTX 4060 Ti: 80-120 FPS (high settings)\n‚Ä¢ RTX 4060: 60-90 FPS (medium-high)\n\nSweet spot for price-performance!\n\nBudget: ‚Çπ80,000-‚Çπ1,50,000";
                } else {
                    return "üéÆ 1080p Gaming Performance:\n‚Ä¢ RTX 4060: 120-200+ FPS (most games)\n‚Ä¢ RTX 4050: 80-120 FPS (high settings)\n‚Ä¢ GTX 1650: 50-80 FPS (medium settings)\n\nAll paired with Ryzen 5/i5 or better.\n\nBudget: ‚Çπ50,000-‚Çπ1,00,000";
                }
            }

            // Specific component queries - GPU
            if (/gpu|graphics.*card|rtx|gtx|radeon|rx|vram|video.*card/i.test(txt)) {
                if (/4090/i.test(txt)) {
                    return "üöÄ RTX 4090 - The Absolute Beast!\n‚Ä¢ VRAM: 24GB GDDR6X\n‚Ä¢ Performance: 4K gaming at 120+ FPS\n‚Ä¢ Price: ‚Çπ1,70,000 - ‚Çπ2,00,000\n‚Ä¢ TDP: 450W (needs 850W+ PSU)\n\n‚ö†Ô∏è Pair with Ryzen 9 7950X or i9-14900K to avoid bottlenecks!";
                } else if (/4080/i.test(txt)) {
                    return "üíé RTX 4080 - Enthusiast Powerhouse\n‚Ä¢ VRAM: 16GB GDDR6X\n‚Ä¢ Performance: 4K @ 100+ FPS, 1440p @ 165+ FPS\n‚Ä¢ Price: ‚Çπ1,10,000 - ‚Çπ1,30,000\n‚Ä¢ TDP: 320W (needs 750W+ PSU)\n\n‚ú® Best for 4K gaming without breaking the bank!";
                } else if (/4070/i.test(txt)) {
                    return "‚≠ê RTX 4070/4070 Ti - Sweet Spot\n‚Ä¢ VRAM: 12GB GDDR6X\n‚Ä¢ Performance: 1440p @ 120+ FPS, 4K @ 60+ FPS\n‚Ä¢ Price: ‚Çπ55,000 - ‚Çπ75,000\n‚Ä¢ TDP: 200-285W (needs 650W PSU)\n\nüéØ Perfect balance of price and performance!";
                } else if (/4060/i.test(txt)) {
                    return "üéÆ RTX 4060/4060 Ti - Value King\n‚Ä¢ VRAM: 8GB/16GB GDDR6\n‚Ä¢ Performance: 1080p @ 144+ FPS, 1440p @ 80+ FPS\n‚Ä¢ Price: ‚Çπ32,000 - ‚Çπ48,000\n‚Ä¢ TDP: 160-170W (needs 550W PSU)\n\nüí∞ Best value for 1080p-1440p gaming!";
                } else if (/amd|radeon|rx/i.test(txt)) {
                    return "üî¥ AMD Radeon Options:\n‚Ä¢ RX 7900 XTX: Competes with RTX 4080 (‚Çπ95k-‚Çπ1.1L)\n‚Ä¢ RX 7800 XT: Between 4070-4070 Ti (‚Çπ50k-‚Çπ60k)\n‚Ä¢ RX 7600: Entry 1080p gaming (‚Çπ25k-‚Çπ30k)\n\n‚ú® Great value, excellent rasterization, more VRAM!\n‚ö†Ô∏è Ray tracing not as strong as NVIDIA.";
                } else {
                    return "üéÆ GPU Selection Guide:\n\nüíé Budget:\n‚Ä¢ ‚Çπ25k-‚Çπ35k: RTX 4060, RX 7600 (1080p)\n‚Ä¢ ‚Çπ40k-‚Çπ60k: RTX 4060 Ti, RX 7700 XT (1440p)\n‚Ä¢ ‚Çπ65k-‚Çπ90k: RTX 4070 Ti, RX 7800 XT (1440p-4K)\n‚Ä¢ ‚Çπ1L+: RTX 4080/4090 (4K ultra)\n\nüéØ Gaming: Prioritize VRAM (8GB min, 12GB+ ideal)\nüé® Content: 12GB+ for rendering\n\nWhat's your budget and resolution target?";
                }
            }

            // Specific component queries - CPU
            if (/cpu|processor|ryzen|intel|core.*i[3579]|thread|clock.*speed/i.test(txt)) {
                if (/gaming/i.test(txt)) {
                    return "üéÆ Gaming CPU Recommendations:\n\n‚≠ê Best: Ryzen 7 7800X3D (‚Çπ35k-‚Çπ40k)\n‚Ä¢ 8 cores, 3D V-Cache = best gaming CPU\n\nüíé Great: i5-14600K or Ryzen 5 7600X (‚Çπ25k-‚Çπ30k)\n‚Ä¢ 6 cores sufficient for most games\n\nüí∞ Budget: i3-13100F or Ryzen 5 5600 (‚Çπ8k-‚Çπ12k)\n‚Ä¢ Solid 1080p gaming performance\n\nüîë Gaming needs: 6+ cores, high single-thread speed";
                } else if (/content|render|edit|stream/i.test(txt)) {
                    return "üé® Content Creation CPU Recommendations:\n\nüöÄ Pro: Ryzen 9 7950X or i9-14900K (‚Çπ45k-‚Çπ60k)\n‚Ä¢ 16-24 cores for fast rendering\n\n‚≠ê Great: Ryzen 7 7700X or i7-14700K (‚Çπ30k-‚Çπ40k)\n‚Ä¢ 8-12 cores, excellent multitasking\n\nüí∞ Budget: Ryzen 5 7600 (‚Çπ18k-‚Çπ22k)\n‚Ä¢ 6 cores, good for light editing\n\nüîë Content needs: More cores = faster exports!";
                } else {
                    return "üíª CPU Selection Guide:\n\nüéÆ Gaming: 6-8 cores, high clock speed\n‚Ä¢ Ryzen 7800X3D, i5-14600K\n\nüé® Content: 12-16 cores, multi-thread\n‚Ä¢ Ryzen 9 7950X, i9-14900K\n\nüíº Productivity: 8-12 cores, balanced\n‚Ä¢ Ryzen 7 7700X, i7-14700K\n\nüí∞ Budget: 4-6 cores\n‚Ä¢ Ryzen 5 5600, i3-13100F\n\nWhat's your primary use case?";
                }
            }

            // RAM queries
            if (/ram|memory|ddr4|ddr5|gb.*ram|how.*much.*ram/i.test(txt)) {
                return "üß† RAM Recommendations:\n\nüéÆ Gaming:\n‚Ä¢ 16GB DDR4/DDR5 (minimum)\n‚Ä¢ 32GB for AAA titles + multitasking\n‚Ä¢ 3200MHz+ DDR4 or 5600MHz+ DDR5\n\nüé® Content Creation:\n‚Ä¢ 32GB minimum (4K editing)\n‚Ä¢ 64GB for heavy projects\n‚Ä¢ Speed matters less, capacity first\n\nüíº Productivity:\n‚Ä¢ 16GB for office work\n‚Ä¢ 32GB for VMs/development\n\nüí∞ Prices:\n‚Ä¢ 16GB DDR4: ‚Çπ3k-‚Çπ5k\n‚Ä¢ 32GB DDR5: ‚Çπ10k-‚Çπ15k";
            }

            // Storage queries
            if (/ssd|nvme|storage|hard.*drive|hdd|gen4|m\.2/i.test(txt)) {
                return "üíæ Storage Recommendations:\n\n‚ö° Best: PCIe Gen4 NVMe SSD\n‚Ä¢ 7000+ MB/s read speeds\n‚Ä¢ WD Black SN850X, Samsung 990 Pro\n‚Ä¢ ‚Çπ6k-‚Çπ10k for 1TB\n\n‚ú® Great: PCIe Gen3 NVMe SSD\n‚Ä¢ 3500+ MB/s, excellent value\n‚Ä¢ WD Blue SN570, Samsung 980\n‚Ä¢ ‚Çπ4k-‚Çπ6k for 1TB\n\nüí∞ Budget: SATA SSD\n‚Ä¢ 550 MB/s, still way better than HDD\n‚Ä¢ ‚Çπ2.5k-‚Çπ4k for 1TB\n\nüìä Capacity:\n‚Ä¢ 500GB: OS + few games\n‚Ä¢ 1TB: Recommended minimum\n‚Ä¢ 2TB: Ideal for large game libraries";
            }

            // PSU queries
            if (/psu|power.*supply|watt|efficiency|80.*plus|gold|platinum/i.test(txt)) {
                if (state.currentBuild && state.currentBuild.type === 'desktop') {
                    const build = state.currentBuild.data;
                    const cpuTdp = parseInt(build.cpu.tdp?.match(/\d+/)?.[0] || 65);
                    const gpuTdp = parseInt(build.gpu.tdp?.match(/\d+/)?.[0] || 150);
                    const totalTdp = cpuTdp + gpuTdp + 100;
                    const recommended = Math.ceil(totalTdp * 1.2);
                    
                    return `‚ö° PSU Analysis for Your Build:\n\nüìä Power Requirements:\n‚Ä¢ CPU: ${cpuTdp}W\n‚Ä¢ GPU: ${gpuTdp}W\n‚Ä¢ System: 100W\n‚Ä¢ Total: ${totalTdp}W\n\n‚úÖ Recommended: ${recommended}W+ (20% headroom)\n\nüèÜ Quality:\n‚Ä¢ 80+ Gold: Best value\n‚Ä¢ 80+ Platinum: High efficiency\n‚Ä¢ Brands: Corsair, Seasonic, EVGA\n\nCurrent PSU: ${build.psu.name}`;
                }
                
                return "‚ö° PSU Selection Guide:\n\nüéØ Wattage:\n‚Ä¢ Budget build: 450-550W\n‚Ä¢ Mid-range: 650-750W\n‚Ä¢ High-end: 850W+\n‚Ä¢ RTX 4090: 1000W+\n\nüèÜ Efficiency:\n‚Ä¢ 80+ Bronze: Basic\n‚Ä¢ 80+ Gold: Best value ‚≠ê\n‚Ä¢ 80+ Platinum: High efficiency\n\nüí° Rule: (CPU TDP + GPU TDP + 100W) √ó 1.2\n\n‚úÖ Trusted Brands:\nCorsair, Seasonic, EVGA, Cooler Master";
            }

            // Laptop specific queries
            if (/laptop|notebook|portable|mobile/i.test(txt)) {
                if (/gaming.*laptop|laptop.*gaming/i.test(txt)) {
                    return "üéÆ Gaming Laptop Guide:\n\nüíé Premium (‚Çπ1.5L+):\n‚Ä¢ RTX 4070+, 165Hz screen\n‚Ä¢ ASUS ROG, MSI Raider, Legion 7\n\n‚≠ê Mid-Range (‚Çπ80k-‚Çπ1.5L):\n‚Ä¢ RTX 4060, 144Hz screen\n‚Ä¢ Legion 5, TUF A15, Nitro 5\n\nüí∞ Budget (‚Çπ50k-‚Çπ80k):\n‚Ä¢ RTX 4050/3050, 120Hz\n‚Ä¢ Victus, IdeaPad Gaming\n\nüîë Must-haves:\n‚Ä¢ 144Hz+ display\n‚Ä¢ 16GB RAM (upgradeable)\n‚Ä¢ Good cooling system";
                } else if (/productivity|work|office/i.test(txt)) {
                    return "üíº Productivity Laptop Guide:\n\nüèÜ Premium (‚Çπ1L+):\n‚Ä¢ ThinkPad X1, Dell XPS, MacBook Air M2\n‚Ä¢ 16GB+ RAM, 512GB+ SSD\n‚Ä¢ 10+ hour battery\n\n‚≠ê Mid-Range (‚Çπ50k-‚Çπ1L):\n‚Ä¢ ThinkPad E/T series, HP EliteBook\n‚Ä¢ 8-16GB RAM, good keyboard\n\nüí∞ Budget (‚Çπ30k-‚Çπ50k):\n‚Ä¢ IdeaPad, Inspiron, VivoBook\n‚Ä¢ 8GB RAM, basic needs\n\nüîë Priorities:\n‚Ä¢ Battery life > Performance\n‚Ä¢ Build quality matters\n‚Ä¢ Good keyboard & trackpad";
                } else {
                    return "üíª Laptop vs Desktop:\n\n‚úÖ Choose Laptop if:\n‚Ä¢ Need portability\n‚Ä¢ College/travel frequently\n‚Ä¢ Limited desk space\n\n‚úÖ Choose Desktop if:\n‚Ä¢ Gaming/heavy work\n‚Ä¢ Need upgradability\n‚Ä¢ Better price-performance\n\nüéÆ Gaming: Desktop = 30-40% better value\nüíº Work: Laptop = better flexibility\n\nWhat's your priority? Performance or portability?";
                }
            }

            // Build review/help
            if (/review|check|suggest|recommend|help.*build|good.*build/i.test(txt)) {
                if (state.currentBuild) {
                    if (state.currentBuild.type === 'laptop') {
                        const best = state.currentBuild.data[0];
                        return `üìä Your Laptop Selection Analysis:\n\n‚úÖ Top Pick: ${best.name}\n‚Ä¢ Price: ‚Çπ${best.price.toLocaleString('en-IN')}\n‚Ä¢ Usage: ${state.usage}\n‚Ä¢ Specs: ${best.spec}\n\n${best.aiScore ? `üéØ AI Score: ${best.aiScore}/100` : ''}\n\nüí° This laptop ${best.aiScore > 80 ? 'is an excellent match' : 'fits your needs well'} for ${state.usage} tasks!\n\nWant alternatives or have specific questions?`;
                    } else {
                        const build = state.currentBuild.data;
                        return `üìä Your Desktop Build Analysis:\n\n‚úÖ Components:\n‚Ä¢ CPU: ${build.cpu.name}\n‚Ä¢ GPU: ${build.gpu.name}\n‚Ä¢ RAM: ${build.ram.name}\n‚Ä¢ Storage: ${build.storage.name}\n\nüéØ Usage: ${state.usage}\nüí∞ Budget: ‚Çπ${state.budget.toLocaleString('en-IN')}\n\n‚ú® This build is optimized for ${state.usage} with balanced performance!\n\nNeed component upgrades or have compatibility questions?`;
                    }
                }
                return "ü§î I can help you build the perfect PC!\n\n1Ô∏è‚É£ Tell me your budget (‚Çπ50,000? ‚Çπ1,00,000?)\n2Ô∏è‚É£ What's your use case? (Gaming, editing, work?)\n3Ô∏è‚É£ Any brand preferences? (Intel/AMD, NVIDIA/AMD)\n\nOr use the wizard above to generate a build, then I can review it for you!";
            }

            // Upgrade queries
            if (/upgrade|improve|better|replace|swap/i.test(txt)) {
                return "‚¨ÜÔ∏è Upgrade Priority Guide:\n\nüéÆ Gaming PC:\n1. GPU (biggest FPS boost)\n2. CPU (if bottlenecking)\n3. RAM (16GB ‚Üí 32GB)\n4. Storage (HDD ‚Üí SSD)\n\nüé® Content Creation:\n1. RAM (32GB ‚Üí 64GB)\n2. CPU (more cores)\n3. Storage (larger/faster SSD)\n4. GPU (rendering acceleration)\n\nüí° General Rule:\n‚Ä¢ Upgrade GPU every 3-4 years\n‚Ä¢ CPU every 5-6 years\n‚Ä¢ RAM/Storage as needed\n\nWhat component are you thinking of upgrading?";
            }

            // Thanks/goodbye
            if (/thank|thanks|appreciate|bye|goodbye/i.test(txt)) {
                return "üòä You're welcome! Happy building!\n\nFeel free to ask if you have more questions. Good luck with your new PC! üöÄ";
            }

            // Generic game-specific queries
            if (/fortnite|pubg|valorant|apex|warzone|gta|cyberpunk|minecraft/i.test(txt)) {
                const game = txt.match(/fortnite|pubg|valorant|apex|warzone|gta|cyberpunk|minecraft/i)?.[0];
                const specs = {
                    fortnite: { gpu: 'RTX 4050+', cpu: 'Ryzen 5/i5', ram: '16GB', budget: '‚Çπ60k+' },
                    valorant: { gpu: 'RTX 4050', cpu: 'Ryzen 5/i5', ram: '8GB', budget: '‚Çπ50k+' },
                    cyberpunk: { gpu: 'RTX 4070+', cpu: 'Ryzen 7/i7', ram: '16GB', budget: '‚Çπ1.2L+' },
                    gta: { gpu: 'RTX 4060', cpu: 'Ryzen 5/i5', ram: '16GB', budget: '‚Çπ75k+' },
                    minecraft: { gpu: 'RTX 4050', cpu: 'Ryzen 5/i5', ram: '8GB', budget: '‚Çπ45k+' },
                    warzone: { gpu: 'RTX 4060', cpu: 'Ryzen 5/i5', ram: '16GB', budget: '‚Çπ80k+' },
                };
                
                const spec = specs[game.toLowerCase()] || { gpu: 'RTX 4060', cpu: 'Ryzen 5/i5', ram: '16GB', budget: '‚Çπ70k+' };
                
                return `üéÆ ${game.charAt(0).toUpperCase() + game.slice(1)} Requirements:\n\nüìä Recommended:\n‚Ä¢ GPU: ${spec.gpu}\n‚Ä¢ CPU: ${spec.cpu}\n‚Ä¢ RAM: ${spec.ram}\n‚Ä¢ Budget: ${spec.budget}\n\n‚ú® For 1080p 144fps+ at high settings!\n\nWant a specific build for this game?`;
            }

            // Fallback with helpful suggestions
            return "ü§î I'm not sure I understood that completely.\n\nüí° I can help with:\n‚Ä¢ üí∞ Budget recommendations\n‚Ä¢ üîß Component selection (CPU, GPU, RAM, etc.)\n‚Ä¢ üéÆ Gaming performance estimates\n‚Ä¢ ‚úÖ Compatibility checking\n‚Ä¢ ‚¨ÜÔ∏è Upgrade suggestions\n‚Ä¢ üíª Laptop recommendations\n\nTry asking:\n‚Ä¢ \"What GPU for ‚Çπ50k?\"\n‚Ä¢ \"Is my build compatible?\"\n‚Ä¢ \"Can it run Cyberpunk?\"\n‚Ä¢ \"Should I upgrade my CPU?\"";
        }

        function addTypingIndicator() {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            const id = 'typing-' + Date.now();
            div.id = id;
            div.className = 'flex gap-2 chat-msg';
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 text-xs">
                    <i class="fa-solid fa-robot"></i>
                </div>
                <div class="bg-white border-slate-100 p-3 rounded-2xl rounded-tl-none shadow-sm text-sm border flex gap-1 items-center">
                    <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                    <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                    <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                </div>
            `;
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
            return id;
        }

        function removeTypingIndicator(id) {
            const indicator = document.getElementById(id);
            if (indicator) indicator.remove();
        }

        // Expert Chat Functions
        function handleExpertChat(e) {
            if (e.key === 'Enter') sendExpertMessage();
        }

        function sendQuickQuestion(question) {
            const input = document.getElementById('expert-chat-input');
            input.value = question;
            sendExpertMessage();
        }

        function sendExpertMessage() {
            const input = document.getElementById('expert-chat-input');
            const rawText = input.value.trim();
            if(!rawText) return;

            // Sanitize input
            const txt = Security.sanitizeHTML(rawText).toLowerCase();
            
            // Rate limiting
            if (!Security.rateLimit.check()) {
                addExpertChatMsg('Please wait a moment before sending another message.', 'expert');
                return;
            }

            addExpertChatMsg(rawText, 'user');
            input.value = '';

            // Show typing indicator
            const typingId = addExpertTypingIndicator();
            
            setTimeout(() => {
                removeTypingIndicator(typingId);
                const response = getExpertResponse(txt);
                addExpertChatMsg(response, 'expert');
            }, 800 + Math.random() * 1200);
        }

        function addExpertChatMsg(msg, type) {
            const container = document.getElementById('expert-chat-messages');
            const div = document.createElement('div');
            
            if (type === 'user') {
                div.className = 'flex justify-end';
                div.innerHTML = `
                    <div class="bg-green-600 text-white p-3 rounded-lg rounded-tr-none shadow-sm max-w-[80%] text-sm">
                        ${msg}
                    </div>
                `;
            } else {
                div.className = 'flex items-start gap-2';
                div.innerHTML = `
                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-xs flex-shrink-0">
                        <i class="fa-solid fa-user-tie"></i>
                    </div>
                    <div class="bg-white rounded-lg p-3 shadow-sm max-w-[80%] text-sm text-slate-700" style="white-space: pre-line;">
                        ${msg}
                    </div>
                `;
            }
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function addExpertTypingIndicator() {
            const container = document.getElementById('expert-chat-messages');
            const div = document.createElement('div');
            const id = 'expert-typing-' + Date.now();
            div.id = id;
            div.className = 'flex items-start gap-2';
            div.innerHTML = `
                <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-xs flex-shrink-0">
                    <i class="fa-solid fa-user-tie"></i>
                </div>
                <div class="bg-white rounded-lg p-3 shadow-sm flex gap-1 items-center">
                    <div class="w-2 h-2 bg-green-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                    <div class="w-2 h-2 bg-green-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                    <div class="w-2 h-2 bg-green-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return id;
        }

        function getExpertResponse(txt) {
            // Current build context
            if (state.currentBuild) {
                if (/check|review|look|analyze|thoughts/i.test(txt)) {
                    const build = state.currentBuild;
                    if (build.type === 'desktop') {
                        const data = build.data;
                        return `üë®‚Äçüíª Expert Review of Your Build:\n\n‚úÖ Strong Points:\n‚Ä¢ ${data.gpu.name} is excellent for ${state.usage}\n‚Ä¢ ${data.cpu.name} provides solid performance\n‚Ä¢ Power supply is adequate\n\nüí° Recommendations:\n‚Ä¢ Consider upgrading to faster RAM if budget allows\n‚Ä¢ Add extra case fans for better cooling\n‚Ä¢ Monitor temperatures under load\n\nOverall: This is a well-balanced build! üëç`;
                    } else {
                        return `üë®‚Äçüíª Laptop Expert Analysis:\n\n${build.data.name}\n‚Çπ${build.data.price.toLocaleString('en-IN')}\n\n‚úÖ Pros:\n‚Ä¢ Good specs for ${state.usage}\n‚Ä¢ Reliable brand\n‚Ä¢ Decent value\n\n‚ö†Ô∏è Consider:\n‚Ä¢ Check thermals in reviews\n‚Ä¢ Verify warranty coverage\n‚Ä¢ Look for RAM upgrade options\n\nNeed more specific advice?`;
                    }
                }
            }

            // Troubleshooting
            if (/problem|issue|error|crash|not.*work|fail|blue.*screen|bsod/i.test(txt)) {
                if (/boot|start|turn.*on|power/i.test(txt)) {
                    return `üîß Boot Issues - Troubleshooting Steps:\n\n1Ô∏è‚É£ Check power connections (24-pin, 8-pin CPU)\n2Ô∏è‚É£ Reseat RAM sticks\n3Ô∏è‚É£ Try one RAM stick at a time\n4Ô∏è‚É£ Check CPU cooler is properly mounted\n5Ô∏è‚É£ Verify PSU switch is ON\n6Ô∏è‚É£ Check motherboard debug LEDs\n\nStill not working? Tell me what lights/beeps you see!`;
                } else if (/overheat|hot|temp|thermal/i.test(txt)) {
                    return `üå°Ô∏è Overheating Solutions:\n\nüîπ CPU:\n‚Ä¢ Reapply thermal paste\n‚Ä¢ Check cooler mounting\n‚Ä¢ Improve case airflow\n‚Ä¢ Consider better cooler\n\nüîπ GPU:\n‚Ä¢ Update drivers\n‚Ä¢ Clean dust from fans\n‚Ä¢ Increase fan curve\n‚Ä¢ Check for adequate PSU power\n\nüîπ Case:\n‚Ä¢ Add intake/exhaust fans\n‚Ä¢ Cable management\n‚Ä¢ Remove dust filters and clean\n\nWhat are your temps?`;
                } else if (/fps|stutter|lag|performance/i.test(txt)) {
                    return `‚ö° Performance Issues - Quick Fixes:\n\n1Ô∏è‚É£ Update GPU drivers (DDU clean install)\n2Ô∏è‚É£ Enable XMP/DOCP in BIOS for RAM\n3Ô∏è‚É£ Check background processes\n4Ô∏è‚É£ Monitor temps (HWInfo64)\n5Ô∏è‚É£ Verify game settings (resolution, quality)\n6Ô∏è‚É£ Check for bottlenecks\n\nüí° What's your CPU/GPU usage during gaming?`;
                } else {
                    return `üîç General Troubleshooting:\n\nüìã Provide me with:\n‚Ä¢ Exact issue description\n‚Ä¢ When it occurs\n‚Ä¢ Your PC specs\n‚Ä¢ Recent changes\n‚Ä¢ Error messages\n\nüõ†Ô∏è Common fixes:\n‚úì Update all drivers\n‚úì Check Event Viewer\n‚úì Run memory test\n‚úì Check disk health\n\nDescribe your issue in detail!`;
                }
            }

            // Upgrade advice
            if (/upgrade|improve|better|should.*i/i.test(txt)) {
                if (/gpu|graphics/i.test(txt)) {
                    return `üéÆ GPU Upgrade Expert Advice:\n\nüí≠ Questions to consider:\n1. Current GPU?\n2. Target resolution & FPS?\n3. Budget?\n4. PSU wattage?\n5. CPU (bottleneck check)?\n\nüéØ 2024 Sweet Spots:\n‚Ä¢ 1080p: RTX 4060 (‚Çπ35k)\n‚Ä¢ 1440p: RTX 4070 (‚Çπ65k)\n‚Ä¢ 4K: RTX 4080 (‚Çπ1.2L)\n\nTell me your setup for specific advice!`;
                } else if (/cpu|processor/i.test(txt)) {
                    return `‚öôÔ∏è CPU Upgrade Expert Advice:\n\n‚ö†Ô∏è Before upgrading:\n1. Check motherboard compatibility\n2. BIOS update may be needed\n3. Verify cooler compatibility\n4. Consider full platform upgrade?\n\nüéØ Best CPUs 2024:\n‚Ä¢ Budget: Ryzen 5 7600 (‚Çπ20k)\n‚Ä¢ Mid: Ryzen 7 7800X3D (‚Çπ38k)\n‚Ä¢ High: i9-14900K (‚Çπ55k)\n\nWhat's your current CPU & mobo?`;
                } else if (/ram|memory/i.test(txt)) {
                    return `üíæ RAM Upgrade Tips:\n\n‚úÖ Easy Wins:\n‚Ä¢ 16GB ‚Üí 32GB for multitasking\n‚Ä¢ Faster speeds (3600MHz+)\n‚Ä¢ Enable XMP/DOCP\n\n‚ö†Ô∏è Important:\n‚Ä¢ Match existing RAM for dual channel\n‚Ä¢ Check mobo max speed support\n‚Ä¢ DDR4 vs DDR5 (not compatible!)\n\nüí° Gaming: 16GB enough\nüé® Content: 32GB recommended\nüè¢ Workstation: 64GB+\n\nWhat's your use case?`;
                } else {
                    return `üí° General Upgrade Priority:\n\nüéÆ Gaming:\n1. GPU (biggest impact)\n2. CPU (if bottlenecking)\n3. RAM (if < 16GB)\n4. SSD (faster loading)\n\nüé® Content Creation:\n1. RAM (32GB+)\n2. CPU (more cores)\n3. GPU (if using acceleration)\n4. Fast NVMe storage\n\nüíº Productivity:\n1. SSD for OS\n2. RAM (16-32GB)\n3. Multiple monitors\n4. CPU (if needed)\n\nWhat do you mainly use PC for?`;
                }
            }

            // Component recommendations
            if (/recommend|suggest|best|good|which/i.test(txt)) {
                if (/motherboard|mobo/i.test(txt)) {
                    return `üî≤ Motherboard Expert Picks 2024:\n\nüí∞ Budget:\n‚Ä¢ B650M for Ryzen (‚Çπ12k)\n‚Ä¢ B760M for Intel (‚Çπ14k)\n\n‚≠ê Mid-range:\n‚Ä¢ B650 Tomahawk (‚Çπ22k)\n‚Ä¢ Z790 Gaming Plus (‚Çπ25k)\n\nüíé High-end:\n‚Ä¢ X670E Carbon (‚Çπ45k)\n‚Ä¢ Z790 Apex (‚Çπ55k)\n\nüîç Features to check:\n‚úì VRM quality for your CPU\n‚úì M.2 slots (Gen4/5?)\n‚úì PCIe 5.0 for GPU?\n‚úì Rear I/O ports\n\nWhat CPU are you pairing it with?`;
                } else if (/psu|power.*supply/i.test(txt)) {
                    return `‚ö° PSU Expert Recommendations:\n\nü•á Top Tier (A-Tier):\n‚Ä¢ Corsair RMx/HX series\n‚Ä¢ Seasonic Focus/Prime\n‚Ä¢ EVGA SuperNOVA G6\n‚Ä¢ MSI MPG A-GF\n\nüí° Wattage Guide:\n‚Ä¢ RTX 4060 build: 650W\n‚Ä¢ RTX 4070 build: 750W\n‚Ä¢ RTX 4080 build: 850W\n‚Ä¢ RTX 4090 build: 1000W\n\n‚úÖ Must have:\n‚úì 80+ Gold minimum\n‚úì Fully modular\n‚úì 10-year warranty\n‚úì ATX 3.0 (12VHPWR)\n\nYour GPU?`;
                } else if (/case/i.test(txt)) {
                    return `üì¶ Case Expert Picks:\n\nüå¨Ô∏è Airflow Kings:\n‚Ä¢ Lian Li Lancool 216 (‚Çπ9k)\n‚Ä¢ Fractal Torrent (‚Çπ18k)\n‚Ä¢ Corsair 4000D Airflow (‚Çπ8k)\n\nüîá Silent:\n‚Ä¢ be quiet! Pure Base 500DX (‚Çπ10k)\n‚Ä¢ Fractal Define 7 (‚Çπ15k)\n\nüé® Aesthetic:\n‚Ä¢ NZXT H510 Flow (‚Çπ8k)\n‚Ä¢ Lian Li O11 Dynamic (‚Çπ15k)\n\n‚úÖ Look for:\n‚úì Front mesh panel\n‚úì PSU shroud\n‚úì Cable management\n‚úì 2+ included fans\n‚úì Dust filters\n\nWhat size? (ATX/mATX/ITX)`;
                } else if (/cooler|cooling/i.test(txt)) {
                    return `‚ùÑÔ∏è Cooler Expert Guide:\n\nüå¨Ô∏è Air Coolers:\n‚Ä¢ Budget: DeepCool AK400 (‚Çπ2k)\n‚Ä¢ Mid: Noctua NH-U12S (‚Çπ6k)\n‚Ä¢ Premium: Noctua NH-D15 (‚Çπ9k)\n\nüíß AIO Liquid:\n‚Ä¢ 240mm: DeepCool LT520 (‚Çπ6k)\n‚Ä¢ 280mm: Arctic Liquid Freezer II (‚Çπ10k)\n‚Ä¢ 360mm: Corsair iCUE H150i (‚Çπ14k)\n\nüéØ Match to CPU TDP:\n‚Ä¢ 65W: Stock or basic tower\n‚Ä¢ 105W: Mid-tower or 240mm AIO\n‚Ä¢ 125W: Premium tower or 280mm+ AIO\n‚Ä¢ 150W+: High-end tower or 360mm AIO\n\nYour CPU?`;
                }
            }

            // Compatibility checks
            if (/fit|compatible|work.*with|support/i.test(txt)) {
                return `üîç Compatibility Check Service:\n\nüìù To help you, I need:\n1Ô∏è‚É£ CPU model\n2Ô∏è‚É£ Motherboard model\n3Ô∏è‚É£ RAM type & speed\n4Ô∏è‚É£ GPU model\n5Ô∏è‚É£ PSU wattage\n6Ô∏è‚É£ Case size\n\n‚úÖ I'll verify:\n‚úì CPU socket match\n‚úì RAM compatibility\n‚úì PCIe slot availability\n‚úì PSU power adequacy\n‚úì Physical clearances\n‚úì BIOS update needs\n\nList your components!`;
            }

            // Price/value questions
            if (/worth|price|cost|value|deal|should.*buy/i.test(txt)) {
                return `üí∞ Value Assessment Expert:\n\nüéØ Current Market (Dec 2024):\n\n‚úÖ Good Deals:\n‚Ä¢ RTX 4070: ‚Çπ55-60k\n‚Ä¢ Ryzen 7 7800X3D: ‚Çπ36-38k\n‚Ä¢ RTX 4060: ‚Çπ30-33k\n\n‚ö†Ô∏è Wait/Overpriced:\n‚Ä¢ RTX 3000 series (outdated)\n‚Ä¢ Intel 12th gen (13th/14th better value)\n\nüí° Value Tips:\n‚Ä¢ Check launch vs current price\n‚Ä¢ Compare to next tier up\n‚Ä¢ Consider used market (GPUs)\n‚Ä¢ Wait for sales (holidays)\n\nWhat component are you eyeing?`;
            }

            // Building help
            if (/build|assemble|install|how.*to|guide|tutorial/i.test(txt)) {
                if (/first.*time|beginner|never/i.test(txt)) {
                    return `üë∑ First Build? You got this!\n\nüì∫ Watch:\n1. Linus Tech Tips build guide\n2. JayzTwoCents beginners guide\n\n‚ö†Ô∏è Common Mistakes:\n‚ùå Forgetting I/O shield\n‚ùå Not using motherboard standoffs\n‚ùå Forgetting to flip PSU switch\n‚ùå Not connecting CPU power (8-pin)\n‚ùå Overtightening screws\n\nüí° Pro Tips:\n‚úì Build on table first (test boot)\n‚úì Install RAM in slots 2&4\n‚úì Apply pea-sized thermal paste\n‚úì Cable management = better airflow\n\nTake your time! Any specific step?`;
                } else {
                    return `üîß Build Assembly Order:\n\n1Ô∏è‚É£ Install I/O shield in case\n2Ô∏è‚É£ Mount motherboard standoffs\n3Ô∏è‚É£ Install CPU on motherboard\n4Ô∏è‚É£ Apply thermal paste\n5Ô∏è‚É£ Mount CPU cooler\n6Ô∏è‚É£ Install RAM\n7Ô∏è‚É£ Mount motherboard in case\n8Ô∏è‚É£ Install PSU\n9Ô∏è‚É£ Install storage drives\nüîü Install GPU\n1Ô∏è‚É£1Ô∏è‚É£ Connect all cables\n1Ô∏è‚É£2Ô∏è‚É£ Cable management\n1Ô∏è‚É£3Ô∏è‚É£ Test boot!\n\nWhich step needs help?`;
                }
            }

            // Default expert responses
            const expertResponses = [
                `üë®‚Äçüíª I'm here to help with expert advice!\n\nI can assist with:\nüîß Troubleshooting\nüí° Component selection\n‚ö° Performance optimization\nüéÆ Gaming builds\nüíº Workstation setups\nüîç Compatibility checks\n\nWhat specific question do you have?`,
                
                `üí¨ Let me help you with that!\n\nFor the best advice, tell me:\n‚Ä¢ Your budget\n‚Ä¢ Your use case (gaming/work/both)\n‚Ä¢ Current components (if upgrading)\n‚Ä¢ Specific concerns\n\nThe more details, the better I can help!`,
                
                `üéØ Expert tip: Always verify component compatibility before buying!\n\nKey checks:\n‚úì CPU socket matches motherboard\n‚úì RAM type (DDR4/DDR5)\n‚úì PSU wattage for your GPU\n‚úì Case size fits your motherboard\n‚úì Cooler height clearance\n\nNeed a compatibility check?`
            ];

            return expertResponses[Math.floor(Math.random() * expertResponses.length)];
        }

        function addChatMsg(text, sender) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = `flex gap-2 chat-msg ${sender === 'user' ? 'flex-row-reverse' : ''}`;
            const icon = sender === 'ai' 
                ? '<div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 text-xs"><i class="fa-solid fa-robot"></i></div>' 
                : '<div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-xs"><i class="fa-solid fa-user"></i></div>';
            
            // Sanitize text for display
            const safeText = Security.sanitizeHTML(text);
            const formattedText = safeText.replace(/\n/g, '<br>');
            
            const bubble = `<div class="${sender === 'ai' ? 'bg-white border-slate-100 text-slate-700' : 'bg-blue-600 text-white'} p-3 rounded-2xl ${sender === 'ai' ? 'rounded-tl-none' : 'rounded-tr-none'} shadow-sm text-sm max-w-[80%] border whitespace-pre-line">${formattedText}</div>`;
            div.innerHTML = icon + bubble;
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
        }
    </script>
</body>
</html>