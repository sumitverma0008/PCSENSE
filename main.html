<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>PCSensei | Intelligent PC & Laptop Consultant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Three.js for 3D Visualization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXX"
            crossorigin="anonymous"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            dark: '#0f172a',
                            accent: '#3b82f6',
                            glass: 'rgba(15, 23, 42, 0.8)'
                        }
                    },
                    animation: {
                        'slide-up': 'slideUp 0.5s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }
        .dark-glass {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        /* 3D Viewer Styles */
        #pc-3d-viewer {
            width: 100%;
            height: 500px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }
        
        .viewer-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 10;
        }
        
        .viewer-control-btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .viewer-control-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .component-label {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            pointer-events: none;
            z-index: 5;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .component-label.active {
            opacity: 1;
        }
        .ad-container {
            margin: 20px auto;
            text-align: center;
            min-height: 100px;
            background: rgba(248, 250, 252, 0.5);
            border-radius: 8px;
            padding: 10px;
            border: 1px dashed rgba(203, 213, 225, 0.5);
        }
        .ad-label {
            font-size: 10px;
            color: #94a3b8;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .shop-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            animation: fadeIn 0.2s ease-out;
        }
        .shop-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }
        .store-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            transition: all 0.2s;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
        }
        .store-btn:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
            transform: translateX(4px);
        }
        .store-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .chat-msg {
            animation: slideUp 0.3s ease-out;
        }
        
        /* Enhanced hover effects */
        button, a {
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        /* Currency styling */
        .price-value {
            font-variant-numeric: tabular-nums;
        }
        
        /* Improved responsive design */
        @media (max-width: 640px) {
            #ai-chat-panel {
                width: calc(100vw - 32px);
                right: 16px;
                left: 16px;
            }
            
            .glass-panel {
                backdrop-filter: blur(8px);
            }
            
            h2, h3 {
                font-size: 1.5rem;
            }
        }
        
        @media (max-width: 768px) {
            .max-w-7xl {
                padding-left: 1rem;
                padding-right: 1rem;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans selection:bg-blue-200">

    <!-- Navbar -->
    <nav class="fixed w-full z-50 glass-panel shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2 cursor-pointer" onclick="goHome()">
                    <div class="w-10 h-10 bg-brand-dark rounded-lg flex items-center justify-center text-blue-400">
                        <i class="fa-solid fa-cube text-xl"></i>
                    </div>
                    <span class="font-bold text-xl tracking-tight text-slate-900">PCSensei</span>
                </div>
                
                <div class="hidden md:flex space-x-8 items-center">
                    <a href="#" onclick="goHome()" class="text-slate-600 hover:text-blue-600 transition font-medium">Home</a>
                    <a href="#builder" onclick="startWizard()" class="text-slate-600 hover:text-blue-600 transition font-medium">Builder</a>
                    <a href="admin.html" class="text-slate-600 hover:text-blue-600 transition font-medium flex items-center gap-1">
                        <i class="fa-solid fa-user-shield"></i> Admin
                    </a>
                    <div class="h-6 w-px bg-slate-300"></div>
                    <button onclick="toggleLiveSupport()" class="flex items-center gap-2 text-green-600 font-bold hover:text-green-700 transition">
                        <span class="relative flex h-3 w-3">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                        </span>
                        Talk to Expert
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="pt-16 min-h-screen relative">
        
        <!-- View: Landing Page -->
        <div id="view-landing" class="block">
            <div class="relative bg-slate-900 h-[600px] overflow-hidden">
                <div class="absolute inset-0">
                    <img src="https://images.unsplash.com/photo-1593640408182-31c70c8268f5?auto=format&fit=crop&q=80" class="w-full h-full object-cover opacity-20">
                    <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/80 to-transparent"></div>
                </div>
                
                <div class="relative max-w-7xl mx-auto px-4 pt-32 text-center text-white">
                    <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-blue-500/10 border border-blue-500/30 text-blue-400 text-sm font-medium mb-6">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> AI-Powered Recommendations
                    </div>
                    <h1 class="text-4xl md:text-6xl font-extrabold tracking-tight mb-6">
                        Build Your Dream PC.<br>
                        <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">Or Find the Perfect Laptop.</span>
                    </h1>
                    <p class="text-xl text-slate-400 max-w-2xl mx-auto mb-6">
                        Tell us your budget (starting at ₹15,000) and goals. We predict performance and find compatible parts instantly.
                    </p>
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button onclick="startWizard()" class="px-8 py-4 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold text-lg transition shadow-lg shadow-blue-500/25 flex items-center justify-center gap-2">
                            Start Consultation <i class="fa-solid fa-arrow-right"></i>
                        </button>
                        <button onclick="toggleAI()" class="px-8 py-4 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl font-bold text-lg transition backdrop-blur-sm flex items-center justify-center gap-2">
                            <i class="fa-solid fa-robot"></i> Ask AI Assistant
                        </button>
                    </div>
                </div>
            </div>

            <!-- Ad: Top Banner (After Hero) -->
            <div class="max-w-7xl mx-auto px-4 py-6">
                <div class="ad-container">
                    <div class="ad-label">Advertisement</div>
                    <!-- Google AdSense Banner Ad (728x90 or Responsive) -->
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-XXXXXXXXXX"
                         data-ad-slot="XXXXXXXXXX"
                         data-ad-format="horizontal"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
            </div>

            <!-- Features Grid -->
            <div class="py-20 max-w-7xl mx-auto px-4">
                <div class="grid md:grid-cols-3 gap-8">
                    <div class="p-6 rounded-2xl bg-white border border-slate-200 shadow-sm hover:shadow-md transition">
                        <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center text-xl mb-4"><i class="fa-solid fa-gauge-high"></i></div>
                        <h3 class="text-xl font-bold mb-2">Performance Prediction</h3>
                        <p class="text-slate-500">See estimated FPS for games or software performance for Workstations/Dev.</p>
                    </div>
                    <div class="p-6 rounded-2xl bg-white border border-slate-200 shadow-sm hover:shadow-md transition">
                        <div class="w-12 h-12 bg-purple-100 text-purple-600 rounded-lg flex items-center justify-center text-xl mb-4"><i class="fa-solid fa-indian-rupee-sign"></i></div>
                        <h3 class="text-xl font-bold mb-2">Budget Friendly</h3>
                        <p class="text-slate-500">Support for builds starting from ₹15,000 up to ultra-high-end workstations (5L+).</p>
                    </div>
                    <div class="p-6 rounded-2xl bg-white border border-slate-200 shadow-sm hover:shadow-md transition">
                        <div class="w-12 h-12 bg-emerald-100 text-emerald-600 rounded-lg flex items-center justify-center text-xl mb-4"><i class="fa-solid fa-headset"></i></div>
                        <h3 class="text-xl font-bold mb-2">Expert Support</h3>
                        <p class="text-slate-500">Stuck? Chat with our AI instantly or request a live session with a human hardware expert.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- View: Wizard -->
        <div id="view-wizard" class="hidden min-h-[80vh] bg-slate-100 py-12">
            <div class="max-w-3xl mx-auto px-4">
                <div class="mb-8 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-slate-800">Configuration Wizard</h2>
                    <div class="text-sm text-slate-500">Step <span id="wiz-step-num">1</span> of 4</div>
                </div>
                
                <!-- Progress Bar -->
                <div class="w-full bg-slate-200 h-2 rounded-full mb-8">
                    <div id="wiz-progress" class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: 25%"></div>
                </div>

                <div class="bg-white rounded-2xl shadow-xl p-8 animate-slide-up relative overflow-hidden">
                    
                    <!-- Step 1: Form Factor -->
                    <div id="step-1" class="wizard-step">
                        <h3 class="text-xl font-bold mb-6">What type of computer do you need?</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <button onclick="setFormFactor('desktop')" class="p-8 border-2 border-slate-100 hover:border-blue-500 rounded-2xl text-center hover:bg-blue-50 transition group">
                                <i class="fa-solid fa-desktop text-5xl text-slate-300 group-hover:text-blue-600 mb-4 transition"></i>
                                <div class="font-bold text-xl text-slate-800">Desktop PC</div>
                                <p class="text-sm text-slate-500 mt-2">Best performance & upgradability.</p>
                            </button>
                            <button onclick="setFormFactor('laptop')" class="p-8 border-2 border-slate-100 hover:border-blue-500 rounded-2xl text-center hover:bg-blue-50 transition group">
                                <i class="fa-solid fa-laptop text-5xl text-slate-300 group-hover:text-blue-600 mb-4 transition"></i>
                                <div class="font-bold text-xl text-slate-800">Laptop</div>
                                <p class="text-sm text-slate-500 mt-2">Portability & convenience.</p>
                            </button>
                        </div>
                    </div>

                    <!-- Step 2: Usage -->
                    <div id="step-2" class="wizard-step hidden">
                        <h3 class="text-xl font-bold mb-6">What is your primary use case?</h3>
                        <div class="grid gap-4">
                            <button onclick="setUsage('gaming')" class="w-full p-4 border-2 border-slate-100 hover:border-blue-500 rounded-xl text-left hover:bg-blue-50 transition group flex items-center gap-4">
                                <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center text-slate-600 group-hover:bg-blue-100 group-hover:text-blue-600"><i class="fa-solid fa-gamepad"></i></div>
                                <div>
                                    <div class="font-bold text-slate-800">Gaming & Streaming</div>
                                    <div class="text-sm text-slate-500">High FPS, AAA Titles, 1440p/4K</div>
                                </div>
                            </button>
                            <button onclick="setUsage('productivity')" class="w-full p-4 border-2 border-slate-100 hover:border-blue-500 rounded-xl text-left hover:bg-blue-50 transition group flex items-center gap-4">
                                <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center text-slate-600 group-hover:bg-blue-100 group-hover:text-blue-600"><i class="fa-solid fa-briefcase"></i></div>
                                <div>
                                    <div class="font-bold text-slate-800">Workstation / Office</div>
                                    <div class="text-sm text-slate-500">Video Editing, 3D, Office Apps, Student work</div>
                                </div>
                            </button>
                            <button onclick="setUsage('coding')" class="w-full p-4 border-2 border-slate-100 hover:border-blue-500 rounded-xl text-left hover:bg-blue-50 transition group flex items-center gap-4">
                                <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center text-slate-600 group-hover:bg-blue-100 group-hover:text-blue-600"><i class="fa-solid fa-code"></i></div>
                                <div>
                                    <div class="font-bold text-slate-800">Programming & Dev</div>
                                    <div class="text-sm text-slate-500">Virtual Machines, Docker, Compiling</div>
                                </div>
                            </button>
                            <div class="pt-4">
                                <button onclick="navWizard(1)" class="text-slate-500 hover:text-slate-800">Back</button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Budget -->
                    <div id="step-3" class="wizard-step hidden">
                        <h3 class="text-xl font-bold mb-6">What is your maximum budget? (INR)</h3>
                        <div class="space-y-6">
                            <input type="range" min="15000" max="500000" step="5000" value="50000" id="budget-range" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600" oninput="updateBudget(this.value)">
                            <div class="text-center">
                                <div class="price-value">
                                    <span class="text-4xl font-bold text-blue-600"><span style="font-size: 0.7em; opacity: 0.8;">₹</span><span id="budget-val">50,000</span></span>
                                </div>
                                <p class="text-slate-400 mt-2 text-sm flex items-center justify-center gap-2"><i class="fa-solid fa-info-circle"></i> We'll find the best <span id="budget-type-text">PC</span> within this limit.</p>
                            </div>
                            <div class="flex justify-between pt-6">
                                <button onclick="navWizard(2)" class="text-slate-500 hover:text-slate-800">Back</button>
                                <button onclick="navWizard(4)" class="bg-slate-900 text-white px-6 py-2 rounded-lg hover:bg-slate-800">Next Step</button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Brand & Aesthetics -->
                    <div id="step-4" class="wizard-step hidden">
                        <h3 class="text-xl font-bold mb-4">Final Preferences</h3>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-slate-700 mb-2">CPU Preference</label>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="setPref('cpu', 'Intel')" id="btn-cpu-intel" class="pref-btn border rounded-lg p-3 text-center hover:bg-slate-50">Intel</button>
                                <button onclick="setPref('cpu', 'AMD')" id="btn-cpu-amd" class="pref-btn border rounded-lg p-3 text-center hover:bg-slate-50">AMD</button>
                                <button onclick="setPref('cpu', 'Any')" id="btn-cpu-any" class="pref-btn bg-blue-50 border-blue-500 border rounded-lg p-3 text-center text-blue-700 font-bold">Any</button>
                            </div>
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-slate-700 mb-2">GPU Preference</label>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="setPref('gpu', 'NVIDIA')" id="btn-gpu-nvidia" class="pref-btn border rounded-lg p-3 text-center hover:bg-slate-50">NVIDIA</button>
                                <button onclick="setPref('gpu', 'AMD')" id="btn-gpu-amd" class="pref-btn border rounded-lg p-3 text-center hover:bg-slate-50">AMD</button>
                                <button onclick="setPref('gpu', 'Any')" id="btn-gpu-any" class="pref-btn bg-blue-50 border-blue-500 border rounded-lg p-3 text-center text-blue-700 font-bold">Any</button>
                            </div>
                        </div>

                        <div class="flex justify-between pt-4">
                            <button onclick="navWizard(3)" class="text-slate-500 hover:text-slate-800 transition-colors flex items-center gap-2 px-4 py-2 hover:bg-slate-100 rounded-lg"><i class="fa-solid fa-arrow-left"></i> Back</button>
                            <button onclick="generateBuild()" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 font-bold shadow-lg shadow-blue-500/30 transition-all hover:shadow-xl flex items-center gap-2">
                                <i class="fa-solid fa-magic"></i> See Recommendation
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- View: Results -->
        <div id="view-results" class="hidden min-h-screen bg-slate-50 pb-20">
            <div class="bg-slate-900 text-white py-12 px-4">
                <div class="max-w-7xl mx-auto text-center">
                    <h2 class="text-3xl font-bold mb-2">Your Recommendation</h2>
                    <p class="text-slate-400">Optimized for <span id="res-usage" class="text-white font-bold capitalize">Gaming</span> • Budget: <span id="res-budget"></span></p>
                </div>
            </div>

            <div class="max-w-7xl mx-auto px-4 -mt-8">
                <div class="bg-white rounded-xl shadow-xl overflow-hidden border border-slate-200">
                    
                    <!-- Build Summary Header -->
                    <div class="bg-blue-50 p-6 border-b border-blue-100 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="flex items-center gap-3">
                            <div class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-bold flex items-center gap-2">
                                <i class="fa-solid fa-check-circle"></i> Best Match Found
                            </div>
                            <span class="text-sm text-slate-500">Generated by PCSensei Engine</span>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-slate-500">Estimated Price</div>
                            <div class="text-3xl font-bold text-slate-900" id="total-price">₹0</div>
                        </div>
                    </div>

                    <!-- 3D PC Visualization -->
                    <div id="pc-3d-section" class="p-6 bg-gradient-to-br from-slate-50 to-blue-50 border-b border-slate-200" style="display: none;">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <i class="fa-solid fa-cube text-blue-600"></i>
                                <span>3D Build Preview</span>
                                <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full ml-2">Interactive</span>
                            </h3>
                            <button onclick="toggle3DView()" class="text-sm text-slate-600 hover:text-slate-800 flex items-center gap-2">
                                <i class="fa-solid fa-eye-slash"></i> Hide 3D View
                            </button>
                        </div>
                        
                        <!-- 3D Canvas Container -->
                        <div class="relative">
                            <div id="pc-3d-viewer"></div>
                            
                            <!-- Component Labels -->
                            <div id="label-cpu" class="component-label" style="top: 30%; left: 45%;">
                                <i class="fa-solid fa-microchip text-blue-600"></i> CPU
                            </div>
                            <div id="label-gpu" class="component-label" style="top: 50%; left: 40%;">
                                <i class="fa-solid fa-display text-purple-600"></i> GPU
                            </div>
                            <div id="label-ram" class="component-label" style="top: 25%; left: 65%;">
                                <i class="fa-solid fa-memory text-green-600"></i> RAM
                            </div>
                            <div id="label-storage" class="component-label" style="bottom: 30%; left: 50%;">
                                <i class="fa-solid fa-hard-drive text-orange-600"></i> Storage
                            </div>
                            <div id="label-psu" class="component-label" style="bottom: 20%; left: 30%;">
                                <i class="fa-solid fa-bolt text-yellow-600"></i> PSU
                            </div>
                            
                            <!-- Viewer Controls -->
                            <div class="viewer-controls">
                                <button class="viewer-control-btn" onclick="rotate3DView('left')">
                                    <i class="fa-solid fa-arrow-left"></i> Rotate Left
                                </button>
                                <button class="viewer-control-btn" onclick="reset3DView()">
                                    <i class="fa-solid fa-redo"></i> Reset
                                </button>
                                <button class="viewer-control-btn" onclick="rotate3DView('right')">
                                    Rotate Right <i class="fa-solid fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-4 text-center text-sm text-slate-600">
                            <i class="fa-solid fa-info-circle"></i> 
                            Drag to rotate • Scroll to zoom • Click components for details
                        </div>
                    </div>

                    <!-- Dynamic Performance Section -->
                    <div id="performance-section" class="p-6 bg-slate-50 border-b border-slate-200">
                        <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <span id="perf-icon"></span>
                            <span id="perf-title">Performance Estimates</span>
                        </h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" id="benchmark-cards">
                            <!-- Injected via JS -->
                        </div>
                    </div>

                    <!-- Parts List Container -->
                    <div class="p-0" id="parts-container">
                        <!-- Parts injected via JS -->
                    </div>

                    <!-- Actions -->
                    <div class="p-6 bg-slate-50 border-t border-slate-200 flex flex-wrap justify-between gap-4">
                        <button onclick="toggle3DView()" id="btn-3d-toggle" class="px-6 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:shadow-lg transition-all flex items-center gap-2" style="display: none;">
                            <i class="fa-solid fa-cube"></i> View in 3D
                        </button>
                        <div class="flex gap-4">
                            <button onclick="startWizard()" class="px-6 py-2 border border-slate-300 rounded-lg hover:bg-white text-slate-600 transition-all hover:shadow-md flex items-center gap-2"><i class="fa-solid fa-edit"></i> Edit Preferences</button>
                            <button onclick="window.print()" class="px-6 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition-all hover:shadow-lg flex items-center gap-2"><i class="fa-solid fa-print"></i> Save Details</button>
                        </div>
                    </div>
                </div>
                
                <!-- Ad: Results Page Sidebar -->
                <div class="mt-8">
                    <div class="ad-container">
                        <div class="ad-label">Advertisement</div>
                        <!-- Google AdSense Sidebar Ad (300x250 or Responsive) -->
                        <ins class="adsbygoogle"
                             style="display:block"
                             data-ad-client="ca-pub-XXXXXXXXXX"
                             data-ad-slot="XXXXXXXXXX"
                             data-ad-format="auto"
                             data-full-width-responsive="true"></ins>
                        <script>
                             (adsbygoogle = window.adsbygoogle || []).push({});
                        </script>
                    </div>
                </div>

                <!-- AI Explanation -->
                <div class="mt-8 bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex gap-4">
                    <div class="w-12 h-12 bg-purple-100 text-purple-600 rounded-full flex-shrink-0 flex items-center justify-center text-xl">
                        <i class="fa-solid fa-robot"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-slate-800 mb-2">Why this choice?</h4>
                        <p class="text-slate-600 leading-relaxed" id="build-reasoning">
                            Loading reasoning...
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ad: Before Footer -->
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="ad-container">
                <div class="ad-label">Advertisement</div>
                <!-- Google AdSense Large Rectangle Ad (336x280 or Responsive) -->
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-XXXXXXXXXX"
                     data-ad-slot="XXXXXXXXXX"
                     data-ad-format="rectangle"
                     data-full-width-responsive="true"></ins>
                <script>
                     (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
            </div>
        </div>

        <!-- Footer -->
        <footer class="bg-slate-900 text-white py-8 mt-20">
            <div class="max-w-7xl mx-auto px-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div>
                        <div class="flex items-center gap-2 mb-4">
                            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                                <i class="fa-solid fa-cube text-xl"></i>
                            </div>
                            <span class="font-bold text-xl">PCSensei</span>
                        </div>
                        <p class="text-slate-400 text-sm">AI-powered PC building assistant with smart recommendations and automated price monitoring.</p>
                    </div>
                    <div>
                        <h4 class="font-bold mb-4">Quick Links</h4>
                        <ul class="space-y-2 text-slate-400 text-sm">
                            <li><a href="#" onclick="goHome()" class="hover:text-white transition">Home</a></li>
                            <li><a href="#builder" onclick="startWizard()" class="hover:text-white transition">Build PC</a></li>
                            <li><a href="price-dashboard.html" class="hover:text-white transition">Price Updates</a></li>
                            <li><a href="https://github.com/sumitverma0008/PCSENSE" target="_blank" class="hover:text-white transition">GitHub</a></li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold mb-4">Admin Access</h4>
                        <a href="admin.html" class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg transition font-semibold">
                            <i class="fa-solid fa-user-shield"></i> Admin Panel
                        </a>
                        <p class="text-slate-400 text-xs mt-4">Manage components, view analytics, and monitor price updates.</p>
                    </div>
                </div>
                <div class="border-t border-slate-800 mt-8 pt-6 text-center text-slate-400 text-sm">
                    <p>© 2025 PCSensei. Built with ❤️ for PC enthusiasts.</p>
                </div>
            </div>
        </footer>

    </main>

    <!-- Shopping Options Modal -->
    <div id="shop-modal" class="shop-modal" onclick="closeShopModal(event)">
        <div class="shop-modal-content" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-slate-800">Compare & Buy</h3>
                <button onclick="closeShopModal()" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center text-slate-400 hover:text-slate-600">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <p class="text-sm text-slate-600 mb-6" id="shop-product-name"></p>
            <div class="space-y-3" id="shop-links-container">
                <!-- Store links will be injected here -->
            </div>
        </div>
    </div>

    <!-- Floating UI: AI Chat -->
    <div id="ai-chat-panel" class="fixed bottom-24 right-6 w-96 h-[500px] glass-panel rounded-2xl shadow-2xl transform translate-y-[120%] transition-transform duration-300 z-40 flex flex-col">
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 p-4 rounded-t-2xl flex justify-between items-center text-white shadow-lg">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                    <i class="fa-solid fa-robot"></i>
                </div>
                <div>
                    <span class="font-bold block">PCSensei AI</span>
                    <span class="text-xs opacity-80">Online • Ready to help</span>
                </div>
            </div>
            <button onclick="toggleAI()" class="hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all"><i class="fa-solid fa-times"></i></button>
        </div>
        <div id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50/50">
            <!-- Msgs -->
            <div class="flex gap-2">
                <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 text-xs"><i class="fa-solid fa-robot"></i></div>
                <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-700 max-w-[80%] border border-slate-100">
                    Hello! I can help you verify compatibility or suggest alternatives. Ask me anything!
                </div>
            </div>
        </div>
        <div class="p-3 bg-white border-t border-slate-200 rounded-b-2xl">
            <div class="flex gap-2">
                <input type="text" id="chat-input" placeholder="Ask about laptop specs..." class="flex-1 bg-slate-100 border-0 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 text-sm" onkeypress="handleChat(event)">
                <button onclick="sendMessage()" class="bg-purple-600 text-white w-10 h-10 rounded-lg hover:bg-purple-700"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- Floating UI: Live Support -->
    <div id="live-support-panel" class="fixed top-20 right-6 w-80 bg-white rounded-xl shadow-2xl border border-slate-200 z-50 hidden animate-slide-up">
        <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-xl">
            <h3 class="font-bold text-slate-800"><i class="fa-solid fa-headset mr-2 text-green-500"></i>Live Expert</h3>
            <button onclick="toggleLiveSupport()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times"></i></button>
        </div>
        <div class="p-6 text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600 text-2xl relative">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-20"></span>
                <i class="fa-solid fa-user-check"></i>
            </div>
            <h4 class="font-bold text-slate-800 mb-1">Connecting...</h4>
            <p class="text-sm text-slate-500 mb-6">An expert agent is reviewing your current configuration.</p>
            <div class="bg-slate-100 rounded-lg p-3 text-xs text-left text-slate-500 mb-4">
                <p><strong>Position in queue:</strong> 1</p>
                <p><strong>Est. wait time:</strong> < 1 min</p>
            </div>
            <button class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg transition">Cancel Request</button>
        </div>
    </div>

    <!-- Floating Buttons -->
    <button onclick="toggleAI()" class="fixed bottom-6 right-6 w-14 h-14 bg-gradient-to-r from-purple-600 to-blue-600 rounded-full text-white shadow-lg hover:shadow-xl hover:scale-105 transition flex items-center justify-center text-2xl z-30">
        <i class="fa-solid fa-robot"></i>
    </button>

    <script>
        // --- SECURITY UTILITIES ---
        const Security = {
            sanitizeHTML(str) {
                if (typeof str !== 'string') return str;
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            },
            
            sanitizeNumber(value, min = 0, max = Infinity) {
                const num = parseFloat(value);
                if (isNaN(num)) return min;
                return Math.max(min, Math.min(max, num));
            },
            
            validateBudget(budget) {
                return this.sanitizeNumber(budget, 15000, 500000);
            },
            
            sanitizeObject(obj) {
                if (typeof obj !== 'object' || obj === null) return {};
                const sanitized = {};
                for (let key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        if (typeof obj[key] === 'string') {
                            sanitized[key] = this.sanitizeHTML(obj[key]);
                        } else if (typeof obj[key] === 'number') {
                            sanitized[key] = this.sanitizeNumber(obj[key]);
                        } else {
                            sanitized[key] = obj[key];
                        }
                    }
                }
                return sanitized;
            },
            
            rateLimit: {
                lastRequest: 0,
                minDelay: 1000,
                
                check() {
                    const now = Date.now();
                    if (now - this.lastRequest < this.minDelay) {
                        return false;
                    }
                    this.lastRequest = now;
                    return true;
                }
            }
        };

        // --- 1. DATABASE LOADER ---
        let db = null;
        let dbLoaded = false;

        async function loadDb() {
            if (dbLoaded && db) return db;
            
            try {
                const response = await fetch('data/components.json', {
                    headers: { 'Cache-Control': 'no-cache' }
                });
                if (!response.ok) throw new Error('Failed to load components database');
                
                const data = await response.json();
                
                // Validate database structure
                const requiredKeys = ['laptops', 'cpus', 'gpus', 'mobos', 'ram', 'storage', 'psu', 'case'];
                const isValid = requiredKeys.every(key => Array.isArray(data[key]));
                
                if (!isValid) {
                    throw new Error('Invalid database structure');
                }
                
                // Sanitize all data
                db = {};
                for (let key of requiredKeys) {
                    db[key] = data[key].map(item => Security.sanitizeObject(item));
                }
                
                dbLoaded = true;
                return db;
            } catch (error) {
                console.error('Database load error:', error);
                alert('Failed to load component database. Please refresh the page.');
                throw error;
            }
        }

        // --- 2. METRICS ---
        const PERFORMANCE_METRICS = {
            gaming: {
                label: "Estimated Gaming Performance",
                icon: '<i class="fa-solid fa-gamepad text-purple-600"></i>',
                metrics: {
                    integrated: [
                        { name: "GTA V", value: "30-40 FPS (720p)", color: "text-green-600" },
                        { name: "Valorant", value: "60+ FPS (Low)", color: "text-blue-600" },
                        { name: "Cyberpunk", value: "Unplayable", color: "text-red-600" },
                        { name: "Live Streaming", value: "Not Supported", color: "text-red-600" }
                    ],
                    entry: [
                        { name: "GTA V", value: "60+ FPS (1080p)", color: "text-green-600" },
                        { name: "Valorant", value: "144+ FPS (High)", color: "text-blue-600" },
                        { name: "Cyberpunk", value: "30-45 FPS (Low)", color: "text-orange-600" },
                        { name: "Live Streaming", value: "720p 30FPS (Basic)", color: "text-orange-600" }
                    ],
                    mid: [
                        { name: "GTA V", value: "100+ FPS (Ultra)", color: "text-green-600" },
                        { name: "Valorant", value: "240+ FPS (High)", color: "text-blue-600" },
                        { name: "Cyberpunk", value: "60+ FPS (High)", color: "text-green-600" },
                        { name: "Live Streaming", value: "1080p 60FPS (Smooth)", color: "text-green-600" }
                    ],
                    high: [
                        { name: "GTA V", value: "140+ FPS (1440p)", color: "text-green-600" },
                        { name: "Valorant", value: "300+ FPS (High)", color: "text-blue-600" },
                        { name: "Cyberpunk", value: "80+ FPS (1440p)", color: "text-green-600" },
                        { name: "Live Streaming", value: "1080p/1440p (Pro)", color: "text-blue-600" }
                    ],
                    ultra: [
                        { name: "GTA V", value: "165+ FPS (4K)", color: "text-green-600" },
                        { name: "Valorant", value: "500+ FPS (High)", color: "text-blue-600" },
                        { name: "Cyberpunk", value: "100+ FPS (4K)", color: "text-green-600" },
                        { name: "Live Streaming", value: "4K / Multi-Stream", color: "text-purple-600" }
                    ]
                }
            },
            productivity: {
                label: "Workstation Software Capability",
                icon: '<i class="fa-solid fa-pen-ruler text-blue-600"></i>',
                metrics: {
                    integrated: [
                        { name: "Video Editing", value: "1080p Basic", color: "text-orange-600" },
                        { name: "Graphic Design", value: "Canva/Basic", color: "text-blue-600" },
                        { name: "3D Rendering", value: "Not Recommended", color: "text-red-600" },
                        { name: "Multitasking", value: "Basic", color: "text-orange-600" }
                    ],
                    entry: [
                        { name: "Video Editing", value: "1080p Smooth", color: "text-green-600" },
                        { name: "Graphic Design", value: "Photoshop (Fast)", color: "text-blue-600" },
                        { name: "3D Rendering", value: "Blender (Basic)", color: "text-orange-600" },
                        { name: "Multitasking", value: "Standard", color: "text-blue-600" }
                    ],
                    mid: [
                        { name: "Video Editing", value: "4K Editing", color: "text-green-600" },
                        { name: "Graphic Design", value: "Complex Vector", color: "text-blue-600" },
                        { name: "3D Rendering", value: "Blender Cycles", color: "text-green-600" },
                        { name: "Multitasking", value: "Heavy", color: "text-green-600" }
                    ],
                    high: [
                        { name: "Video Editing", value: "6K/RAW Editing", color: "text-green-600" },
                        { name: "Graphic Design", value: "Professional", color: "text-blue-600" },
                        { name: "3D Rendering", value: "Fast Rendering", color: "text-green-600" },
                        { name: "Multitasking", value: "Extreme", color: "text-purple-600" }
                    ],
                    ultra: [
                        { name: "Video Editing", value: "8K Cinema", color: "text-green-600" },
                        { name: "Graphic Design", value: "Industry Std", color: "text-blue-600" },
                        { name: "3D Rendering", value: "Studio Grade", color: "text-green-600" },
                        { name: "Multitasking", value: "Limitless", color: "text-purple-600" }
                    ]
                }
            },
            coding: {
                label: "Development Environment",
                icon: '<i class="fa-solid fa-code text-green-600"></i>',
                metrics: {
                    integrated: [
                        { name: "Web Dev", value: "HTML/JS (Fast)", color: "text-green-600" },
                        { name: "Virtualization", value: "Not Recommended", color: "text-red-600" },
                        { name: "IDE Speed", value: "VS Code (Good)", color: "text-blue-600" },
                        { name: "Local Server", value: "Simple", color: "text-orange-600" }
                    ],
                    entry: [
                        { name: "Web Dev", value: "Full Stack", color: "text-green-600" },
                        { name: "Virtualization", value: "1 Light VM", color: "text-orange-600" },
                        { name: "IDE Speed", value: "Standard", color: "text-blue-600" },
                        { name: "Local Server", value: "Standard", color: "text-blue-600" }
                    ],
                    mid: [
                        { name: "Web Dev", value: "Heavy Backend", color: "text-green-600" },
                        { name: "Virtualization", value: "Docker / 2 VMs", color: "text-green-600" },
                        { name: "Mobile Dev", value: "Android Studio", color: "text-blue-600" },
                        { name: "Local Server", value: "Docker Containers", color: "text-green-600" }
                    ],
                    high: [
                        { name: "Web Dev", value: "Enterprise", color: "text-green-600" },
                        { name: "Virtualization", value: "Multiple VMs", color: "text-green-600" },
                        { name: "Compilation", value: "Fast Compile", color: "text-blue-600" },
                        { name: "Local Server", value: "K8s Cluster", color: "text-purple-600" }
                    ],
                    ultra: [
                        { name: "Web Dev", value: "Server Load", color: "text-green-600" },
                        { name: "Virtualization", value: "Data Center Sim", color: "text-green-600" },
                        { name: "Compilation", value: "Instant", color: "text-blue-600" },
                        { name: "Local Server", value: "Data Center", color: "text-purple-600" }
                    ]
                }
            }
        };

        // --- 3. STATE & UI LOGIC ---
        let state = { formFactor: 'desktop', usage: 'gaming', budget: 50000, prefs: { cpu: 'Any', gpu: 'Any' }, currentBuild: null };

        function goHome() {
            document.getElementById('view-landing').classList.remove('hidden');
            document.getElementById('view-wizard').classList.add('hidden');
            document.getElementById('view-results').classList.add('hidden');
        }

        // Shopping Modal Functions
        function openShopModal(shopLinks, productName) {
            const modal = document.getElementById('shop-modal');
            const productNameEl = document.getElementById('shop-product-name');
            const linksContainer = document.getElementById('shop-links-container');
            
            productNameEl.textContent = productName;
            
            const stores = [
                { name: 'Amazon India', key: 'amazon', color: '#FF9900', icon: '🛒' },
                { name: 'Flipkart', key: 'flipkart', color: '#2874F0', icon: '🛍️' },
                { name: 'Reliance Digital', key: 'reliance', color: '#E42529', icon: '🏬' },
                { name: 'Croma', key: 'croma', color: '#8CC63F', icon: '🏪' },
                { name: 'Vijay Sales', key: 'vijay', color: '#FF6B00', icon: '🛒' },
                { name: 'MD Computers', key: 'mdcomputers', color: '#0066CC', icon: '💻' }
            ];
            
            let html = '';
            stores.forEach(store => {
                if (shopLinks && shopLinks[store.key]) {
                    html += `
                        <a href="${shopLinks[store.key]}" target="_blank" rel="noopener noreferrer" class="store-btn">
                            <div class="store-logo" style="background: ${store.color}; color: white;">
                                ${store.icon}
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-slate-800">${store.name}</div>
                                <div class="text-xs text-slate-500">Compare prices & deals</div>
                            </div>
                            <i class="fa-solid fa-arrow-right text-slate-400"></i>
                        </a>
                    `;
                }
            });
            
            linksContainer.innerHTML = html;
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        function closeShopModal(event) {
            if (!event || event.target.id === 'shop-modal') {
                const modal = document.getElementById('shop-modal');
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        function startWizard() {
            document.getElementById('view-landing').classList.add('hidden');
            document.getElementById('view-results').classList.add('hidden');
            document.getElementById('view-wizard').classList.remove('hidden');
            navWizard(1);
        }

        function navWizard(step) {
            document.querySelectorAll('.wizard-step').forEach(el => el.classList.add('hidden'));
            document.getElementById(`step-${step}`).classList.remove('hidden');
            document.getElementById('wiz-step-num').innerText = step;
            document.getElementById('wiz-progress').style.width = (step / 4 * 100) + '%';
        }

        function setFormFactor(ff) {
            state.formFactor = ff;
            document.getElementById('budget-type-text').innerText = ff === 'laptop' ? 'Laptop' : 'PC';
            navWizard(2);
        }

        function setUsage(u) {
            state.usage = u;
            navWizard(3);
        }

        function updateBudget(val) {
            const sanitized = Security.validateBudget(val);
            state.budget = parseInt(sanitized);
            document.getElementById('budget-val').innerText = state.budget.toLocaleString('en-IN');
        }

        function setPref(type, val) {
            // Validate inputs
            const validTypes = ['cpu', 'gpu'];
            const validValues = ['Intel', 'AMD', 'NVIDIA', 'Any'];
            
            if (!validTypes.includes(type) || !validValues.includes(val)) {
                console.error('Invalid preference');
                return;
            }
            
            state.prefs[type] = val;
            document.querySelectorAll(`#step-4 button[id^='btn-${type}']`).forEach(b => {
                b.classList.remove('bg-blue-50', 'border-blue-500', 'text-blue-700', 'font-bold');
                b.classList.add('border-gray-200');
            });
            const btn = document.getElementById(`btn-${type.toLowerCase()}-${val.toLowerCase()}`);
            if (btn) {
                btn.classList.add('bg-blue-50', 'border-blue-500', 'text-blue-700', 'font-bold');
                btn.classList.remove('border-gray-200');
            }
        }

        // --- 4. GENERATE BUILD ---
        async function generateBuild() {
            // Rate limiting
            if (!Security.rateLimit.check()) {
                alert('Please wait a moment before generating another build.');
                return;
            }
            
            await loadDb();
            
            if (!db) {
                alert('Database not loaded. Please try again.');
                return;
            }
            
            const { budget, prefs, usage, formFactor } = state;
            
            // Comprehensive input validation
            const validationErrors = [];
            
            if (!formFactor || !['laptop', 'desktop'].includes(formFactor)) {
                validationErrors.push('Invalid form factor selected');
            }
            
            const validUsages = ['gaming', 'productivity', 'coding', 'content'];
            if (!usage || !validUsages.includes(usage)) {
                validationErrors.push('Invalid usage type selected');
            }
            
            if (!budget || isNaN(budget)) {
                validationErrors.push('Invalid budget amount');
            } else if (budget < 15000) {
                validationErrors.push('Minimum budget is ₹15,000');
            } else if (budget > 10000000) {
                validationErrors.push('Maximum budget is ₹1,00,00,000');
            }
            
            if (validationErrors.length > 0) {
                alert('⚠️ Validation Error:\n\n' + validationErrors.join('\n'));
                return;
            }
            
            if (formFactor === 'laptop') {
                // Filter laptops within budget range (allow 5% over for better options)
                let potentialLaptops = db.laptops.filter(l => l.price <= budget * 1.05);
                if (potentialLaptops.length === 0) {
                    // If no laptops in budget, show closest options
                    potentialLaptops = db.laptops.filter(l => l.price <= budget * 1.2).slice(0, 3);
                    if (potentialLaptops.length === 0) potentialLaptops = db.laptops.slice(0, 3);
                }

                // Score laptops based on usage and specs
                let scoredLaptops = potentialLaptops.map(laptop => {
                    let score = 0;
                    
                    // Usage-based scoring
                    if (usage === 'gaming') {
                        if (laptop.type === 'gaming') score += 50;
                        if (laptop.gpuTier === 'high' || laptop.gpuTier === 'ultra') score += 30;
                        else if (laptop.gpuTier === 'mid') score += 20;
                        else if (laptop.gpuTier === 'entry') score += 10;
                        if (laptop.refresh && parseInt(laptop.refresh) >= 144) score += 15;
                    } else if (usage === 'productivity') {
                        if (laptop.type === 'office' || laptop.type === 'creative') score += 50;
                        if (laptop.ram && laptop.ram.includes('16GB')) score += 20;
                        if (laptop.ram && laptop.ram.includes('32GB')) score += 30;
                        if (laptop.storage && laptop.storage.includes('1TB')) score += 10;
                    } else if (usage === 'coding') {
                        if (laptop.type === 'office' || laptop.type === 'creative') score += 40;
                        if (laptop.ram && (laptop.ram.includes('16GB') || laptop.ram.includes('32GB'))) score += 25;
                        if (laptop.storage && laptop.storage.includes('SSD')) score += 15;
                        if (laptop.battery && parseInt(laptop.battery) >= 8) score += 10;
                    } else if (usage === 'content') {
                        if (laptop.type === 'creative') score += 50;
                        if (laptop.screen && laptop.screen.includes('OLED')) score += 20;
                        if (laptop.ram && laptop.ram.includes('32GB')) score += 15;
                    }
                    
                    // Budget efficiency scoring
                    const budgetUtilization = laptop.price / budget;
                    if (budgetUtilization >= 0.85 && budgetUtilization <= 1.0) score += 25;
                    else if (budgetUtilization >= 0.70 && budgetUtilization < 0.85) score += 15;
                    else if (budgetUtilization >= 0.50 && budgetUtilization < 0.70) score += 10;
                    
                    // Brand preference
                    if (prefs.gpu !== 'Any') {
                        if (laptop.brand === prefs.gpu) score += 10;
                    }
                    
                    return { ...laptop, aiScore: score };
                });

                // Sort by AI score, then by price
                scoredLaptops.sort((a, b) => {
                    if (Math.abs(a.aiScore - b.aiScore) > 10) return b.aiScore - a.aiScore;
                    return b.price - a.price;
                });
                
                let topPicks = scoredLaptops.slice(0, 3);

                state.currentBuild = { type: 'laptop', data: topPicks };
                const best = topPicks[0];
                
                // Generate intelligent reasoning
                let reasoning = `Based on your ${usage} requirements with a ₹${budget.toLocaleString('en-IN')} budget, `;
                reasoning += `our AI analyzed ${potentialLaptops.length} laptops and scored them on performance, value, and compatibility. `;
                reasoning += `The ${best.name} (Score: ${best.aiScore}/100) is our top recommendation because it offers `;
                if (usage === 'gaming') reasoning += `excellent gaming performance with ${best.spec}.`;
                else if (usage === 'productivity') reasoning += `outstanding productivity features and battery life for work.`;
                else if (usage === 'coding') reasoning += `perfect development specs with great RAM and storage.`;
                else reasoning += `the best overall value for your use case.`;
                
                document.getElementById('build-reasoning').innerText = reasoning;
                renderResults();
                return;
            }

            // DESKTOP LOGIC
            let cpu, gpu, mobo, ram, storage, psu, userCase;
            let buildReason = "";

            if (budget <= 20000) {
                cpu = db.cpus.find(c => c.name.includes('Athlon')) || db.cpus[0];
                gpu = db.gpus.find(g => g.price === 0); 
                mobo = db.mobos.find(m => m.socket === 'AM4' && m.price < 4000) || db.mobos[0];
                ram = db.ram.find(r => r.price < 1500) || db.ram[0]; 
                storage = db.storage[0]; 
                psu = db.psu[0];
                userCase = db.case[0];
                buildReason = "For this ultra-budget entry point, we used an AMD Athlon APU. It handles web browsing, movies, and office work perfectly for a very low cost.";
            }
            else if (budget < 45000) {
                cpu = db.cpus.find(c => c.name.includes('5600G')) || db.cpus[0];
                gpu = db.gpus.find(g => g.price === 0); 
                mobo = db.mobos.filter(m => m.socket === cpu.socket).sort((a,b) => a.price - b.price)[0];
                ram = db.ram.find(r => r.name.includes('8GB')) || db.ram[1]; 
                storage = db.storage[0];
                psu = db.psu[0];
                userCase = db.case[0];
                buildReason = "Given the tight budget, we selected a Processor with high-performance Integrated Graphics (APU). This allows you to game and work without buying an expensive graphics card right now.";
            } 
            else {
                // STANDARD LOGIC
                let gpuBudget = usage === 'gaming' ? budget * 0.45 : budget * 0.25;
                let cpuBudget = usage === 'productivity' ? budget * 0.30 : budget * 0.20;

                if (budget > 200000) {
                    gpuBudget = budget * 0.50;
                    cpuBudget = budget * 0.20;
                }
                if (budget > 400000) gpuBudget = 200000;

                // Smart CPU selection with workload optimization
                let cpuList = db.cpus.filter(c => {
                    const inBudget = c.price <= cpuBudget * 1.5 && c.price >= cpuBudget * 0.4;
                    const notApu = !c.integrated && !c.name.includes('Athlon');
                    return inBudget && notApu;
                });
                
                if(cpuList.length === 0) {
                    cpuList = db.cpus.filter(c => !c.integrated && !c.name.includes('Athlon'));
                }
                
                // Apply brand preference
                if(prefs.cpu !== 'Any') {
                    let filtered = cpuList.filter(c => c.brand === prefs.cpu);
                    if(filtered.length > 0) cpuList = filtered;
                }
                
                // Score CPUs based on usage
                let scoredCPUs = cpuList.map(c => {
                    let score = 0;
                    const cores = parseInt(c.cores || 0);
                    const price = c.price;
                    
                    // Core count scoring for different workloads
                    if (usage === 'content' || usage === 'productivity') {
                        if (cores >= 16) score += 35;
                        else if (cores >= 12) score += 30;
                        else if (cores >= 8) score += 20;
                        else if (cores >= 6) score += 10;
                    } else if (usage === 'gaming') {
                        if (cores >= 8) score += 30;
                        else if (cores >= 6) score += 25;
                        else if (cores >= 4) score += 15;
                    } else if (usage === 'coding') {
                        if (cores >= 12) score += 30;
                        else if (cores >= 8) score += 25;
                        else if (cores >= 6) score += 15;
                    }
                    
                    // Budget utilization score
                    const budgetRatio = price / cpuBudget;
                    if (budgetRatio >= 0.85 && budgetRatio <= 1.2) score += 25;
                    else if (budgetRatio >= 0.7 && budgetRatio < 0.85) score += 15;
                    else if (budgetRatio >= 0.5 && budgetRatio < 0.7) score += 10;
                    
                    return { ...c, cpuScore: score };
                });
                
                cpu = scoredCPUs.sort((a,b) => {
                    if (Math.abs(a.cpuScore - b.cpuScore) > 5) return b.cpuScore - a.cpuScore;
                    return b.price - a.price;
                })[0] || db.cpus[2];

                let gpuList = db.gpus.filter(g => {
                    const inBudget = g.price <= gpuBudget * 1.3 && g.price >= gpuBudget * 0.5 && g.price > 0;
                    return inBudget;
                });
                
                if(gpuList.length === 0) {
                    gpuList = db.gpus.filter(g => g.price > 0 && g.price <= gpuBudget * 1.5);
                }
                if(gpuList.length === 0) gpuList = db.gpus.filter(g => g.price > 0);
                
                // Apply brand preference
                if(prefs.gpu !== 'Any') {
                    let filtered = gpuList.filter(g => g.brand === prefs.gpu);
                    if(filtered.length > 0) gpuList = filtered;
                }
                
                // Score GPUs for optimal selection
                let scoredGPUs = gpuList.map(g => {
                    let score = 0;
                    const vram = parseInt(g.vram?.match(/\d+/)?.[0] || 0);
                    const price = g.price;
                    
                    // VRAM scoring based on usage
                    if (usage === 'gaming') {
                        if (vram >= 16) score += 35;
                        else if (vram >= 12) score += 30;
                        else if (vram >= 8) score += 20;
                        else if (vram >= 6) score += 15;
                        else if (vram >= 4) score += 10;
                    } else if (usage === 'content') {
                        if (vram >= 24) score += 40;
                        else if (vram >= 16) score += 35;
                        else if (vram >= 12) score += 25;
                        else if (vram >= 8) score += 15;
                    } else {
                        if (vram >= 8) score += 25;
                        else if (vram >= 6) score += 20;
                        else if (vram >= 4) score += 15;
                    }
                    
                    // Budget efficiency
                    const budgetRatio = price / gpuBudget;
                    if (budgetRatio >= 0.85 && budgetRatio <= 1.15) score += 30;
                    else if (budgetRatio >= 0.7 && budgetRatio < 0.85) score += 20;
                    else if (budgetRatio >= 0.5 && budgetRatio < 0.7) score += 10;
                    
                    return { ...g, gpuScore: score };
                });
                
                gpu = scoredGPUs.sort((a,b) => {
                    if (Math.abs(a.gpuScore - b.gpuScore) > 5) return b.gpuScore - a.gpuScore;
                    return b.price - a.price;
                })[0] || db.gpus[1];

                let validMobos = db.mobos.filter(m => m.socket === cpu.socket);
                validMobos.sort((a,b) => a.price - b.price); // Sort by price ascending
                
                if (budget > 300000) {
                    // High-end: pick top-tier boards
                    let highEnd = validMobos.filter(m => m.price > 25000);
                    mobo = highEnd[Math.floor(highEnd.length * 0.7)] || validMobos[validMobos.length - 1];
                } else if (budget > 150000) {
                    // Mid-range: 15k-30k boards
                    let midRange = validMobos.filter(m => m.price >= 15000 && m.price <= 30000);
                    mobo = midRange[Math.floor(midRange.length / 2)] || validMobos[Math.floor(validMobos.length / 2)];
                } else if (budget > 80000) {
                    // Budget: 8k-18k boards
                    let budgetRange = validMobos.filter(m => m.price >= 8000 && m.price <= 18000);
                    mobo = budgetRange[Math.floor(budgetRange.length / 3)] || validMobos[Math.floor(validMobos.length / 3)];
                } else {
                    // Very low budget: cheapest compatible boards
                    let lowBudget = validMobos.filter(m => m.price < 10000);
                    mobo = lowBudget[Math.floor(lowBudget.length / 2)] || validMobos[0];
                }

                // Smart RAM selection based on motherboard and usage
                let validRam = db.ram.filter(r => {
                    // Check DDR generation compatibility
                    if (mobo.name.includes('DDR5')) return r.name.includes('DDR5');
                    if (mobo.name.includes('DDR4')) return r.name.includes('DDR4');
                    return true;
                });
                if (validRam.length === 0) validRam = db.ram;
                
                // Determine optimal RAM based on usage
                let targetRamSize = '16GB';
                if (usage === 'content' || usage === 'productivity') {
                    if (budget > 250000) targetRamSize = '64GB';
                    else if (budget > 120000) targetRamSize = '32GB';
                    else targetRamSize = '16GB';
                } else if (usage === 'gaming') {
                    if (budget > 200000) targetRamSize = '32GB';
                    else targetRamSize = '16GB';
                } else {
                    if (budget > 300000) targetRamSize = '32GB';
                    else targetRamSize = '16GB';
                }
                
                // Find RAM matching target size with good speed
                let targetRam = validRam.filter(r => r.name.includes(targetRamSize));
                if (targetRam.length > 0) {
                    // Prefer higher speed RAM for gaming
                    if (usage === 'gaming') {
                        ram = targetRam.sort((a, b) => {
                            const speedA = parseInt(a.name.match(/\d{4,5}MHz/)?.[0] || 3200);
                            const speedB = parseInt(b.name.match(/\d{4,5}MHz/)?.[0] || 3200);
                            return speedB - speedA;
                        })[0];
                    } else {
                        // For other uses, balance speed and price
                        ram = targetRam.sort((a, b) => a.price - b.price)[Math.floor(targetRam.length / 2)];
                    }
                } else {
                    ram = validRam.sort((a, b) => b.price - a.price)[0];
                }
                if (ram.price < 1500) ram = validRam[1] || validRam[0];

                // Intelligent storage selection
                let targetCapacity = '500GB';
                let needSpeed = usage === 'gaming' || usage === 'content' || usage === 'coding';
                
                if (budget > 300000) targetCapacity = '2TB';
                else if (budget > 150000) targetCapacity = '1TB';
                else if (budget > 80000) targetCapacity = '500GB';
                else targetCapacity = '256GB';
                
                // Prioritize NVMe Gen4 for high-end, Gen3 for mid-range
                let storageOptions = db.storage.filter(s => {
                    const hasTargetCapacity = s.name.includes(targetCapacity);
                    if (needSpeed) {
                        if (budget > 200000) return hasTargetCapacity && s.name.includes('Gen4');
                        else if (budget > 80000) return hasTargetCapacity && s.name.includes('NVMe');
                        else return hasTargetCapacity && s.name.includes('SSD');
                    }
                    return hasTargetCapacity;
                });
                
                if (storageOptions.length === 0) {
                    storageOptions = db.storage.filter(s => s.name.includes(targetCapacity));
                }
                
                if (storageOptions.length > 0) {
                    // Choose mid-range option for best value
                    storage = storageOptions.sort((a, b) => a.price - b.price)[Math.floor(storageOptions.length / 2)] || storageOptions[0];
                } else {
                    storage = db.storage[2];
                }

                // Intelligent PSU selection based on component power draw
                let estimatedWattage = 100; // Base system
                
                // Add CPU TDP
                if (cpu.tdp) {
                    const cpuWatts = parseInt(cpu.tdp.match(/\d+/)?.[0] || 65);
                    estimatedWattage += cpuWatts;
                }
                
                // Add GPU TDP
                if (gpu.tdp) {
                    const gpuWatts = parseInt(gpu.tdp.match(/\d+/)?.[0] || 150);
                    estimatedWattage += gpuWatts;
                } else if (gpu.price > 80000) {
                    estimatedWattage += 400; // High-end GPU estimate
                } else if (gpu.price > 40000) {
                    estimatedWattage += 250;
                } else if (gpu.price > 20000) {
                    estimatedWattage += 150;
                }
                
                // Add 20% headroom for efficiency and future upgrades
                const recommendedWattage = Math.ceil(estimatedWattage * 1.2);
                
                // Select PSU with appropriate wattage
                let validPSUs = db.psu.filter(p => {
                    const psuWattage = parseInt(p.name.match(/\d+W/)?.[0] || 500);
                    return psuWattage >= recommendedWattage;
                });
                
                if (validPSUs.length === 0) validPSUs = db.psu;
                
                // Choose PSU based on budget and efficiency
                if (budget > 300000) {
                    psu = validPSUs.filter(p => p.name.includes('Platinum') || p.name.includes('Titanium')).sort((a,b) => b.price - a.price)[0] || validPSUs[Math.floor(validPSUs.length * 0.7)];
                } else if (budget > 150000) {
                    psu = validPSUs.filter(p => p.name.includes('Gold')).sort((a,b) => a.price - b.price)[Math.floor(validPSUs.filter(p => p.name.includes('Gold')).length / 2)] || validPSUs[Math.floor(validPSUs.length / 2)];
                } else {
                    psu = validPSUs.sort((a,b) => a.price - b.price)[Math.floor(validPSUs.length / 3)] || validPSUs[0];
                }

                if (budget > 350000) userCase = db.case[7];
                else if (budget > 200000) userCase = db.case[6];
                else if (budget > 100000) userCase = db.case[4];
                else userCase = db.case[2];

                // --- CRITICAL BUDGET CHECK & DOWNGRADE LOGIC ---
                let totalCost = cpu.price + gpu.price + mobo.price + ram.price + storage.price + psu.price + userCase.price;
                
                // If Over Budget, Downgrade GPU first (most expensive part usually)
                while (totalCost > budget) {
                    // Try downgrading GPU
                    let currentGpuIndex = db.gpus.findIndex(g => g.id === gpu.id);
                    if (currentGpuIndex > 1) { // Don't go below entry discrete
                        let nextGpu = db.gpus[currentGpuIndex - 1];
                        if (nextGpu.price < gpu.price) {
                            gpu = nextGpu;
                            totalCost = cpu.price + gpu.price + mobo.price + ram.price + storage.price + psu.price + userCase.price;
                            continue;
                        }
                    }
                    
                    // If GPU can't go lower or still over budget, try CPU
                    let currentCpuIndex = db.cpus.findIndex(c => c.id === cpu.id);
                    if (currentCpuIndex > 2) {
                         let nextCpu = db.cpus[currentCpuIndex - 1];
                         // Ensure socket compatibility matches mobo or re-pick mobo
                         if (nextCpu.socket === mobo.socket && nextCpu.price < cpu.price) {
                             cpu = nextCpu;
                             totalCost = cpu.price + gpu.price + mobo.price + ram.price + storage.price + psu.price + userCase.price;
                             continue;
                         }
                    }

                    // Last Resort: Downgrade RAM/Storage/Case to basic
                    if (ram.price > 2000) ram = validRam[0];
                    if (storage.price > 3000) storage = db.storage[0];
                    if (userCase.price > 2000) userCase = db.case[0];
                    
                    // Re-calc and break to avoid infinite loop if impossible
                    totalCost = cpu.price + gpu.price + mobo.price + ram.price + storage.price + psu.price + userCase.price;
                    break; 
                }

                // Generate intelligent build reasoning with validation
                let warnings = [];
                let highlights = [];
                
                // CPU-GPU balance check
                if (usage === 'gaming') {
                    const cpuGpuRatio = cpu.price / gpu.price;
                    if (cpuGpuRatio > 1.8) warnings.push('CPU is significantly more expensive than GPU - may not be optimal for gaming');
                    if (cpuGpuRatio < 0.25) warnings.push('GPU may experience bottleneck with this CPU at high resolutions');
                }
                
                // Power supply validation
                const psuWattage = parseInt(psu.name.match(/\d+W/)?.[0] || 500);
                const cpuTdp = parseInt(cpu.tdp?.match(/\d+/)?.[0] || 65);
                const gpuTdp = parseInt(gpu.tdp?.match(/\d+/)?.[0] || 150);
                const totalTdp = cpuTdp + gpuTdp + 100;
                if (psuWattage < totalTdp * 1.1) warnings.push('PSU may be close to limit under full load');
                
                // Highlight key features
                if (gpu.vram && parseInt(gpu.vram) >= 12) highlights.push(`${gpu.vram} VRAM for excellent gaming at high resolutions`);
                if (cpu.cores && parseInt(cpu.cores) >= 12) highlights.push(`${cpu.cores} cores for exceptional multitasking`);
                if (ram.name.includes('32GB') || ram.name.includes('64GB')) highlights.push(`${ram.name.match(/\d+GB/)?.[0]} RAM for professional workloads`);
                if (storage.name.includes('Gen4')) highlights.push('PCIe Gen4 NVMe for blazing fast storage');
                
                // Build comprehensive reasoning
                buildReason = `🎯 ${usage.charAt(0).toUpperCase() + usage.slice(1)} Build Complete!\n\n`;
                buildReason += `💻 Core Components:\n`;
                buildReason += `• CPU: ${cpu.name} (${cpu.cores || 'Multi'}-core${cpu.threads ? ', ' + cpu.threads + ' threads' : ''})\n`;
                buildReason += `• GPU: ${gpu.name} (${gpu.vram || 'Dedicated graphics'})\n`;
                buildReason += `• Motherboard: ${mobo.socket} socket with ${mobo.name.includes('DDR5') ? 'DDR5' : 'DDR4'} support\n\n`;
                
                if (usage === 'gaming') {
                    buildReason += `🎮 Gaming Performance:\n`;
                    if (gpu.vram) {
                        const vram = parseInt(gpu.vram);
                        if (vram >= 16) buildReason += `• Excellent 4K gaming with ray tracing\n`;
                        else if (vram >= 12) buildReason += `• Smooth 1440p-4K gaming experience\n`;
                        else if (vram >= 8) buildReason += `• Great 1080p-1440p gaming\n`;
                        else buildReason += `• Solid 1080p gaming performance\n`;
                    }
                } else if (usage === 'content') {
                    buildReason += `🎨 Content Creation:\n`;
                    buildReason += `• GPU-accelerated rendering and editing\n`;
                    buildReason += `• Multi-core CPU for fast exports\n`;
                } else if (usage === 'coding') {
                    buildReason += `👨‍💻 Development:\n`;
                    buildReason += `• Fast compilation with ${cpu.cores}+ cores\n`;
                    buildReason += `• Plenty of RAM for VMs and containers\n`;
                }
                
                if (highlights.length > 0) {
                    buildReason += `\n✨ Key Features:\n`;
                    highlights.forEach(h => buildReason += `• ${h}\n`);
                }
                
                buildReason += `\n⚡ Power: ${psu.name} (${psuWattage}W) provides ${Math.round((psuWattage/totalTdp - 1) * 100)}% power headroom\n`;
                buildReason += `💾 Storage: ${storage.name} for fast boot and load times\n`;
                buildReason += `\n💰 Total: ₹${totalCost.toLocaleString('en-IN')} (${((totalCost/budget)*100).toFixed(1)}% of budget)`;
                
                if (warnings.length > 0) {
                    buildReason += `\n\n⚠️ Notes:\n`;
                    warnings.forEach(w => buildReason += `• ${w}\n`);
                }
            }

            state.currentBuild = { type: 'desktop', data: { cpu, gpu, mobo, ram, storage, psu, userCase } };
            document.getElementById('build-reasoning').innerText = buildReason;
            renderResults();
        }

        // --- 5. RENDER FUNCTIONS ---
        function renderResults() {
            const container = document.getElementById('parts-container');
            const res = state.currentBuild;

            document.getElementById('view-wizard').classList.add('hidden');
            document.getElementById('view-results').classList.remove('hidden');
            document.getElementById('res-usage').innerText = state.usage;
            document.getElementById('res-budget').innerHTML = '<span style="font-size: 0.9em; opacity: 0.9;">₹</span>' + state.budget.toLocaleString('en-IN');

            renderBenchmarks(res);
            
            // Show 3D viewer for desktop builds
            const btn3D = document.getElementById('btn-3d-toggle');
            if (res.type === 'desktop') {
                document.getElementById('pc-3d-section').style.display = 'block';
                if (btn3D) btn3D.style.display = 'flex';
                setTimeout(() => {
                    init3DViewer();
                }, 100);
            } else {
                document.getElementById('pc-3d-section').style.display = 'none';
                if (btn3D) btn3D.style.display = 'none';
            }

            if (res.type === 'laptop') {
                const laptops = res.data;
                document.getElementById('total-price').innerText = "Multiple Options";
                
                let html = '<div class="grid grid-cols-1 md:grid-cols-3 gap-6 p-6">';
                laptops.forEach((laptop, index) => {
                    const borderClass = index === 0 ? 'border-blue-500 ring-2 ring-blue-500/20' : 'border-slate-200';
                    const badge = index === 0 ? '<div class="absolute top-4 right-4 bg-blue-600 text-white px-3 py-1 rounded-full text-xs font-bold">Top Pick</div>' : '';

                    html += `
                    <div class="bg-white rounded-xl border ${borderClass} shadow-sm p-6 relative flex flex-col h-full hover:shadow-md transition">
                        ${badge}
                        <div class="text-center mb-4">
                            <i class="fa-solid fa-laptop text-4xl text-slate-400 mb-4"></i>
                            <h3 class="font-bold text-slate-800 text-lg leading-tight mb-1">${laptop.name}</h3>
                            <span class="text-xs font-bold text-blue-600 uppercase tracking-wider">${laptop.type} Class</span>
                        </div>
                        <div class="flex-1 space-y-3 mb-6">
                             <div class="bg-slate-50 p-3 rounded-lg text-sm text-slate-600">
                                <span class="block text-xs font-bold text-slate-400 uppercase">Specs</span>
                                ${laptop.spec}
                             </div>
                             <div class="bg-slate-50 p-3 rounded-lg text-sm text-slate-600">
                                <span class="block text-xs font-bold text-slate-400 uppercase">Est. Price</span>
                                <span style="font-size: 0.8em; opacity: 0.8;">₹</span>${laptop.price.toLocaleString('en-IN')}
                             </div>
                        </div>
                        <button onclick='openShopModal(${JSON.stringify(laptop.shopLinks)}, "${laptop.name.replace(/'/g, "\\'")}")' class="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 rounded-lg font-bold text-sm hover:from-blue-700 hover:to-purple-700 transition shadow-md hover:shadow-lg"><i class="fa-solid fa-store text-lg"></i> Compare & Buy</button>
                    </div>`;
                });
                html += '</div>';
                container.innerHTML = html;
            } else {
                const b = res.data;
                const total = Object.values(b).reduce((acc, part) => acc + part.price, 0);
                document.getElementById('total-price').innerHTML = '<span style="font-size: 0.7em; opacity: 0.8;">₹</span>' + total.toLocaleString('en-IN');

                const parts = [
                    { type: 'CPU', icon: 'fa-microchip', data: b.cpu },
                    { type: 'GPU', icon: 'fa-display', data: b.gpu },
                    { type: 'Motherboard', icon: 'fa-chess-board', data: b.mobo },
                    { type: 'Memory', icon: 'fa-memory', data: b.ram },
                    { type: 'Storage', icon: 'fa-hard-drive', data: b.storage },
                    { type: 'Power Supply', icon: 'fa-plug', data: b.psu },
                    { type: 'Case', icon: 'fa-box', data: b.userCase },
                ];

                let html = '';
                parts.forEach(p => {
                    html += `
                    <div class="flex items-center gap-4 p-4 border-b border-slate-100 last:border-0 hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 transition-all duration-300 rounded-lg group">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-100 to-purple-100 rounded-lg flex items-center justify-center text-blue-600 text-xl group-hover:scale-110 transition-transform">
                            <i class="fa-solid ${p.icon}"></i>
                        </div>
                        <div class="flex-1">
                            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">${p.type}</div>
                            <div class="font-bold text-slate-800 text-lg">${p.data.name}</div>
                            ${p.type === 'Motherboard' ? `<div class="text-xs text-green-600 mt-1"><i class="fa-solid fa-check-circle"></i> Socket Match: ${p.data.socket}</div>` : ''}
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-lg ${p.data.price === 0 ? 'text-green-600' : 'text-slate-800'}">
                                ${p.data.price === 0 ? '<span class="flex items-center gap-1"><i class="fa-solid fa-gift"></i> Included</span>' : '<span class="text-green-600" style="font-size: 14px;">₹</span>' + p.data.price.toLocaleString('en-IN')}
                            </div>
                            ${p.data.price > 0 && p.data.shopLinks ? '<button onclick=\'openShopModal(' + JSON.stringify(p.data.shopLinks) + ', "' + p.data.name.replace(/'/g, "\\'") + '")\' class="inline-flex items-center gap-1 text-xs text-blue-600 font-bold hover:text-blue-700 mt-1 bg-blue-50 px-3 py-1 rounded-full hover:bg-blue-100 transition"><i class="fa-solid fa-store"></i> Compare & Buy</button>' : ''}
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
            }
        }

        function renderBenchmarks(res) {
            let tier = 'integrated';
            if (res.type === 'laptop') {
                tier = res.data[0].gpuTier || 'integrated';
            } else {
                tier = res.data.gpu.tier || 'integrated';
            }

            const usageType = state.usage; 
            const categoryData = PERFORMANCE_METRICS[usageType] || PERFORMANCE_METRICS.gaming;
            const metricsList = categoryData.metrics[tier] || categoryData.metrics.integrated;

            document.getElementById('perf-icon').innerHTML = categoryData.icon;
            document.getElementById('perf-title').innerHTML = categoryData.label + ' <i class="fa-solid fa-chart-line ml-2 text-sm"></i>';

            const container = document.getElementById('benchmark-cards');
            container.innerHTML = '';

            metricsList.forEach(metric => {
                container.innerHTML += `
                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm text-center">
                        <div class="font-bold text-slate-800 mb-1">${metric.name}</div>
                        <div class="text-2xl font-black ${metric.color}">${metric.value}</div>
                    </div>`;
            });
        }

        // --- 6. CHAT FUNCTIONS ---
        function toggleAI() {
            document.getElementById('ai-chat-panel').classList.toggle('translate-y-[120%]');
        }

        function toggleLiveSupport() {
            document.getElementById('live-support-panel').classList.toggle('hidden');
        }

        function handleChat(e) {
            if (e.key === 'Enter') sendMessage();
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const rawText = input.value.trim();
            if(!rawText) return;

            // Sanitize input
            const txt = Security.sanitizeHTML(rawText).toLowerCase();
            
            // Rate limiting
            if (!Security.rateLimit.check()) {
                addChatMsg('Please wait a moment before sending another message.', 'ai');
                return;
            }

            addChatMsg(rawText, 'user');
            input.value = '';

            // Show typing indicator
            const typingId = addTypingIndicator();

            setTimeout(() => {
                removeTypingIndicator(typingId);
                const response = generateIntelligentResponse(txt, rawText);
                addChatMsg(response, 'ai');
            }, 600 + Math.random() * 400); // Natural typing delay
        }

        function generateIntelligentResponse(txt, originalText) {
            // Context-aware AI response system with pattern matching
            
            // Greetings
            if (/\b(hello|hi|hey|greetings)\b/.test(txt)) {
                return "👋 Hi! I'm PCSensei AI, your computer building expert. I can help you with:\n• Budget recommendations\n• Component compatibility\n• Performance expectations\n• Upgrade suggestions\n\nWhat would you like to know?";
            }

            // Budget-related queries
            if (/budget|price|cost|afford|spend|money|expensive|cheap/i.test(txt)) {
                const budgetMatch = txt.match(/(\d+)k|\u20b9\s*(\d+)|rs\s*(\d+)/);
                if (budgetMatch) {
                    const amount = (parseInt(budgetMatch[1] || budgetMatch[2] || budgetMatch[3]) || 50) * 1000;
                    if (amount < 20000) {
                        return `💰 For ₹${amount.toLocaleString('en-IN')}, I recommend:\n• Laptop: Entry-level Chromebook or used ThinkPad\n• Desktop: AMD Athlon APU build (no discrete GPU)\n\nThis budget is best for basic tasks like browsing and office work.`;
                    } else if (amount < 50000) {
                        return `💰 With ₹${amount.toLocaleString('en-IN')}, you can get:\n• Laptop: AMD Ryzen 5 with Vega graphics\n• Desktop: AMD 5600G APU (integrated graphics)\n\n✨ Good for 1080p gaming at medium settings and productivity work.`;
                    } else if (amount < 100000) {
                        return `💰 At ₹${amount.toLocaleString('en-IN')}, excellent options:\n• Laptop: Gaming laptop with RTX 4050/4060\n• Desktop: Ryzen 5/i5 + RTX 4060\n\n🎮 Ideal for 1080p-1440p gaming and content creation!`;
                    } else {
                        return `💰 With ₹${amount.toLocaleString('en-IN')}+, you're in enthusiast territory!\n• High-end CPU: Ryzen 7/9 or i7/i9\n• GPU: RTX 4070+ or RX 7800 XT+\n• Fast DDR5 RAM and Gen4 NVMe\n\n🚀 Perfect for 4K gaming, streaming, and professional work!`;
                    }
                }
                
                if (state.budget) {
                    return `💰 Your current budget is ₹${state.budget.toLocaleString('en-IN')}.\n\nFor optimal builds, I recommend:\n🎮 Gaming: 40% GPU, 22% CPU\n🎨 Content: 30% GPU, 25% CPU\n💼 Productivity: 20% GPU, 28% CPU\n\nWant specific component recommendations?`;
                }
                
                return "💰 Budget allocation tips:\n• Gaming: Prioritize GPU (40% of budget)\n• Content Creation: Balance CPU & GPU (25-30% each)\n• Productivity: Focus on CPU & RAM (28% CPU)\n• Always leave 10-15% for PSU, storage, and case\n\nWhat's your target budget?";
            }

            // Component compatibility
            if (/compatib|work.*together|match|fit|socket|support/i.test(txt)) {
                if (state.currentBuild && state.currentBuild.type === 'desktop') {
                    const build = state.currentBuild.data;
                    return `✅ Compatibility Check for your build:\n\n🔌 CPU-Mobo: ${build.cpu.socket} socket - ✓ Compatible\n💾 RAM-Mobo: DDR${build.mobo.name.includes('DDR5') ? '5' : '4'} - ✓ Compatible\n⚡ PSU: ${build.psu.name} - ✓ Adequate for components\n📦 All components fit standard ATX cases\n\nEverything looks good! Any specific concerns?`;
                }
                return "🔍 To check compatibility, I need to know:\n• CPU socket type (AM4, AM5, LGA1700, etc.)\n• Motherboard chipset\n• RAM generation (DDR4/DDR5)\n• PSU wattage vs. component TDP\n\nGenerate a build first, or tell me your components!";
            }

            // Performance queries
            if (/fps|frame.*rate|perform|benchmark|how.*fast|speed|run/i.test(txt)) {
                if (txt.includes('4k') || txt.includes('2160p')) {
                    return "🎮 4K Gaming Performance:\n• RTX 4080+: 60-120 FPS (AAA titles)\n• RTX 4070 Ti: 50-80 FPS (high settings)\n• RTX 4060 Ti: 30-50 FPS (medium settings)\n\nPair with Ryzen 7/i7+ to avoid bottlenecks!\n\nBudget needed: ₹1,50,000+";
                } else if (txt.includes('1440p')) {
                    return "🎮 1440p Gaming Performance:\n• RTX 4070: 100-144 FPS (AAA titles)\n• RTX 4060 Ti: 80-120 FPS (high settings)\n• RTX 4060: 60-90 FPS (medium-high)\n\nSweet spot for price-performance!\n\nBudget: ₹80,000-₹1,50,000";
                } else {
                    return "🎮 1080p Gaming Performance:\n• RTX 4060: 120-200+ FPS (most games)\n• RTX 4050: 80-120 FPS (high settings)\n• GTX 1650: 50-80 FPS (medium settings)\n\nAll paired with Ryzen 5/i5 or better.\n\nBudget: ₹50,000-₹1,00,000";
                }
            }

            // Specific component queries - GPU
            if (/gpu|graphics.*card|rtx|gtx|radeon|rx|vram|video.*card/i.test(txt)) {
                if (/4090/i.test(txt)) {
                    return "🚀 RTX 4090 - The Absolute Beast!\n• VRAM: 24GB GDDR6X\n• Performance: 4K gaming at 120+ FPS\n• Price: ₹1,70,000 - ₹2,00,000\n• TDP: 450W (needs 850W+ PSU)\n\n⚠️ Pair with Ryzen 9 7950X or i9-14900K to avoid bottlenecks!";
                } else if (/4080/i.test(txt)) {
                    return "💎 RTX 4080 - Enthusiast Powerhouse\n• VRAM: 16GB GDDR6X\n• Performance: 4K @ 100+ FPS, 1440p @ 165+ FPS\n• Price: ₹1,10,000 - ₹1,30,000\n• TDP: 320W (needs 750W+ PSU)\n\n✨ Best for 4K gaming without breaking the bank!";
                } else if (/4070/i.test(txt)) {
                    return "⭐ RTX 4070/4070 Ti - Sweet Spot\n• VRAM: 12GB GDDR6X\n• Performance: 1440p @ 120+ FPS, 4K @ 60+ FPS\n• Price: ₹55,000 - ₹75,000\n• TDP: 200-285W (needs 650W PSU)\n\n🎯 Perfect balance of price and performance!";
                } else if (/4060/i.test(txt)) {
                    return "🎮 RTX 4060/4060 Ti - Value King\n• VRAM: 8GB/16GB GDDR6\n• Performance: 1080p @ 144+ FPS, 1440p @ 80+ FPS\n• Price: ₹32,000 - ₹48,000\n• TDP: 160-170W (needs 550W PSU)\n\n💰 Best value for 1080p-1440p gaming!";
                } else if (/amd|radeon|rx/i.test(txt)) {
                    return "🔴 AMD Radeon Options:\n• RX 7900 XTX: Competes with RTX 4080 (₹95k-₹1.1L)\n• RX 7800 XT: Between 4070-4070 Ti (₹50k-₹60k)\n• RX 7600: Entry 1080p gaming (₹25k-₹30k)\n\n✨ Great value, excellent rasterization, more VRAM!\n⚠️ Ray tracing not as strong as NVIDIA.";
                } else {
                    return "🎮 GPU Selection Guide:\n\n💎 Budget:\n• ₹25k-₹35k: RTX 4060, RX 7600 (1080p)\n• ₹40k-₹60k: RTX 4060 Ti, RX 7700 XT (1440p)\n• ₹65k-₹90k: RTX 4070 Ti, RX 7800 XT (1440p-4K)\n• ₹1L+: RTX 4080/4090 (4K ultra)\n\n🎯 Gaming: Prioritize VRAM (8GB min, 12GB+ ideal)\n🎨 Content: 12GB+ for rendering\n\nWhat's your budget and resolution target?";
                }
            }

            // Specific component queries - CPU
            if (/cpu|processor|ryzen|intel|core.*i[3579]|thread|clock.*speed/i.test(txt)) {
                if (/gaming/i.test(txt)) {
                    return "🎮 Gaming CPU Recommendations:\n\n⭐ Best: Ryzen 7 7800X3D (₹35k-₹40k)\n• 8 cores, 3D V-Cache = best gaming CPU\n\n💎 Great: i5-14600K or Ryzen 5 7600X (₹25k-₹30k)\n• 6 cores sufficient for most games\n\n💰 Budget: i3-13100F or Ryzen 5 5600 (₹8k-₹12k)\n• Solid 1080p gaming performance\n\n🔑 Gaming needs: 6+ cores, high single-thread speed";
                } else if (/content|render|edit|stream/i.test(txt)) {
                    return "🎨 Content Creation CPU Recommendations:\n\n🚀 Pro: Ryzen 9 7950X or i9-14900K (₹45k-₹60k)\n• 16-24 cores for fast rendering\n\n⭐ Great: Ryzen 7 7700X or i7-14700K (₹30k-₹40k)\n• 8-12 cores, excellent multitasking\n\n💰 Budget: Ryzen 5 7600 (₹18k-₹22k)\n• 6 cores, good for light editing\n\n🔑 Content needs: More cores = faster exports!";
                } else {
                    return "💻 CPU Selection Guide:\n\n🎮 Gaming: 6-8 cores, high clock speed\n• Ryzen 7800X3D, i5-14600K\n\n🎨 Content: 12-16 cores, multi-thread\n• Ryzen 9 7950X, i9-14900K\n\n💼 Productivity: 8-12 cores, balanced\n• Ryzen 7 7700X, i7-14700K\n\n💰 Budget: 4-6 cores\n• Ryzen 5 5600, i3-13100F\n\nWhat's your primary use case?";
                }
            }

            // RAM queries
            if (/ram|memory|ddr4|ddr5|gb.*ram|how.*much.*ram/i.test(txt)) {
                return "🧠 RAM Recommendations:\n\n🎮 Gaming:\n• 16GB DDR4/DDR5 (minimum)\n• 32GB for AAA titles + multitasking\n• 3200MHz+ DDR4 or 5600MHz+ DDR5\n\n🎨 Content Creation:\n• 32GB minimum (4K editing)\n• 64GB for heavy projects\n• Speed matters less, capacity first\n\n💼 Productivity:\n• 16GB for office work\n• 32GB for VMs/development\n\n💰 Prices:\n• 16GB DDR4: ₹3k-₹5k\n• 32GB DDR5: ₹10k-₹15k";
            }

            // Storage queries
            if (/ssd|nvme|storage|hard.*drive|hdd|gen4|m\.2/i.test(txt)) {
                return "💾 Storage Recommendations:\n\n⚡ Best: PCIe Gen4 NVMe SSD\n• 7000+ MB/s read speeds\n• WD Black SN850X, Samsung 990 Pro\n• ₹6k-₹10k for 1TB\n\n✨ Great: PCIe Gen3 NVMe SSD\n• 3500+ MB/s, excellent value\n• WD Blue SN570, Samsung 980\n• ₹4k-₹6k for 1TB\n\n💰 Budget: SATA SSD\n• 550 MB/s, still way better than HDD\n• ₹2.5k-₹4k for 1TB\n\n📊 Capacity:\n• 500GB: OS + few games\n• 1TB: Recommended minimum\n• 2TB: Ideal for large game libraries";
            }

            // PSU queries
            if (/psu|power.*supply|watt|efficiency|80.*plus|gold|platinum/i.test(txt)) {
                if (state.currentBuild && state.currentBuild.type === 'desktop') {
                    const build = state.currentBuild.data;
                    const cpuTdp = parseInt(build.cpu.tdp?.match(/\d+/)?.[0] || 65);
                    const gpuTdp = parseInt(build.gpu.tdp?.match(/\d+/)?.[0] || 150);
                    const totalTdp = cpuTdp + gpuTdp + 100;
                    const recommended = Math.ceil(totalTdp * 1.2);
                    
                    return `⚡ PSU Analysis for Your Build:\n\n📊 Power Requirements:\n• CPU: ${cpuTdp}W\n• GPU: ${gpuTdp}W\n• System: 100W\n• Total: ${totalTdp}W\n\n✅ Recommended: ${recommended}W+ (20% headroom)\n\n🏆 Quality:\n• 80+ Gold: Best value\n• 80+ Platinum: High efficiency\n• Brands: Corsair, Seasonic, EVGA\n\nCurrent PSU: ${build.psu.name}`;
                }
                
                return "⚡ PSU Selection Guide:\n\n🎯 Wattage:\n• Budget build: 450-550W\n• Mid-range: 650-750W\n• High-end: 850W+\n• RTX 4090: 1000W+\n\n🏆 Efficiency:\n• 80+ Bronze: Basic\n• 80+ Gold: Best value ⭐\n• 80+ Platinum: High efficiency\n\n💡 Rule: (CPU TDP + GPU TDP + 100W) × 1.2\n\n✅ Trusted Brands:\nCorsair, Seasonic, EVGA, Cooler Master";
            }

            // Laptop specific queries
            if (/laptop|notebook|portable|mobile/i.test(txt)) {
                if (/gaming.*laptop|laptop.*gaming/i.test(txt)) {
                    return "🎮 Gaming Laptop Guide:\n\n💎 Premium (₹1.5L+):\n• RTX 4070+, 165Hz screen\n• ASUS ROG, MSI Raider, Legion 7\n\n⭐ Mid-Range (₹80k-₹1.5L):\n• RTX 4060, 144Hz screen\n• Legion 5, TUF A15, Nitro 5\n\n💰 Budget (₹50k-₹80k):\n• RTX 4050/3050, 120Hz\n• Victus, IdeaPad Gaming\n\n🔑 Must-haves:\n• 144Hz+ display\n• 16GB RAM (upgradeable)\n• Good cooling system";
                } else if (/productivity|work|office/i.test(txt)) {
                    return "💼 Productivity Laptop Guide:\n\n🏆 Premium (₹1L+):\n• ThinkPad X1, Dell XPS, MacBook Air M2\n• 16GB+ RAM, 512GB+ SSD\n• 10+ hour battery\n\n⭐ Mid-Range (₹50k-₹1L):\n• ThinkPad E/T series, HP EliteBook\n• 8-16GB RAM, good keyboard\n\n💰 Budget (₹30k-₹50k):\n• IdeaPad, Inspiron, VivoBook\n• 8GB RAM, basic needs\n\n🔑 Priorities:\n• Battery life > Performance\n• Build quality matters\n• Good keyboard & trackpad";
                } else {
                    return "💻 Laptop vs Desktop:\n\n✅ Choose Laptop if:\n• Need portability\n• College/travel frequently\n• Limited desk space\n\n✅ Choose Desktop if:\n• Gaming/heavy work\n• Need upgradability\n• Better price-performance\n\n🎮 Gaming: Desktop = 30-40% better value\n💼 Work: Laptop = better flexibility\n\nWhat's your priority? Performance or portability?";
                }
            }

            // Build review/help
            if (/review|check|suggest|recommend|help.*build|good.*build/i.test(txt)) {
                if (state.currentBuild) {
                    if (state.currentBuild.type === 'laptop') {
                        const best = state.currentBuild.data[0];
                        return `📊 Your Laptop Selection Analysis:\n\n✅ Top Pick: ${best.name}\n• Price: ₹${best.price.toLocaleString('en-IN')}\n• Usage: ${state.usage}\n• Specs: ${best.spec}\n\n${best.aiScore ? `🎯 AI Score: ${best.aiScore}/100` : ''}\n\n💡 This laptop ${best.aiScore > 80 ? 'is an excellent match' : 'fits your needs well'} for ${state.usage} tasks!\n\nWant alternatives or have specific questions?`;
                    } else {
                        const build = state.currentBuild.data;
                        return `📊 Your Desktop Build Analysis:\n\n✅ Components:\n• CPU: ${build.cpu.name}\n• GPU: ${build.gpu.name}\n• RAM: ${build.ram.name}\n• Storage: ${build.storage.name}\n\n🎯 Usage: ${state.usage}\n💰 Budget: ₹${state.budget.toLocaleString('en-IN')}\n\n✨ This build is optimized for ${state.usage} with balanced performance!\n\nNeed component upgrades or have compatibility questions?`;
                    }
                }
                return "🤔 I can help you build the perfect PC!\n\n1️⃣ Tell me your budget (₹50,000? ₹1,00,000?)\n2️⃣ What's your use case? (Gaming, editing, work?)\n3️⃣ Any brand preferences? (Intel/AMD, NVIDIA/AMD)\n\nOr use the wizard above to generate a build, then I can review it for you!";
            }

            // Upgrade queries
            if (/upgrade|improve|better|replace|swap/i.test(txt)) {
                return "⬆️ Upgrade Priority Guide:\n\n🎮 Gaming PC:\n1. GPU (biggest FPS boost)\n2. CPU (if bottlenecking)\n3. RAM (16GB → 32GB)\n4. Storage (HDD → SSD)\n\n🎨 Content Creation:\n1. RAM (32GB → 64GB)\n2. CPU (more cores)\n3. Storage (larger/faster SSD)\n4. GPU (rendering acceleration)\n\n💡 General Rule:\n• Upgrade GPU every 3-4 years\n• CPU every 5-6 years\n• RAM/Storage as needed\n\nWhat component are you thinking of upgrading?";
            }

            // Thanks/goodbye
            if (/thank|thanks|appreciate|bye|goodbye/i.test(txt)) {
                return "😊 You're welcome! Happy building!\n\nFeel free to ask if you have more questions. Good luck with your new PC! 🚀";
            }

            // Generic game-specific queries
            if (/fortnite|pubg|valorant|apex|warzone|gta|cyberpunk|minecraft/i.test(txt)) {
                const game = txt.match(/fortnite|pubg|valorant|apex|warzone|gta|cyberpunk|minecraft/i)?.[0];
                const specs = {
                    fortnite: { gpu: 'RTX 4050+', cpu: 'Ryzen 5/i5', ram: '16GB', budget: '₹60k+' },
                    valorant: { gpu: 'RTX 4050', cpu: 'Ryzen 5/i5', ram: '8GB', budget: '₹50k+' },
                    cyberpunk: { gpu: 'RTX 4070+', cpu: 'Ryzen 7/i7', ram: '16GB', budget: '₹1.2L+' },
                    gta: { gpu: 'RTX 4060', cpu: 'Ryzen 5/i5', ram: '16GB', budget: '₹75k+' },
                    minecraft: { gpu: 'RTX 4050', cpu: 'Ryzen 5/i5', ram: '8GB', budget: '₹45k+' },
                    warzone: { gpu: 'RTX 4060', cpu: 'Ryzen 5/i5', ram: '16GB', budget: '₹80k+' },
                };
                
                const spec = specs[game.toLowerCase()] || { gpu: 'RTX 4060', cpu: 'Ryzen 5/i5', ram: '16GB', budget: '₹70k+' };
                
                return `🎮 ${game.charAt(0).toUpperCase() + game.slice(1)} Requirements:\n\n📊 Recommended:\n• GPU: ${spec.gpu}\n• CPU: ${spec.cpu}\n• RAM: ${spec.ram}\n• Budget: ${spec.budget}\n\n✨ For 1080p 144fps+ at high settings!\n\nWant a specific build for this game?`;
            }

            // Fallback with helpful suggestions
            return "🤔 I'm not sure I understood that completely.\n\n💡 I can help with:\n• 💰 Budget recommendations\n• 🔧 Component selection (CPU, GPU, RAM, etc.)\n• 🎮 Gaming performance estimates\n• ✅ Compatibility checking\n• ⬆️ Upgrade suggestions\n• 💻 Laptop recommendations\n\nTry asking:\n• \"What GPU for ₹50k?\"\n• \"Is my build compatible?\"\n• \"Can it run Cyberpunk?\"\n• \"Should I upgrade my CPU?\"";
        }

        function addTypingIndicator() {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            const id = 'typing-' + Date.now();
            div.id = id;
            div.className = 'flex gap-2 chat-msg';
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 text-xs">
                    <i class="fa-solid fa-robot"></i>
                </div>
                <div class="bg-white border-slate-100 p-3 rounded-2xl rounded-tl-none shadow-sm text-sm border flex gap-1 items-center">
                    <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                    <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                    <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                </div>
            `;
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
            return id;
        }

        function removeTypingIndicator(id) {
            const indicator = document.getElementById(id);
            if (indicator) indicator.remove();
        }

        function addChatMsg(text, sender) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = `flex gap-2 chat-msg ${sender === 'user' ? 'flex-row-reverse' : ''}`;
            const icon = sender === 'ai' 
                ? '<div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 text-xs"><i class="fa-solid fa-robot"></i></div>' 
                : '<div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-xs"><i class="fa-solid fa-user"></i></div>';
            
            // Sanitize text for display
            const safeText = Security.sanitizeHTML(text);
            const formattedText = safeText.replace(/\n/g, '<br>');
            
            const bubble = `<div class="${sender === 'ai' ? 'bg-white border-slate-100 text-slate-700' : 'bg-blue-600 text-white'} p-3 rounded-2xl ${sender === 'ai' ? 'rounded-tl-none' : 'rounded-tr-none'} shadow-sm text-sm max-w-[80%] border whitespace-pre-line">${formattedText}</div>`;
            div.innerHTML = icon + bubble;
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
        }

        // --- 7. 3D VISUALIZATION SYSTEM ---
        let scene, camera, renderer, pcCase, components = {};
        let isRotating = false;
        let rotationSpeed = 0;

        function init3DViewer() {
            const container = document.getElementById('pc-3d-viewer');
            if (!container || !THREE) return;

            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2e);
            
            // Camera setup
            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(3, 2, 5);
            camera.lookAt(0, 0, 0);
            
            // Renderer setup
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            const pointLight1 = new THREE.PointLight(0x4a90e2, 0.5);
            pointLight1.position.set(-3, 2, 3);
            scene.add(pointLight1);
            
            const pointLight2 = new THREE.PointLight(0x9b59b6, 0.5);
            pointLight2.position.set(3, 2, -3);
            scene.add(pointLight2);
            
            // Create PC case (main structure)
            createPCCase();
            
            // Create components based on build
            if (state.currentBuild && state.currentBuild.type === 'desktop') {
                createComponents(state.currentBuild.data);
            }
            
            // Add grid floor for reference
            const gridHelper = new THREE.GridHelper(10, 10, 0x444444, 0x222222);
            gridHelper.position.y = -1.5;
            scene.add(gridHelper);
            
            // Mouse controls
            let isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };
            
            container.addEventListener('mousedown', (e) => {
                isDragging = true;
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });
            
            container.addEventListener('mousemove', (e) => {
                if (isDragging && pcCase) {
                    const deltaX = e.clientX - previousMousePosition.x;
                    const deltaY = e.clientY - previousMousePosition.y;
                    
                    pcCase.rotation.y += deltaX * 0.01;
                    pcCase.rotation.x += deltaY * 0.01;
                    
                    // Limit X rotation
                    pcCase.rotation.x = Math.max(-Math.PI / 4, Math.min(Math.PI / 4, pcCase.rotation.x));
                    
                    previousMousePosition = { x: e.clientX, y: e.clientY };
                }
            });
            
            container.addEventListener('mouseup', () => {
                isDragging = false;
            });
            
            container.addEventListener('mouseleave', () => {
                isDragging = false;
            });
            
            // Zoom with mouse wheel
            container.addEventListener('wheel', (e) => {
                e.preventDefault();
                camera.position.z += e.deltaY * 0.01;
                camera.position.z = Math.max(3, Math.min(10, camera.position.z));
            });
            
            // Handle window resize
            window.addEventListener('resize', () => {
                if (container.clientWidth > 0) {
                    camera.aspect = container.clientWidth / container.clientHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(container.clientWidth, container.clientHeight);
                }
            });
            
            // Start animation loop
            animate3D();
        }

        function createPCCase() {
            pcCase = new THREE.Group();
            
            // Case body (tempered glass effect)
            const caseGeometry = new THREE.BoxGeometry(2, 3, 2);
            const caseMaterial = new THREE.MeshPhysicalMaterial({
                color: 0x1a1a1a,
                metalness: 0.9,
                roughness: 0.1,
                transparent: true,
                opacity: 0.3,
                side: THREE.DoubleSide
            });
            const caseBody = new THREE.Mesh(caseGeometry, caseMaterial);
            caseBody.castShadow = true;
            caseBody.receiveShadow = true;
            
            // Case frame (metal edges)
            const edgeGeometry = new THREE.EdgesGeometry(caseGeometry);
            const edgeMaterial = new THREE.LineBasicMaterial({ color: 0x888888, linewidth: 2 });
            const edges = new THREE.LineSegments(edgeGeometry, edgeMaterial);
            
            pcCase.add(caseBody);
            pcCase.add(edges);
            
            // Front panel (with RGB strip effect)
            const frontPanelGeometry = new THREE.BoxGeometry(1.9, 0.1, 0.05);
            const frontPanelMaterial = new THREE.MeshStandardMaterial({
                color: 0x2c3e50,
                metalness: 0.8,
                roughness: 0.2,
                emissive: 0x3498db,
                emissiveIntensity: 0.3
            });
            const frontPanel = new THREE.Mesh(frontPanelGeometry, frontPanelMaterial);
            frontPanel.position.set(0, -1.4, 1);
            pcCase.add(frontPanel);
            
            // RGB LED strip
            const rgbGeometry = new THREE.BoxGeometry(1.8, 0.05, 0.02);
            const rgbMaterial = new THREE.MeshStandardMaterial({
                color: 0x00ff00,
                emissive: 0x00ff00,
                emissiveIntensity: 1
            });
            const rgbStrip = new THREE.Mesh(rgbGeometry, rgbMaterial);
            rgbStrip.position.set(0, 1.3, 1.01);
            pcCase.add(rgbStrip);
            components.rgbStrip = rgbStrip; // Save for animation
            
            scene.add(pcCase);
        }

        function createComponents(build) {
            // Clear existing components
            Object.keys(components).forEach(key => {
                if (key !== 'rgbStrip' && components[key]) {
                    pcCase.remove(components[key]);
                }
            });
            
            // Motherboard (large flat board)
            const moboGeometry = new THREE.BoxGeometry(1.6, 0.05, 1.6);
            const moboMaterial = new THREE.MeshStandardMaterial({
                color: 0x2ecc71,
                metalness: 0.5,
                roughness: 0.5
            });
            const mobo = new THREE.Mesh(moboGeometry, moboMaterial);
            mobo.position.set(0, -0.5, 0);
            mobo.rotation.x = Math.PI / 2;
            pcCase.add(mobo);
            components.mobo = mobo;
            
            // CPU (small square on motherboard)
            const cpuGeometry = new THREE.BoxGeometry(0.4, 0.15, 0.4);
            const cpuMaterial = new THREE.MeshStandardMaterial({
                color: 0x3498db,
                metalness: 0.9,
                roughness: 0.1
            });
            const cpu = new THREE.Mesh(cpuGeometry, cpuMaterial);
            cpu.position.set(0, -0.4, 0);
            pcCase.add(cpu);
            components.cpu = cpu;
            
            // CPU cooler (fan on top)
            const coolerGeometry = new THREE.CylinderGeometry(0.3, 0.3, 0.4, 32);
            const coolerMaterial = new THREE.MeshStandardMaterial({
                color: 0x95a5a6,
                metalness: 0.7,
                roughness: 0.3
            });
            const cooler = new THREE.Mesh(coolerGeometry, coolerMaterial);
            cooler.position.set(0, 0, 0);
            pcCase.add(cooler);
            components.cooler = cooler;
            
            // GPU (large card)
            const gpuGeometry = new THREE.BoxGeometry(1.2, 0.3, 0.15);
            const gpuMaterial = new THREE.MeshStandardMaterial({
                color: 0x9b59b6,
                metalness: 0.8,
                roughness: 0.2,
                emissive: 0x9b59b6,
                emissiveIntensity: 0.2
            });
            const gpu = new THREE.Mesh(gpuGeometry, gpuMaterial);
            gpu.position.set(0, -0.7, 0.3);
            gpu.rotation.y = Math.PI / 2;
            pcCase.add(gpu);
            components.gpu = gpu;
            
            // RAM sticks (2 vertical sticks)
            const ramGeometry = new THREE.BoxGeometry(0.1, 0.6, 0.15);
            const ramMaterial = new THREE.MeshStandardMaterial({
                color: 0xe74c3c,
                metalness: 0.6,
                roughness: 0.4
            });
            
            for (let i = 0; i < 2; i++) {
                const ram = new THREE.Mesh(ramGeometry, ramMaterial);
                ram.position.set(0.4 + i * 0.2, -0.1, -0.5);
                pcCase.add(ram);
                components[`ram${i}`] = ram;
            }
            
            // Storage (M.2 SSD - small flat rectangle)
            const storageGeometry = new THREE.BoxGeometry(0.6, 0.03, 0.15);
            const storageMaterial = new THREE.MeshStandardMaterial({
                color: 0xf39c12,
                metalness: 0.7,
                roughness: 0.3
            });
            const storage = new THREE.Mesh(storageGeometry, storageMaterial);
            storage.position.set(-0.3, -0.45, 0.6);
            storage.rotation.x = Math.PI / 2;
            pcCase.add(storage);
            components.storage = storage;
            
            // PSU (power supply at bottom)
            const psuGeometry = new THREE.BoxGeometry(1.4, 0.4, 0.7);
            const psuMaterial = new THREE.MeshStandardMaterial({
                color: 0x34495e,
                metalness: 0.9,
                roughness: 0.1
            });
            const psu = new THREE.Mesh(psuGeometry, psuMaterial);
            psu.position.set(0, -1.2, -0.4);
            pcCase.add(psu);
            components.psu = psu;
            
            // Fans (case fans)
            const fanGeometry = new THREE.CylinderGeometry(0.25, 0.25, 0.05, 32);
            const fanMaterial = new THREE.MeshStandardMaterial({
                color: 0x7f8c8d,
                metalness: 0.5,
                roughness: 0.5,
                transparent: true,
                opacity: 0.7
            });
            
            // Front fan
            const fan1 = new THREE.Mesh(fanGeometry, fanMaterial);
            fan1.position.set(0.5, 0.5, 1);
            fan1.rotation.x = Math.PI / 2;
            pcCase.add(fan1);
            components.fan1 = fan1;
            
            // Top fan
            const fan2 = new THREE.Mesh(fanGeometry, fanMaterial);
            fan2.position.set(-0.5, 1.45, 0);
            pcCase.add(fan2);
            components.fan2 = fan2;
        }

        function animate3D() {
            requestAnimationFrame(animate3D);
            
            if (pcCase && isRotating) {
                pcCase.rotation.y += rotationSpeed;
            }
            
            // Animate RGB strip color
            if (components.rgbStrip) {
                const time = Date.now() * 0.001;
                const hue = (time * 0.1) % 1;
                components.rgbStrip.material.color.setHSL(hue, 1, 0.5);
                components.rgbStrip.material.emissive.setHSL(hue, 1, 0.5);
            }
            
            // Rotate fans
            if (components.fan1) components.fan1.rotation.z += 0.1;
            if (components.fan2) components.fan2.rotation.y += 0.1;
            if (components.cooler) components.cooler.rotation.y += 0.05;
            
            renderer.render(scene, camera);
        }

        function toggle3DView() {
            const section = document.getElementById('pc-3d-section');
            const btn = document.getElementById('btn-3d-toggle');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                if (btn) btn.innerHTML = '<i class="fa-solid fa-eye-slash"></i> Hide 3D View';
                if (!renderer) init3DViewer();
            } else {
                section.style.display = 'none';
                if (btn) btn.innerHTML = '<i class="fa-solid fa-cube"></i> View in 3D';
            }
        }

        function rotate3DView(direction) {
            if (!pcCase) return;
            
            isRotating = true;
            rotationSpeed = direction === 'left' ? -0.02 : 0.02;
            
            setTimeout(() => {
                isRotating = false;
                rotationSpeed = 0;
            }, 1000);
        }

        function reset3DView() {
            if (!pcCase) return;
            
            // Smooth reset animation
            const startRotation = { x: pcCase.rotation.x, y: pcCase.rotation.y };
            const duration = 500;
            const startTime = Date.now();
            
            function animateReset() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeProgress = 1 - Math.pow(1 - progress, 3); // ease-out cubic
                
                pcCase.rotation.x = startRotation.x * (1 - easeProgress);
                pcCase.rotation.y = startRotation.y * (1 - easeProgress);
                
                if (progress < 1) {
                    requestAnimationFrame(animateReset);
                }
            }
            
            animateReset();
            
            // Reset camera
            camera.position.set(3, 2, 5);
        }

        // Show component labels on hover
        function showComponentLabel(componentName) {
            const label = document.getElementById(`label-${componentName}`);
            if (label) {
                label.classList.add('active');
                setTimeout(() => label.classList.remove('active'), 2000);
            }
        }
    </script>
</body>
</html>