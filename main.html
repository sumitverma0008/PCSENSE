<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>PCSensei | Intelligent PC & Laptop Consultant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXX"
            crossorigin="anonymous"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            dark: '#0f172a',
                            accent: '#3b82f6',
                            glass: 'rgba(15, 23, 42, 0.8)'
                        }
                    },
                    animation: {
                        'slide-up': 'slideUp 0.5s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }
        .dark-glass {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        .ad-container {
            margin: 20px auto;
            text-align: center;
            min-height: 100px;
            background: rgba(248, 250, 252, 0.5);
            border-radius: 8px;
            padding: 10px;
            border: 1px dashed rgba(203, 213, 225, 0.5);
        }
        .ad-label {
            font-size: 10px;
            color: #94a3b8;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .shop-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            animation: fadeIn 0.2s ease-out;
        }
        .shop-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }
        .store-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            transition: all 0.2s;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
        }
        .store-btn:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
            transform: translateX(4px);
        }
        .store-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .chat-msg {
            animation: slideUp 0.3s ease-out;
        }
        
        /* Enhanced hover effects */
        button, a {
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        /* Currency styling */
        .price-value {
            font-variant-numeric: tabular-nums;
        }
        
        /* Improved responsive design */
        @media (max-width: 640px) {
            #ai-chat-panel {
                width: calc(100vw - 32px);
                right: 16px;
                left: 16px;
            }
            
            .glass-panel {
                backdrop-filter: blur(8px);
            }
            
            h2, h3 {
                font-size: 1.5rem;
            }
        }
        
        @media (max-width: 768px) {
            .max-w-7xl {
                padding-left: 1rem;
                padding-right: 1rem;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans selection:bg-blue-200">

    <!-- Navbar -->
    <nav class="fixed w-full z-50 glass-panel shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2 cursor-pointer" onclick="goHome()">
                    <div class="w-10 h-10 bg-brand-dark rounded-lg flex items-center justify-center text-blue-400">
                        <i class="fa-solid fa-cube text-xl"></i>
                    </div>
                    <span class="font-bold text-xl tracking-tight text-slate-900">PCSensei</span>
                </div>
                
                <div class="hidden md:flex space-x-8 items-center">
                    <a href="#" onclick="goHome()" class="text-slate-600 hover:text-blue-600 transition font-medium">Home</a>
                    <a href="#builder" onclick="startWizard()" class="text-slate-600 hover:text-blue-600 transition font-medium">Builder</a>
                    <a href="admin.html" class="text-slate-600 hover:text-blue-600 transition font-medium flex items-center gap-1">
                        <i class="fa-solid fa-user-shield"></i> Admin
                    </a>
                    <div class="h-6 w-px bg-slate-300"></div>
                    <button onclick="toggleLiveSupport()" class="flex items-center gap-2 text-green-600 font-bold hover:text-green-700 transition">
                        <span class="relative flex h-3 w-3">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                        </span>
                        Talk to Expert
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="pt-16 min-h-screen relative">
        
        <!-- View: Landing Page -->
        <div id="view-landing" class="block">
            <div class="relative bg-slate-900 h-[600px] overflow-hidden">
                <div class="absolute inset-0">
                    <img src="https://images.unsplash.com/photo-1593640408182-31c70c8268f5?auto=format&fit=crop&q=80" class="w-full h-full object-cover opacity-20">
                    <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/80 to-transparent"></div>
                </div>
                
                <div class="relative max-w-7xl mx-auto px-4 pt-24 text-center text-white">
                    <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-emerald-500/10 border border-emerald-500/30 text-emerald-400 text-sm font-medium mb-6">
                        <i class="fa-solid fa-bolt"></i> Trusted by 10,000+ PC Builders in India
                    </div>
                    <h1 class="text-4xl md:text-6xl font-extrabold tracking-tight mb-6">
                        Stop Overpaying for PCs.<br>
                        <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">Build Smarter, Save More.</span>
                    </h1>
                    <p class="text-xl text-slate-300 max-w-3xl mx-auto mb-4">
                        Whether you're a gamer chasing 144 FPS, a creator rendering 4K videos, or a student on a tight budget — we've helped thousands find their perfect setup.
                    </p>
                    <p class="text-md text-slate-400 max-w-2xl mx-auto mb-8">
                        <i class="fa-solid fa-indian-rupee-sign"></i> Builds from ₹15,000 to ₹5,00,000+ • <i class="fa-solid fa-shop"></i> Compare prices across Amazon, Flipkart, Croma & more • <i class="fa-solid fa-clock"></i> Updated daily
                    </p>
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button onclick="showModeSelection()" class="px-8 py-4 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 rounded-xl font-bold text-lg transition shadow-lg shadow-blue-500/25 flex items-center justify-center gap-2 transform hover:scale-105">
                            <i class="fa-solid fa-rocket"></i> Get Started
                        </button>
                        <button onclick="toggleAI()" class="px-8 py-4 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl font-bold text-lg transition backdrop-blur-sm flex items-center justify-center gap-2 transform hover:scale-105">
                            <i class="fa-solid fa-comments"></i> Chat with Expert
                        </button>
                    </div>
                    <div class="mt-8 flex items-center justify-center gap-6 text-sm text-slate-400">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-check-circle text-green-400"></i> No signup required</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-check-circle text-green-400"></i> 100% free</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-check-circle text-green-400"></i> Works in 30 seconds</span>
                    </div>
                </div>
            </div>

            <!-- Ad: Top Banner (After Hero) -->
            <div class="max-w-7xl mx-auto px-4 py-6">
                <div class="ad-container">
                    <div class="ad-label">Advertisement</div>
                    <!-- Google AdSense Banner Ad (728x90 or Responsive) -->
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-XXXXXXXXXX"
                         data-ad-slot="XXXXXXXXXX"
                         data-ad-format="horizontal"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
            </div>

            <!-- Features Grid -->
            <div class="py-16 max-w-7xl mx-auto px-4">
                <div class="text-center mb-12">
                    <h2 class="text-3xl font-bold text-slate-800 mb-4">Why 10,000+ Indians Trust PCSensei</h2>
                    <p class="text-slate-500 max-w-2xl mx-auto">We've spent years understanding the Indian PC market — from Nehru Place deals to Amazon sales. Here's what makes us different.</p>
                </div>
                <div class="grid md:grid-cols-3 gap-8">
                    <div class="p-6 rounded-2xl bg-white border border-slate-200 shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all duration-300">
                        <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center text-xl mb-4"><i class="fa-solid fa-gauge-high"></i></div>
                        <h3 class="text-xl font-bold mb-2">Real Performance Numbers</h3>
                        <p class="text-slate-500 mb-4">No vague promises. We show you actual FPS estimates for GTA V, Valorant, Cyberpunk — games you actually play.</p>
                        <ul class="text-sm text-slate-600 space-y-1">
                            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-500"></i> Benchmark-based estimates</li>
                            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-500"></i> 1080p, 1440p & 4K presets</li>
                            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-500"></i> Productivity scores too</li>
                        </ul>
                    </div>
                    <div class="p-6 rounded-2xl bg-white border border-slate-200 shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all duration-300">
                        <div class="w-12 h-12 bg-purple-100 text-purple-600 rounded-lg flex items-center justify-center text-xl mb-4"><i class="fa-solid fa-indian-rupee-sign"></i></div>
                        <h3 class="text-xl font-bold mb-2">Indian Prices, Updated Daily</h3>
                        <p class="text-slate-500 mb-4">We track prices across 6 major Indian retailers. No outdated MRP or US pricing — just what you'll actually pay.</p>
                        <ul class="text-sm text-slate-600 space-y-1">
                            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-500"></i> Amazon, Flipkart, Croma</li>
                            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-500"></i> MD Computers, Vijay Sales</li>
                            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-500"></i> Reliance Digital</li>
                        </ul>
                    </div>
                    <div class="p-6 rounded-2xl bg-white border border-slate-200 shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all duration-300">
                        <div class="w-12 h-12 bg-emerald-100 text-emerald-600 rounded-lg flex items-center justify-center text-xl mb-4"><i class="fa-solid fa-headset"></i></div>
                        <h3 class="text-xl font-bold mb-2">Expert Help, Not Chatbots</h3>
                        <p class="text-slate-500 mb-4">Confused about DDR4 vs DDR5? Bottlenecks? Our experts have built 500+ PCs and actually know their stuff.</p>
                        <ul class="text-sm text-slate-600 space-y-1">
                            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-500"></i> Instant chat support</li>
                            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-500"></i> Build reviews & troubleshooting</li>
                            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-500"></i> Upgrade advice</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- How It Works Section -->
            <div class="py-16 bg-slate-50">
                <div class="max-w-7xl mx-auto px-4">
                    <div class="text-center mb-12">
                        <h2 class="text-3xl font-bold text-slate-800 mb-4">How It Works</h2>
                        <p class="text-slate-500">Get your perfect PC recommendation in under 60 seconds. No tech knowledge required.</p>
                    </div>
                    <div class="grid md:grid-cols-4 gap-6">
                        <div class="text-center">
                            <div class="w-16 h-16 bg-blue-600 text-white rounded-full flex items-center justify-center text-2xl font-bold mx-auto mb-4">1</div>
                            <h4 class="font-bold text-slate-800 mb-2">Pick Your Type</h4>
                            <p class="text-sm text-slate-500">Desktop for power, laptop for portability. We optimize differently for each.</p>
                        </div>
                        <div class="text-center">
                            <div class="w-16 h-16 bg-blue-600 text-white rounded-full flex items-center justify-center text-2xl font-bold mx-auto mb-4">2</div>
                            <h4 class="font-bold text-slate-800 mb-2">Tell Us Your Use</h4>
                            <p class="text-sm text-slate-500">Gaming? Video editing? Coding? Each needs different specs — we know exactly what.</p>
                        </div>
                        <div class="text-center">
                            <div class="w-16 h-16 bg-blue-600 text-white rounded-full flex items-center justify-center text-2xl font-bold mx-auto mb-4">3</div>
                            <h4 class="font-bold text-slate-800 mb-2">Set Your Budget</h4>
                            <p class="text-sm text-slate-500">From ₹15K student builds to ₹5L dream machines. We make every rupee count.</p>
                        </div>
                        <div class="text-center">
                            <div class="w-16 h-16 bg-green-600 text-white rounded-full flex items-center justify-center text-2xl font-bold mx-auto mb-4"><i class="fa-solid fa-check"></i></div>
                            <h4 class="font-bold text-slate-800 mb-2">Get Your Build</h4>
                            <p class="text-sm text-slate-500">Instant recommendation with buy links, performance estimates, and expert reasoning.</p>
                        </div>
                    </div>
                    <div class="text-center mt-10">
                        <button onclick="startWizard()" class="px-8 py-4 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold text-lg transition shadow-lg shadow-blue-500/25">
                            Start Now — It's Free <i class="fa-solid fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Trust Indicators -->
            <div class="py-12 bg-white border-y border-slate-200">
                <div class="max-w-7xl mx-auto px-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-8 text-center">
                        <div>
                            <div class="text-4xl font-bold text-blue-600 mb-1">800+</div>
                            <div class="text-sm text-slate-500">Components in Database</div>
                        </div>
                        <div>
                            <div class="text-4xl font-bold text-blue-600 mb-1">6</div>
                            <div class="text-sm text-slate-500">Indian Retailers Tracked</div>
                        </div>
                        <div>
                            <div class="text-4xl font-bold text-blue-600 mb-1">24hr</div>
                            <div class="text-sm text-slate-500">Price Update Frequency</div>
                        </div>
                        <div>
                            <div class="text-4xl font-bold text-blue-600 mb-1">₹15K-5L</div>
                            <div class="text-sm text-slate-500">Budget Range Supported</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- View: Mode Selection -->
        <div id="view-mode-selection" class="hidden min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-purple-900 flex items-center justify-center py-20 px-4">
            <div class="max-w-6xl mx-auto">
                <div class="text-center mb-12">
                    <h2 class="text-4xl md:text-5xl font-extrabold text-white mb-4">Choose Your Path</h2>
                    <p class="text-xl text-slate-300">How would you like to build your PC today?</p>
                </div>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- AI Wizard Mode -->
                    <div class="group relative bg-white/10 backdrop-blur-lg border-2 border-white/20 rounded-3xl p-8 hover:border-blue-400 hover:bg-white/15 transition-all duration-300 cursor-pointer transform hover:scale-105 hover:shadow-2xl" onclick="startWizard()">
                        <div class="absolute top-4 right-4 bg-green-500 text-white px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1">
                            <i class="fa-solid fa-star"></i> Recommended
                        </div>
                        <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center text-4xl text-white mb-6 group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-wand-magic-sparkles"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-white mb-3">AI Wizard</h3>
                        <p class="text-slate-300 mb-6">Answer 4 quick questions and let our AI recommend the perfect build for you. Best for beginners and those who want expert guidance.</p>
                        <ul class="space-y-2 text-sm text-slate-200 mb-6">
                            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-400"></i> Budget-optimized recommendations</li>
                            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-400"></i> AI-powered component matching</li>
                            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-400"></i> Performance estimates included</li>
                            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-400"></i> Takes ~30 seconds</li>
                        </ul>
                        <div class="bg-blue-600 group-hover:bg-blue-500 text-white px-6 py-3 rounded-xl font-bold text-center transition flex items-center justify-center gap-2">
                            Start Wizard <i class="fa-solid fa-arrow-right"></i>
                        </div>
                    </div>

                    <!-- Custom Builder Mode -->
                    <div class="group relative bg-white/10 backdrop-blur-lg border-2 border-white/20 rounded-3xl p-8 hover:border-purple-400 hover:bg-white/15 transition-all duration-300 cursor-pointer transform hover:scale-105 hover:shadow-2xl" onclick="startCustomBuilder()">
                        <div class="absolute top-4 right-4 bg-purple-500 text-white px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1">
                            <i class="fa-solid fa-hammer"></i> Advanced
                        </div>
                        <div class="w-20 h-20 bg-gradient-to-br from-purple-500 to-pink-600 rounded-2xl flex items-center justify-center text-4xl text-white mb-6 group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-sliders"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-white mb-3">Custom Builder</h3>
                        <p class="text-slate-300 mb-6">Handpick every component yourself. Perfect for enthusiasts who know exactly what they want or want to experiment.</p>
                        <ul class="space-y-2 text-sm text-slate-200 mb-6">
                            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-400"></i> Full control over components</li>
                            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-400"></i> Browse 800+ parts catalog</li>
                            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-400"></i> Real-time price tracking</li>
                            <li class="flex items-center gap-2"><i class="fa-solid fa-check text-green-400"></i> Compatibility validation</li>
                        </ul>
                        <div class="bg-purple-600 group-hover:bg-purple-500 text-white px-6 py-3 rounded-xl font-bold text-center transition flex items-center justify-center gap-2">
                            Build Custom PC <i class="fa-solid fa-arrow-right"></i>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-8">
                    <button onclick="goHome()" class="text-white/70 hover:text-white transition flex items-center justify-center gap-2 mx-auto">
                        <i class="fa-solid fa-arrow-left"></i> Back to Home
                    </button>
                </div>
            </div>
        </div>

        <!-- View: Custom Builder -->
        <div id="view-custom-builder" class="hidden min-h-screen bg-slate-100 py-12">
            <div class="max-w-7xl mx-auto px-4">
                <div class="mb-8 flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-800 mb-2">Custom PC Builder</h2>
                        <p class="text-slate-600">Select each component manually to build your dream PC</p>
                    </div>
                    <button onclick="goHome()" class="text-slate-600 hover:text-slate-800 transition flex items-center gap-2 px-4 py-2 border border-slate-300 rounded-lg hover:bg-white">
                        <i class="fa-solid fa-arrow-left"></i> Back
                    </button>
                </div>

                <div class="grid lg:grid-cols-3 gap-8">
                    <!-- Component Selection Panel -->
                    <div class="lg:col-span-2 space-y-6">
                        
                        <!-- CPU Selection -->
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                    <i class="fa-solid fa-microchip text-blue-600"></i> Processor (CPU)
                                </h3>
                                <span class="text-xs text-slate-500" id="cpu-count">0 options</span>
                            </div>
                            <select id="select-cpu" onchange="selectComponent('cpu', this.value)" class="w-full border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Choose a CPU...</option>
                            </select>
                            <div id="cpu-details" class="mt-3 text-sm text-slate-600 hidden"></div>
                        </div>

                        <!-- GPU Selection -->
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                    <i class="fa-solid fa-display text-purple-600"></i> Graphics Card (GPU)
                                </h3>
                                <span class="text-xs text-slate-500" id="gpu-count">0 options</span>
                            </div>
                            <select id="select-gpu" onchange="selectComponent('gpu', this.value)" class="w-full border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                <option value="">Choose a GPU...</option>
                            </select>
                            <div id="gpu-details" class="mt-3 text-sm text-slate-600 hidden"></div>
                        </div>

                        <!-- Motherboard Selection -->
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                    <i class="fa-solid fa-memory text-green-600"></i> Motherboard
                                </h3>
                                <span class="text-xs text-slate-500" id="mobo-count">0 options</span>
                            </div>
                            <select id="select-mobo" onchange="selectComponent('mobo', this.value)" class="w-full border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                <option value="">Choose a Motherboard...</option>
                            </select>
                            <div id="mobo-details" class="mt-3 text-sm text-slate-600 hidden"></div>
                        </div>

                        <!-- RAM Selection -->
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                    <i class="fa-solid fa-memory text-orange-600"></i> RAM Memory
                                </h3>
                                <span class="text-xs text-slate-500" id="ram-count">0 options</span>
                            </div>
                            <select id="select-ram" onchange="selectComponent('ram', this.value)" class="w-full border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                <option value="">Choose RAM...</option>
                            </select>
                            <div id="ram-details" class="mt-3 text-sm text-slate-600 hidden"></div>
                        </div>

                        <!-- Storage Selection -->
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                    <i class="fa-solid fa-hard-drive text-indigo-600"></i> Storage (SSD/HDD)
                                </h3>
                                <span class="text-xs text-slate-500" id="storage-count">0 options</span>
                            </div>
                            <select id="select-storage" onchange="selectComponent('storage', this.value)" class="w-full border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">Choose Storage...</option>
                            </select>
                            <div id="storage-details" class="mt-3 text-sm text-slate-600 hidden"></div>
                        </div>

                        <!-- PSU Selection -->
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                    <i class="fa-solid fa-bolt text-yellow-600"></i> Power Supply (PSU)
                                </h3>
                                <span class="text-xs text-slate-500" id="psu-count">0 options</span>
                            </div>
                            <select id="select-psu" onchange="selectComponent('psu', this.value)" class="w-full border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500">
                                <option value="">Choose PSU...</option>
                            </select>
                            <div id="psu-details" class="mt-3 text-sm text-slate-600 hidden"></div>
                        </div>

                        <!-- Case Selection -->
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                    <i class="fa-solid fa-box text-slate-600"></i> PC Case
                                </h3>
                                <span class="text-xs text-slate-500" id="case-count">0 options</span>
                            </div>
                            <select id="select-case" onchange="selectComponent('case', this.value)" class="w-full border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-slate-500 focus:border-slate-500">
                                <option value="">Choose Case...</option>
                            </select>
                            <div id="case-details" class="mt-3 text-sm text-slate-600 hidden"></div>
                        </div>

                    </div>

                    <!-- Build Summary Sidebar -->
                    <div class="lg:col-span-1">
                        <div class="sticky top-24">
                            <div class="bg-white rounded-xl border border-slate-200 shadow-lg p-6">
                                <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                                    <i class="fa-solid fa-clipboard-check text-blue-600"></i> Your Build
                                </h3>
                                
                                <div class="space-y-3 mb-6" id="custom-build-list">
                                    <div class="text-sm text-slate-500 text-center py-8 border-2 border-dashed border-slate-200 rounded-lg">
                                        <i class="fa-solid fa-cube text-3xl text-slate-300 mb-2"></i>
                                        <p>Start selecting components</p>
                                    </div>
                                </div>

                                <div class="border-t border-slate-200 pt-4 mb-4">
                                    <div class="flex justify-between items-center text-lg font-bold">
                                        <span class="text-slate-700">Total Price</span>
                                        <span class="text-blue-600 price-value" id="custom-total-price">₹0</span>
                                    </div>
                                </div>

                                <div id="compatibility-warnings" class="mb-4 hidden">
                                    <div class="bg-red-50 border border-red-200 rounded-lg p-3 text-sm text-red-700">
                                        <i class="fa-solid fa-exclamation-triangle"></i> <span id="warning-text"></span>
                                    </div>
                                </div>

                                <button onclick="viewCustomBuildSummary()" id="btn-view-custom-build" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white px-6 py-3 rounded-xl font-bold transition transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none" disabled>
                                    <i class="fa-solid fa-eye"></i> View Build Summary
                                </button>
                                
                                <button onclick="clearCustomBuild()" class="w-full mt-3 bg-slate-100 hover:bg-slate-200 text-slate-700 px-6 py-2 rounded-lg font-medium transition">
                                    <i class="fa-solid fa-trash"></i> Clear All
                                </button>
                            </div>

                            <div class="mt-6 bg-blue-50 border border-blue-200 rounded-xl p-4 text-sm text-blue-800">
                                <div class="font-bold mb-2 flex items-center gap-2">
                                    <i class="fa-solid fa-lightbulb"></i> Pro Tips
                                </div>
                                <ul class="space-y-1 text-xs">
                                    <li>• Match CPU socket with motherboard</li>
                                    <li>• PSU wattage = (CPU TDP + GPU TDP) × 1.5</li>
                                    <li>• 16GB RAM minimum for gaming</li>
                                    <li>• SSD for OS, HDD for storage</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- View: Wizard -->
        <div id="view-wizard" class="hidden min-h-[80vh] bg-slate-100 py-12">
            <div class="max-w-3xl mx-auto px-4">
                <div class="mb-8 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-slate-800">Configuration Wizard</h2>
                    <div class="text-sm text-slate-500">Step <span id="wiz-step-num">1</span> of 4</div>
                </div>
                
                <!-- Progress Bar -->
                <div class="w-full bg-slate-200 h-2 rounded-full mb-8">
                    <div id="wiz-progress" class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: 25%"></div>
                </div>

                <div class="bg-white rounded-2xl shadow-xl p-8 animate-slide-up relative overflow-hidden">
                    
                    <!-- Step 1: Form Factor -->
                    <div id="step-1" class="wizard-step">
                        <h3 class="text-xl font-bold mb-6">What type of computer do you need?</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <button onclick="setFormFactor('desktop')" class="p-8 border-2 border-slate-100 hover:border-blue-500 rounded-2xl text-center hover:bg-blue-50 transition group">
                                <i class="fa-solid fa-desktop text-5xl text-slate-300 group-hover:text-blue-600 mb-4 transition"></i>
                                <div class="font-bold text-xl text-slate-800">Desktop PC</div>
                                <p class="text-sm text-slate-500 mt-2">Best performance & upgradability.</p>
                            </button>
                            <button onclick="setFormFactor('laptop')" class="p-8 border-2 border-slate-100 hover:border-blue-500 rounded-2xl text-center hover:bg-blue-50 transition group">
                                <i class="fa-solid fa-laptop text-5xl text-slate-300 group-hover:text-blue-600 mb-4 transition"></i>
                                <div class="font-bold text-xl text-slate-800">Laptop</div>
                                <p class="text-sm text-slate-500 mt-2">Portability & convenience.</p>
                            </button>
                        </div>
                    </div>

                    <!-- Step 2: Usage -->
                    <div id="step-2" class="wizard-step hidden">
                        <h3 class="text-xl font-bold mb-6">What is your primary use case?</h3>
                        <div class="grid gap-4">
                            <button onclick="setUsage('gaming')" class="w-full p-4 border-2 border-slate-100 hover:border-blue-500 rounded-xl text-left hover:bg-blue-50 transition group flex items-center gap-4">
                                <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center text-slate-600 group-hover:bg-blue-100 group-hover:text-blue-600"><i class="fa-solid fa-gamepad"></i></div>
                                <div>
                                    <div class="font-bold text-slate-800">Gaming & Streaming</div>
                                    <div class="text-sm text-slate-500">High FPS, AAA Titles, 1440p/4K</div>
                                </div>
                            </button>
                            <button onclick="setUsage('productivity')" class="w-full p-4 border-2 border-slate-100 hover:border-blue-500 rounded-xl text-left hover:bg-blue-50 transition group flex items-center gap-4">
                                <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center text-slate-600 group-hover:bg-blue-100 group-hover:text-blue-600"><i class="fa-solid fa-briefcase"></i></div>
                                <div>
                                    <div class="font-bold text-slate-800">Workstation / Office</div>
                                    <div class="text-sm text-slate-500">Video Editing, 3D, Office Apps, Student work</div>
                                </div>
                            </button>
                            <button onclick="setUsage('coding')" class="w-full p-4 border-2 border-slate-100 hover:border-blue-500 rounded-xl text-left hover:bg-blue-50 transition group flex items-center gap-4">
                                <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center text-slate-600 group-hover:bg-blue-100 group-hover:text-blue-600"><i class="fa-solid fa-code"></i></div>
                                <div>
                                    <div class="font-bold text-slate-800">Programming & Dev</div>
                                    <div class="text-sm text-slate-500">Virtual Machines, Docker, Compiling</div>
                                </div>
                            </button>
                            <div class="pt-4">
                                <button onclick="navWizard(1)" class="text-slate-500 hover:text-slate-800">Back</button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Budget -->
                    <div id="step-3" class="wizard-step hidden">
                        <h3 class="text-xl font-bold mb-6">What is your maximum budget? (INR)</h3>
                        <div class="space-y-6">
                            <input type="range" min="15000" max="500000" step="5000" value="50000" id="budget-range" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600" oninput="updateBudget(this.value)">
                            <div class="text-center">
                                <div class="price-value">
                                    <span class="text-4xl font-bold text-blue-600"><span style="font-size: 0.7em; opacity: 0.8;">₹</span><span id="budget-val">50,000</span></span>
                                </div>
                                <p class="text-slate-400 mt-2 text-sm flex items-center justify-center gap-2"><i class="fa-solid fa-info-circle"></i> We'll find the best <span id="budget-type-text">PC</span> within this limit.</p>
                            </div>
                            <div class="flex justify-between pt-6">
                                <button onclick="navWizard(2)" class="text-slate-500 hover:text-slate-800">Back</button>
                                <button onclick="navWizard(4)" class="bg-slate-900 text-white px-6 py-2 rounded-lg hover:bg-slate-800">Next Step</button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Brand & Aesthetics -->
                    <div id="step-4" class="wizard-step hidden">
                        <h3 class="text-xl font-bold mb-4">Final Preferences</h3>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-slate-700 mb-2">CPU Preference</label>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="setPref('cpu', 'Intel')" id="btn-cpu-intel" class="pref-btn border rounded-lg p-3 text-center hover:bg-slate-50">Intel</button>
                                <button onclick="setPref('cpu', 'AMD')" id="btn-cpu-amd" class="pref-btn border rounded-lg p-3 text-center hover:bg-slate-50">AMD</button>
                                <button onclick="setPref('cpu', 'Any')" id="btn-cpu-any" class="pref-btn bg-blue-50 border-blue-500 border rounded-lg p-3 text-center text-blue-700 font-bold">Any</button>
                            </div>
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-slate-700 mb-2">GPU Preference</label>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="setPref('gpu', 'NVIDIA')" id="btn-gpu-nvidia" class="pref-btn border rounded-lg p-3 text-center hover:bg-slate-50">NVIDIA</button>
                                <button onclick="setPref('gpu', 'AMD')" id="btn-gpu-amd" class="pref-btn border rounded-lg p-3 text-center hover:bg-slate-50">AMD</button>
                                <button onclick="setPref('gpu', 'Any')" id="btn-gpu-any" class="pref-btn bg-blue-50 border-blue-500 border rounded-lg p-3 text-center text-blue-700 font-bold">Any</button>
                            </div>
                        </div>

                        <div class="flex justify-between pt-4">
                            <button onclick="navWizard(3)" class="text-slate-500 hover:text-slate-800 transition-colors flex items-center gap-2 px-4 py-2 hover:bg-slate-100 rounded-lg"><i class="fa-solid fa-arrow-left"></i> Back</button>
                            <button onclick="generateBuild()" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 font-bold shadow-lg shadow-blue-500/30 transition-all hover:shadow-xl flex items-center gap-2">
                                <i class="fa-solid fa-magic"></i> See Recommendation
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- View: Results -->
        <div id="view-results" class="hidden min-h-screen bg-slate-50 pb-20">
            <div class="bg-slate-900 text-white py-12 px-4">
                <div class="max-w-7xl mx-auto text-center">
                    <h2 class="text-3xl font-bold mb-2">Your Recommendation</h2>
                    <p class="text-slate-400">Optimized for <span id="res-usage" class="text-white font-bold capitalize">Gaming</span> • Budget: <span id="res-budget"></span></p>
                </div>
            </div>

            <div class="max-w-7xl mx-auto px-4 -mt-8">
                <div class="bg-white rounded-xl shadow-xl overflow-hidden border border-slate-200">
                    
                    <!-- Build Summary Header -->
                    <div class="bg-blue-50 p-6 border-b border-blue-100 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="flex items-center gap-3">
                            <div class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-bold flex items-center gap-2">
                                <i class="fa-solid fa-check-circle"></i> Best Match Found
                            </div>
                            <span class="text-sm text-slate-500">Generated by PCSensei Engine</span>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-slate-500">Estimated Price</div>
                            <div class="text-3xl font-bold text-slate-900" id="total-price">₹0</div>
                        </div>
                    </div>

                    <!-- Dynamic Performance Section -->
                    <div id="performance-section" class="p-6 bg-slate-50 border-b border-slate-200">
                        <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <span id="perf-icon"></span>
                            <span id="perf-title">Performance Estimates</span>
                        </h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" id="benchmark-cards">
                            <!-- Injected via JS -->
                        </div>
                    </div>

                    <!-- Parts List Container -->
                    <div class="p-0" id="parts-container">
                        <!-- Parts injected via JS -->
                    </div>

                    <!-- Actions -->
                    <div class="p-6 bg-slate-50 border-t border-slate-200 flex flex-wrap justify-end gap-4">
                        <button onclick="startWizard()" class="px-6 py-2 border border-slate-300 rounded-lg hover:bg-white text-slate-600 transition-all hover:shadow-md flex items-center gap-2"><i class="fa-solid fa-edit"></i> Edit Preferences</button>
                        <button onclick="window.print()" class="px-6 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition-all hover:shadow-lg flex items-center gap-2"><i class="fa-solid fa-print"></i> Save Details</button>
                    </div>
                </div>
                
                <!-- Ad: Results Page Sidebar -->
                <div class="mt-8">
                    <div class="ad-container">
                        <div class="ad-label">Advertisement</div>
                        <!-- Google AdSense Sidebar Ad (300x250 or Responsive) -->
                        <ins class="adsbygoogle"
                             style="display:block"
                             data-ad-client="ca-pub-XXXXXXXXXX"
                             data-ad-slot="XXXXXXXXXX"
                             data-ad-format="auto"
                             data-full-width-responsive="true"></ins>
                        <script>
                             (adsbygoogle = window.adsbygoogle || []).push({});
                        </script>
                    </div>
                </div>

                <!-- AI Explanation -->
                <div class="mt-8 bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex gap-4">
                    <div class="w-12 h-12 bg-purple-100 text-purple-600 rounded-full flex-shrink-0 flex items-center justify-center text-xl">
                        <i class="fa-solid fa-robot"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-slate-800 mb-2">Why this choice?</h4>
                        <p class="text-slate-600 leading-relaxed" id="build-reasoning">
                            Loading reasoning...
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ad: Before Footer -->
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="ad-container">
                <div class="ad-label">Advertisement</div>
                <!-- Google AdSense Large Rectangle Ad (336x280 or Responsive) -->
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-XXXXXXXXXX"
                     data-ad-slot="XXXXXXXXXX"
                     data-ad-format="rectangle"
                     data-full-width-responsive="true"></ins>
                <script>
                     (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
            </div>
        </div>

        <!-- Footer -->
        <footer class="bg-slate-900 text-white py-12 mt-20">
            <div class="max-w-7xl mx-auto px-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                    <div>
                        <div class="flex items-center gap-2 mb-4">
                            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                                <i class="fa-solid fa-cube text-xl"></i>
                            </div>
                            <span class="font-bold text-xl">PCSensei</span>
                        </div>
                        <p class="text-slate-400 text-sm mb-4">Your trusted PC building companion for the Indian market. We help you find the best components at the best prices.</p>
                        <div class="flex gap-3">
                            <a href="https://github.com/sumitverma0008/PCSENSE" target="_blank" rel="noopener" class="w-10 h-10 bg-slate-800 hover:bg-slate-700 rounded-lg flex items-center justify-center transition"><i class="fa-brands fa-github"></i></a>
                            <a href="#" class="w-10 h-10 bg-slate-800 hover:bg-slate-700 rounded-lg flex items-center justify-center transition"><i class="fa-brands fa-twitter"></i></a>
                            <a href="#" class="w-10 h-10 bg-slate-800 hover:bg-slate-700 rounded-lg flex items-center justify-center transition"><i class="fa-brands fa-discord"></i></a>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-bold mb-4">Build Tools</h4>
                        <ul class="space-y-2 text-slate-400 text-sm">
                            <li><a href="#" onclick="startWizard()" class="hover:text-white transition">PC Builder Wizard</a></li>
                            <li><a href="#" onclick="startWizard()" class="hover:text-white transition">Laptop Finder</a></li>
                            <li><a href="price-dashboard.html" class="hover:text-white transition">Price Tracker</a></li>
                            <li><a href="#" onclick="toggleAI()" class="hover:text-white transition">Ask an Expert</a></li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold mb-4">Resources</h4>
                        <ul class="space-y-2 text-slate-400 text-sm">
                            <li><a href="#" class="hover:text-white transition">Beginner's Guide</a></li>
                            <li><a href="#" class="hover:text-white transition">Component Glossary</a></li>
                            <li><a href="#" class="hover:text-white transition">Best Builds 2025</a></li>
                            <li><a href="https://github.com/sumitverma0008/PCSENSE" target="_blank" rel="noopener" class="hover:text-white transition">GitHub (Open Source)</a></li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold mb-4">For Admins</h4>
                        <a href="admin.html" class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg transition font-semibold mb-4">
                            <i class="fa-solid fa-user-shield"></i> Admin Panel
                        </a>
                        <p class="text-slate-400 text-xs">Manage 800+ components, monitor price changes, and update the database.</p>
                    </div>
                </div>
                <div class="border-t border-slate-800 mt-8 pt-6">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                        <p class="text-slate-400 text-sm">© 2025 PCSensei. Made in India 🇮🇳 for Indian PC builders.</p>
                        <div class="flex gap-6 text-slate-400 text-sm">
                            <a href="#" class="hover:text-white transition">Privacy Policy</a>
                            <a href="#" class="hover:text-white transition">Terms of Use</a>
                            <a href="#" class="hover:text-white transition">Contact</a>
                        </div>
                    </div>
                </div>
            </div>
        </footer>

    </main>

    <!-- Shopping Options Modal -->
    <div id="shop-modal" class="shop-modal" onclick="closeShopModal(event)">
        <div class="shop-modal-content" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-slate-800">Compare & Buy</h3>
                <button onclick="closeShopModal()" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center text-slate-400 hover:text-slate-600">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <p class="text-sm text-slate-600 mb-6" id="shop-product-name"></p>
            <div class="space-y-3" id="shop-links-container">
                <!-- Store links will be injected here -->
            </div>
        </div>
    </div>

    <!-- Floating UI: AI Chat -->
    <div id="ai-chat-panel" class="fixed bottom-24 right-6 w-96 h-[500px] glass-panel rounded-2xl shadow-2xl transform translate-y-[120%] transition-transform duration-300 z-40 flex flex-col">
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 p-4 rounded-t-2xl flex justify-between items-center text-white shadow-lg">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                    <i class="fa-solid fa-comments"></i>
                </div>
                <div>
                    <span class="font-bold block">PC Expert</span>
                    <span class="text-xs opacity-80">Online • Typically replies instantly</span>
                </div>
            </div>
            <button onclick="toggleAI()" class="hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all" title="Close chat"><i class="fa-solid fa-times"></i></button>
        </div>
        <div id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50/50">
            <!-- Msgs -->
            <div class="flex gap-2">
                <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 text-xs"><i class="fa-solid fa-user-tie"></i></div>
                <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-700 max-w-[80%] border border-slate-100">
                    Hey there! 👋 I'm here to help you build your perfect PC. Got questions about specs, compatibility, or just need a second opinion? Fire away!
                </div>
            </div>
        </div>
        <div class="p-3 bg-white border-t border-slate-200 rounded-b-2xl">
            <div class="flex gap-2">
                <input type="text" id="chat-input" placeholder="Type your question..." class="flex-1 bg-slate-100 border-0 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 text-sm" onkeypress="handleChat(event)">
                <button onclick="sendMessage()" class="bg-purple-600 text-white w-10 h-10 rounded-lg hover:bg-purple-700" title="Send message"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- Floating UI: Live Support -->
    <div id="live-support-panel" class="fixed top-20 right-6 w-96 bg-white rounded-xl shadow-2xl border border-slate-200 z-50 hidden animate-slide-up">
        <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-gradient-to-r from-green-500 to-green-600 rounded-t-xl">
            <div class="flex items-center gap-2">
                <div class="relative">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-white opacity-30"></span>
                    <i class="fa-solid fa-headset text-white text-lg"></i>
                </div>
                <div>
                    <h3 class="font-bold text-white">Rahul from PCSensei</h3>
                    <p class="text-xs text-green-100">Hardware Specialist • Online</p>
                </div>
            </div>
            <button onclick="toggleLiveSupport()" class="text-white hover:text-green-100" title="Close"><i class="fa-solid fa-times"></i></button>
        </div>
        <div id="expert-chat-messages" class="p-4 h-96 overflow-y-auto bg-slate-50 space-y-3">
            <div class="flex items-start gap-2">
                <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-xs flex-shrink-0">
                    <i class="fa-solid fa-user"></i>
                </div>
                <div class="bg-white rounded-lg p-3 shadow-sm max-w-[80%]">
                    <p class="text-sm text-slate-700">Hey! 👋 I'm Rahul, been building PCs for about 8 years now. I've helped folks with everything from ₹20K budget builds to crazy ₹4L gaming rigs.</p>
                    <p class="text-sm text-slate-700 mt-2">What's on your mind? I can help with:</p>
                    <ul class="text-xs text-slate-600 mt-2 space-y-1">
                        <li>• "Is this build any good?" reviews</li>
                        <li>• Bottleneck & compatibility checks</li>
                        <li>• Troubleshooting PC issues</li>
                        <li>• Where to buy in India</li>
                    </ul>
                    <div class="flex flex-wrap gap-2 mt-3">
                        <button onclick="sendQuickQuestion('Can you check my build?')" class="text-xs bg-green-50 hover:bg-green-100 text-green-700 px-3 py-1.5 rounded-full border border-green-200 transition">Check my build</button>
                        <button onclick="sendQuickQuestion('PC not turning on')" class="text-xs bg-green-50 hover:bg-green-100 text-green-700 px-3 py-1.5 rounded-full border border-green-200 transition">PC not turning on</button>
                        <button onclick="sendQuickQuestion('Is RTX 4060 worth it in 2025?')" class="text-xs bg-green-50 hover:bg-green-100 text-green-700 px-3 py-1.5 rounded-full border border-green-200 transition">Is RTX 4060 worth it?</button>
                        <button onclick="sendQuickQuestion('Best GPU under 40000?')" class="text-xs bg-green-50 hover:bg-green-100 text-green-700 px-3 py-1.5 rounded-full border border-green-200 transition">Best GPU under ₹40K</button>
                        <button onclick="sendQuickQuestion('My PC is overheating')" class="text-xs bg-green-50 hover:bg-green-100 text-green-700 px-3 py-1.5 rounded-full border border-green-200 transition">Overheating issue</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="p-3 border-t border-slate-100 bg-white rounded-b-xl">
            <div class="flex gap-2">
                <input type="text" id="expert-chat-input" placeholder="Ask me anything about PCs..." class="flex-1 bg-slate-100 border-0 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 text-sm" onkeypress="handleExpertChat(event)">
                <button onclick="sendExpertMessage()" class="bg-green-600 text-white w-10 h-10 rounded-lg hover:bg-green-700 transition" title="Send"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- Floating Buttons -->
    <button onclick="toggleAI()" class="fixed bottom-6 right-6 w-14 h-14 bg-gradient-to-r from-purple-600 to-blue-600 rounded-full text-white shadow-lg hover:shadow-xl hover:scale-105 transition flex items-center justify-center text-2xl z-30" title="Chat with PC Expert">
        <i class="fa-solid fa-comments"></i>
    </button>

    <script>
        // --- SECURITY UTILITIES ---
        const Security = {
            sanitizeHTML(str) {
                if (typeof str !== 'string') return str;
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            },
            
            sanitizeNumber(value, min = 0, max = Infinity) {
                const num = parseFloat(value);
                if (isNaN(num)) return min;
                return Math.max(min, Math.min(max, num));
            },
            
            validateBudget(budget) {
                return this.sanitizeNumber(budget, 15000, 500000);
            },
            
            sanitizeObject(obj) {
                if (typeof obj !== 'object' || obj === null) return {};
                const sanitized = {};
                for (let key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        if (typeof obj[key] === 'string') {
                            sanitized[key] = this.sanitizeHTML(obj[key]);
                        } else if (typeof obj[key] === 'number') {
                            sanitized[key] = this.sanitizeNumber(obj[key]);
                        } else {
                            sanitized[key] = obj[key];
                        }
                    }
                }
                return sanitized;
            },
            
            rateLimit: {
                lastRequest: 0,
                minDelay: 1000,
                
                check() {
                    const now = Date.now();
                    if (now - this.lastRequest < this.minDelay) {
                        return false;
                    }
                    this.lastRequest = now;
                    return true;
                }
            }
        };

        // --- 1. DATABASE LOADER ---
        let db = null;
        let dbLoaded = false;

        async function loadDb() {
            if (dbLoaded && db) return db;
            
            try {
                const response = await fetch('data/components.json', {
                    headers: { 'Cache-Control': 'no-cache' }
                });
                if (!response.ok) throw new Error('Failed to load components database');
                
                const data = await response.json();
                
                // Validate database structure
                const requiredKeys = ['laptops', 'cpus', 'gpus', 'mobos', 'ram', 'storage', 'psu', 'case'];
                const isValid = requiredKeys.every(key => Array.isArray(data[key]));
                
                if (!isValid) {
                    throw new Error('Invalid database structure');
                }
                
                // Sanitize all data
                db = {};
                for (let key of requiredKeys) {
                    db[key] = data[key].map(item => Security.sanitizeObject(item));
                }
                
                dbLoaded = true;
                return db;
            } catch (error) {
                console.error('Database load error:', error);
                alert('Failed to load component database. Please refresh the page.');
                throw error;
            }
        }

        // --- 2. METRICS ---
        const PERFORMANCE_METRICS = {
            gaming: {
                label: "Estimated Gaming Performance",
                icon: '<i class="fa-solid fa-gamepad text-purple-600"></i>',
                metrics: {
                    integrated: [
                        { name: "GTA V", value: "30-40 FPS (720p)", color: "text-green-600" },
                        { name: "Valorant", value: "60+ FPS (Low)", color: "text-blue-600" },
                        { name: "Cyberpunk", value: "Unplayable", color: "text-red-600" },
                        { name: "Live Streaming", value: "Not Supported", color: "text-red-600" }
                    ],
                    entry: [
                        { name: "GTA V", value: "60+ FPS (1080p)", color: "text-green-600" },
                        { name: "Valorant", value: "144+ FPS (High)", color: "text-blue-600" },
                        { name: "Cyberpunk", value: "30-45 FPS (Low)", color: "text-orange-600" },
                        { name: "Live Streaming", value: "720p 30FPS (Basic)", color: "text-orange-600" }
                    ],
                    mid: [
                        { name: "GTA V", value: "100+ FPS (Ultra)", color: "text-green-600" },
                        { name: "Valorant", value: "240+ FPS (High)", color: "text-blue-600" },
                        { name: "Cyberpunk", value: "60+ FPS (High)", color: "text-green-600" },
                        { name: "Live Streaming", value: "1080p 60FPS (Smooth)", color: "text-green-600" }
                    ],
                    high: [
                        { name: "GTA V", value: "140+ FPS (1440p)", color: "text-green-600" },
                        { name: "Valorant", value: "300+ FPS (High)", color: "text-blue-600" },
                        { name: "Cyberpunk", value: "80+ FPS (1440p)", color: "text-green-600" },
                        { name: "Live Streaming", value: "1080p/1440p (Pro)", color: "text-blue-600" }
                    ],
                    ultra: [
                        { name: "GTA V", value: "165+ FPS (4K)", color: "text-green-600" },
                        { name: "Valorant", value: "500+ FPS (High)", color: "text-blue-600" },
                        { name: "Cyberpunk", value: "100+ FPS (4K)", color: "text-green-600" },
                        { name: "Live Streaming", value: "4K / Multi-Stream", color: "text-purple-600" }
                    ]
                }
            },
            productivity: {
                label: "Workstation Software Capability",
                icon: '<i class="fa-solid fa-pen-ruler text-blue-600"></i>',
                metrics: {
                    integrated: [
                        { name: "Video Editing", value: "1080p Basic", color: "text-orange-600" },
                        { name: "Graphic Design", value: "Canva/Basic", color: "text-blue-600" },
                        { name: "3D Rendering", value: "Not Recommended", color: "text-red-600" },
                        { name: "Multitasking", value: "Basic", color: "text-orange-600" }
                    ],
                    entry: [
                        { name: "Video Editing", value: "1080p Smooth", color: "text-green-600" },
                        { name: "Graphic Design", value: "Photoshop (Fast)", color: "text-blue-600" },
                        { name: "3D Rendering", value: "Blender (Basic)", color: "text-orange-600" },
                        { name: "Multitasking", value: "Standard", color: "text-blue-600" }
                    ],
                    mid: [
                        { name: "Video Editing", value: "4K Editing", color: "text-green-600" },
                        { name: "Graphic Design", value: "Complex Vector", color: "text-blue-600" },
                        { name: "3D Rendering", value: "Blender Cycles", color: "text-green-600" },
                        { name: "Multitasking", value: "Heavy", color: "text-green-600" }
                    ],
                    high: [
                        { name: "Video Editing", value: "6K/RAW Editing", color: "text-green-600" },
                        { name: "Graphic Design", value: "Professional", color: "text-blue-600" },
                        { name: "3D Rendering", value: "Fast Rendering", color: "text-green-600" },
                        { name: "Multitasking", value: "Extreme", color: "text-purple-600" }
                    ],
                    ultra: [
                        { name: "Video Editing", value: "8K Cinema", color: "text-green-600" },
                        { name: "Graphic Design", value: "Industry Std", color: "text-blue-600" },
                        { name: "3D Rendering", value: "Studio Grade", color: "text-green-600" },
                        { name: "Multitasking", value: "Limitless", color: "text-purple-600" }
                    ]
                }
            },
            coding: {
                label: "Development Environment",
                icon: '<i class="fa-solid fa-code text-green-600"></i>',
                metrics: {
                    integrated: [
                        { name: "Web Dev", value: "HTML/JS (Fast)", color: "text-green-600" },
                        { name: "Virtualization", value: "Not Recommended", color: "text-red-600" },
                        { name: "IDE Speed", value: "VS Code (Good)", color: "text-blue-600" },
                        { name: "Local Server", value: "Simple", color: "text-orange-600" }
                    ],
                    entry: [
                        { name: "Web Dev", value: "Full Stack", color: "text-green-600" },
                        { name: "Virtualization", value: "1 Light VM", color: "text-orange-600" },
                        { name: "IDE Speed", value: "Standard", color: "text-blue-600" },
                        { name: "Local Server", value: "Standard", color: "text-blue-600" }
                    ],
                    mid: [
                        { name: "Web Dev", value: "Heavy Backend", color: "text-green-600" },
                        { name: "Virtualization", value: "Docker / 2 VMs", color: "text-green-600" },
                        { name: "Mobile Dev", value: "Android Studio", color: "text-blue-600" },
                        { name: "Local Server", value: "Docker Containers", color: "text-green-600" }
                    ],
                    high: [
                        { name: "Web Dev", value: "Enterprise", color: "text-green-600" },
                        { name: "Virtualization", value: "Multiple VMs", color: "text-green-600" },
                        { name: "Compilation", value: "Fast Compile", color: "text-blue-600" },
                        { name: "Local Server", value: "K8s Cluster", color: "text-purple-600" }
                    ],
                    ultra: [
                        { name: "Web Dev", value: "Server Load", color: "text-green-600" },
                        { name: "Virtualization", value: "Data Center Sim", color: "text-green-600" },
                        { name: "Compilation", value: "Instant", color: "text-blue-600" },
                        { name: "Local Server", value: "Data Center", color: "text-purple-600" }
                    ]
                }
            }
        };

        // --- 3. STATE & UI LOGIC ---
        let state = { formFactor: 'desktop', usage: 'gaming', budget: 50000, prefs: { cpu: 'Any', gpu: 'Any' }, currentBuild: null };

        function goHome() {
            document.getElementById('view-landing').classList.remove('hidden');
            document.getElementById('view-wizard').classList.add('hidden');
            document.getElementById('view-results').classList.add('hidden');
            document.getElementById('view-mode-selection').classList.add('hidden');
            document.getElementById('view-custom-builder').classList.add('hidden');
        }

        function showModeSelection() {
            document.getElementById('view-landing').classList.add('hidden');
            document.getElementById('view-wizard').classList.add('hidden');
            document.getElementById('view-results').classList.add('hidden');
            document.getElementById('view-mode-selection').classList.remove('hidden');
            document.getElementById('view-custom-builder').classList.add('hidden');
        }

        // Custom Builder State
        let customBuild = {
            cpu: null,
            gpu: null,
            mobo: null,
            ram: null,
            storage: null,
            psu: null,
            case: null
        };

        async function startCustomBuilder() {
            // Hide all views
            document.getElementById('view-landing').classList.add('hidden');
            document.getElementById('view-wizard').classList.add('hidden');
            document.getElementById('view-results').classList.add('hidden');
            document.getElementById('view-mode-selection').classList.add('hidden');
            document.getElementById('view-custom-builder').classList.remove('hidden');
            
            // Load component database if not already loaded
            if (!dbLoaded) {
                await loadDatabase();
            }
            
            // Wait a moment to ensure DB is loaded, then populate
            setTimeout(() => {
                populateComponentDropdowns();
            }, 100);
        }

        function populateComponentDropdowns() {
            // Check if database is loaded
            if (!db || !db.cpus) {
                console.error('Database not loaded yet');
                return;
            }
            
            // CPUs
            const cpuSelect = document.getElementById('select-cpu');
            cpuSelect.innerHTML = '<option value="">Choose a CPU...</option>';
            db.cpus.forEach((cpu, idx) => {
                const option = document.createElement('option');
                option.value = idx;
                option.textContent = `${cpu.name} - ₹${cpu.price.toLocaleString('en-IN')}`;
                cpuSelect.appendChild(option);
            });
            document.getElementById('cpu-count').textContent = `${db.cpus.length} options`;

            // GPUs
            const gpuSelect = document.getElementById('select-gpu');
            gpuSelect.innerHTML = '<option value="">Choose a GPU...</option>';
            db.gpus.forEach((gpu, idx) => {
                const option = document.createElement('option');
                option.value = idx;
                option.textContent = `${gpu.name} - ₹${gpu.price.toLocaleString('en-IN')}`;
                gpuSelect.appendChild(option);
            });
            document.getElementById('gpu-count').textContent = `${db.gpus.length} options`;

            // Motherboards
            const moboSelect = document.getElementById('select-mobo');
            moboSelect.innerHTML = '<option value="">Choose a Motherboard...</option>';
            db.mobos.forEach((mobo, idx) => {
                const option = document.createElement('option');
                option.value = idx;
                option.textContent = `${mobo.name} - ₹${mobo.price.toLocaleString('en-IN')}`;
                moboSelect.appendChild(option);
            });
            document.getElementById('mobo-count').textContent = `${db.mobos.length} options`;

            // RAM
            const ramSelect = document.getElementById('select-ram');
            ramSelect.innerHTML = '<option value="">Choose RAM...</option>';
            db.ram.forEach((ram, idx) => {
                const option = document.createElement('option');
                option.value = idx;
                option.textContent = `${ram.name} - ₹${ram.price.toLocaleString('en-IN')}`;
                ramSelect.appendChild(option);
            });
            document.getElementById('ram-count').textContent = `${db.ram.length} options`;

            // Storage
            const storageSelect = document.getElementById('select-storage');
            storageSelect.innerHTML = '<option value="">Choose Storage...</option>';
            db.storage.forEach((storage, idx) => {
                const option = document.createElement('option');
                option.value = idx;
                option.textContent = `${storage.name} - ₹${storage.price.toLocaleString('en-IN')}`;
                storageSelect.appendChild(option);
            });
            document.getElementById('storage-count').textContent = `${db.storage.length} options`;

            // PSU
            const psuSelect = document.getElementById('select-psu');
            psuSelect.innerHTML = '<option value="">Choose PSU...</option>';
            db.psu.forEach((psu, idx) => {
                const option = document.createElement('option');
                option.value = idx;
                option.textContent = `${psu.name} - ₹${psu.price.toLocaleString('en-IN')}`;
                psuSelect.appendChild(option);
            });
            document.getElementById('psu-count').textContent = `${db.psu.length} options`;

            // Case
            const caseSelect = document.getElementById('select-case');
            caseSelect.innerHTML = '<option value="">Choose Case...</option>';
            db.case.forEach((c, idx) => {
                const option = document.createElement('option');
                option.value = idx;
                option.textContent = `${c.name} - ₹${c.price.toLocaleString('en-IN')}`;
                caseSelect.appendChild(option);
            });
            document.getElementById('case-count').textContent = `${db.case.length} options`;
        }

        function selectComponent(type, index) {
            if (index === '') {
                customBuild[type] = null;
                document.getElementById(`${type}-details`).classList.add('hidden');
            } else {
                const component = db[type === 'mobo' ? 'mobos' : type === 'case' ? 'case' : type + 's'][index];
                customBuild[type] = component;
                
                // Show component details
                const detailsEl = document.getElementById(`${type}-details`);
                detailsEl.innerHTML = `<strong>${component.name}</strong><br>${component.spec || ''}`;
                detailsEl.classList.remove('hidden');
            }
            
            updateCustomBuildSummary();
            validateCompatibility();
        }

        function updateCustomBuildSummary() {
            const listEl = document.getElementById('custom-build-list');
            const totalEl = document.getElementById('custom-total-price');
            const viewBtn = document.getElementById('btn-view-custom-build');
            
            let html = '';
            let total = 0;
            let componentCount = 0;
            
            const components = [
                { key: 'cpu', label: 'CPU', icon: 'fa-microchip' },
                { key: 'gpu', label: 'GPU', icon: 'fa-display' },
                { key: 'mobo', label: 'Motherboard', icon: 'fa-memory' },
                { key: 'ram', label: 'RAM', icon: 'fa-memory' },
                { key: 'storage', label: 'Storage', icon: 'fa-hard-drive' },
                { key: 'psu', label: 'PSU', icon: 'fa-bolt' },
                { key: 'case', label: 'Case', icon: 'fa-box' }
            ];
            
            components.forEach(comp => {
                if (customBuild[comp.key]) {
                    const item = customBuild[comp.key];
                    total += item.price;
                    componentCount++;
                    html += `
                        <div class="flex items-center justify-between text-sm border-b border-slate-200 pb-2">
                            <div class="flex items-center gap-2">
                                <i class="fa-solid ${comp.icon} text-blue-600"></i>
                                <span class="font-medium text-slate-700">${comp.label}</span>
                            </div>
                            <span class="text-slate-900 font-bold">₹${item.price.toLocaleString('en-IN')}</span>
                        </div>
                    `;
                }
            });
            
            if (componentCount === 0) {
                html = `<div class="text-sm text-slate-500 text-center py-8 border-2 border-dashed border-slate-200 rounded-lg">
                    <i class="fa-solid fa-cube text-3xl text-slate-300 mb-2"></i>
                    <p>Start selecting components</p>
                </div>`;
            }
            
            listEl.innerHTML = html;
            totalEl.textContent = `₹${total.toLocaleString('en-IN')}`;
            
            // Enable view button only if all components selected
            viewBtn.disabled = componentCount < 7;
        }

        function validateCompatibility() {
            const warningEl = document.getElementById('compatibility-warnings');
            const warningText = document.getElementById('warning-text');
            
            // Check CPU-Motherboard socket compatibility
            if (customBuild.cpu && customBuild.mobo) {
                if (customBuild.cpu.socket !== customBuild.mobo.socket) {
                    warningEl.classList.remove('hidden');
                    warningText.textContent = `Socket mismatch! CPU uses ${customBuild.cpu.socket} but motherboard uses ${customBuild.mobo.socket}`;
                    return;
                }
            }
            
            // Check PSU wattage
            if (customBuild.cpu && customBuild.gpu && customBuild.psu) {
                const cpuTdp = parseInt(customBuild.cpu.tdp?.match(/\d+/)?.[0] || 65);
                const gpuTdp = parseInt(customBuild.gpu.tdp?.match(/\d+/)?.[0] || 150);
                const psuWattage = parseInt(customBuild.psu.wattage?.match(/\d+/)?.[0] || 0);
                const recommendedWattage = Math.ceil((cpuTdp + gpuTdp + 100) * 1.2);
                
                if (psuWattage < recommendedWattage) {
                    warningEl.classList.remove('hidden');
                    warningText.textContent = `PSU may be underpowered! Recommended: ${recommendedWattage}W, Selected: ${psuWattage}W`;
                    return;
                }
            }
            
            warningEl.classList.add('hidden');
        }

        function clearCustomBuild() {
            if (confirm('Clear all selected components?')) {
                customBuild = {
                    cpu: null,
                    gpu: null,
                    mobo: null,
                    ram: null,
                    storage: null,
                    psu: null,
                    case: null
                };
                
                // Reset all dropdowns
                document.getElementById('select-cpu').selectedIndex = 0;
                document.getElementById('select-gpu').selectedIndex = 0;
                document.getElementById('select-mobo').selectedIndex = 0;
                document.getElementById('select-ram').selectedIndex = 0;
                document.getElementById('select-storage').selectedIndex = 0;
                document.getElementById('select-psu').selectedIndex = 0;
                document.getElementById('select-case').selectedIndex = 0;
                
                // Hide all details
                ['cpu', 'gpu', 'mobo', 'ram', 'storage', 'psu', 'case'].forEach(type => {
                    document.getElementById(`${type}-details`).classList.add('hidden');
                });
                
                updateCustomBuildSummary();
            }
        }

        function viewCustomBuildSummary() {
            // Convert custom build to results format
            state.currentBuild = {
                type: 'desktop',
                data: {
                    cpu: customBuild.cpu,
                    gpu: customBuild.gpu,
                    mobo: customBuild.mobo,
                    ram: customBuild.ram,
                    storage: customBuild.storage,
                    psu: customBuild.psu,
                    userCase: customBuild.case
                }
            };
            
            // Show results view
            document.getElementById('view-custom-builder').classList.add('hidden');
            document.getElementById('view-results').classList.remove('hidden');
            
            // Update results view
            document.getElementById('res-usage').innerText = 'Custom Build';
            const total = Object.values(customBuild).reduce((sum, item) => sum + (item?.price || 0), 0);
            document.getElementById('res-budget').innerText = '₹' + total.toLocaleString('en-IN');
            
            renderParts({ type: 'desktop', data: state.currentBuild.data });
            
            // Show custom build message
            document.getElementById('build-reasoning').innerHTML = `
                This is your custom-selected build. All components have been manually chosen by you.<br><br>
                <strong>Total Cost:</strong> ₹${total.toLocaleString('en-IN')}<br>
                ${customBuild.cpu && customBuild.mobo && customBuild.cpu.socket === customBuild.mobo.socket ? 
                    '<span class="text-green-600"><i class="fa-solid fa-check-circle"></i> CPU and Motherboard are compatible</span>' : 
                    '<span class="text-red-600"><i class="fa-solid fa-exclamation-triangle"></i> Please verify socket compatibility</span>'}
            `;
            
            // Determine GPU tier for performance metrics
            let gpuTier = 'integrated';
            if (customBuild.gpu) {
                const gpuPrice = customBuild.gpu.price;
                if (gpuPrice > 100000) gpuTier = 'ultra';
                else if (gpuPrice > 65000) gpuTier = 'high';
                else if (gpuPrice > 40000) gpuTier = 'mid';
                else if (gpuPrice > 25000) gpuTier = 'entry';
            }
            
            // Render performance benchmarks
            renderCustomBenchmarks(gpuTier);
        }

        function renderCustomBenchmarks(tier) {
            const categoryData = PERFORMANCE_METRICS.gaming;
            const metricsList = categoryData.metrics[tier] || categoryData.metrics.integrated;

            document.getElementById('perf-icon').innerHTML = categoryData.icon;
            document.getElementById('perf-title').innerHTML = 'Estimated Gaming Performance <i class="fa-solid fa-chart-line ml-2 text-sm"></i>';

            const container = document.getElementById('benchmark-cards');
            container.innerHTML = '';

            metricsList.forEach(metric => {
                container.innerHTML += `
                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm text-center">
                        <div class="font-bold text-slate-800 mb-1">${metric.name}</div>
                        <div class="text-2xl font-black ${metric.color}">${metric.value}</div>
                    </div>`;
            });
        }

        // Shopping Modal Functions
        function openShopModal(shopLinks, productName) {
            const modal = document.getElementById('shop-modal');
            const productNameEl = document.getElementById('shop-product-name');
            const linksContainer = document.getElementById('shop-links-container');
            
            productNameEl.textContent = productName;
            
            const stores = [
                { name: 'Amazon India', key: 'amazon', color: '#FF9900', icon: '🛒' },
                { name: 'Flipkart', key: 'flipkart', color: '#2874F0', icon: '🛍️' },
                { name: 'Reliance Digital', key: 'reliance', color: '#E42529', icon: '🏬' },
                { name: 'Croma', key: 'croma', color: '#8CC63F', icon: '🏪' },
                { name: 'Vijay Sales', key: 'vijay', color: '#FF6B00', icon: '🛒' },
                { name: 'MD Computers', key: 'mdcomputers', color: '#0066CC', icon: '💻' }
            ];
            
            let html = '';
            stores.forEach(store => {
                if (shopLinks && shopLinks[store.key]) {
                    html += `
                        <a href="${shopLinks[store.key]}" target="_blank" rel="noopener noreferrer" class="store-btn">
                            <div class="store-logo" style="background: ${store.color}; color: white;">
                                ${store.icon}
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-slate-800">${store.name}</div>
                                <div class="text-xs text-slate-500">Compare prices & deals</div>
                            </div>
                            <i class="fa-solid fa-arrow-right text-slate-400"></i>
                        </a>
                    `;
                }
            });
            
            linksContainer.innerHTML = html;
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        function closeShopModal(event) {
            if (!event || event.target.id === 'shop-modal') {
                const modal = document.getElementById('shop-modal');
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        function startWizard() {
            document.getElementById('view-landing').classList.add('hidden');
            document.getElementById('view-results').classList.add('hidden');
            document.getElementById('view-mode-selection').classList.add('hidden');
            document.getElementById('view-custom-builder').classList.add('hidden');
            document.getElementById('view-wizard').classList.remove('hidden');
            navWizard(1);
        }

        function navWizard(step) {
            document.querySelectorAll('.wizard-step').forEach(el => el.classList.add('hidden'));
            document.getElementById(`step-${step}`).classList.remove('hidden');
            document.getElementById('wiz-step-num').innerText = step;
            document.getElementById('wiz-progress').style.width = (step / 4 * 100) + '%';
        }

        function setFormFactor(ff) {
            state.formFactor = ff;
            document.getElementById('budget-type-text').innerText = ff === 'laptop' ? 'Laptop' : 'PC';
            navWizard(2);
        }

        function setUsage(u) {
            state.usage = u;
            navWizard(3);
        }

        function updateBudget(val) {
            const sanitized = Security.validateBudget(val);
            state.budget = parseInt(sanitized);
            document.getElementById('budget-val').innerText = state.budget.toLocaleString('en-IN');
        }

        function setPref(type, val) {
            // Validate inputs
            const validTypes = ['cpu', 'gpu'];
            const validValues = ['Intel', 'AMD', 'NVIDIA', 'Any'];
            
            if (!validTypes.includes(type) || !validValues.includes(val)) {
                console.error('Invalid preference');
                return;
            }
            
            state.prefs[type] = val;
            document.querySelectorAll(`#step-4 button[id^='btn-${type}']`).forEach(b => {
                b.classList.remove('bg-blue-50', 'border-blue-500', 'text-blue-700', 'font-bold');
                b.classList.add('border-gray-200');
            });
            const btn = document.getElementById(`btn-${type.toLowerCase()}-${val.toLowerCase()}`);
            if (btn) {
                btn.classList.add('bg-blue-50', 'border-blue-500', 'text-blue-700', 'font-bold');
                btn.classList.remove('border-gray-200');
            }
        }

        // --- 4. GENERATE BUILD ---
        async function generateBuild() {
            // Rate limiting
            if (!Security.rateLimit.check()) {
                alert('Please wait a moment before generating another build.');
                return;
            }
            
            await loadDb();
            
            if (!db) {
                alert('Database not loaded. Please try again.');
                return;
            }
            
            const { budget, prefs, usage, formFactor } = state;
            
            // Comprehensive input validation
            const validationErrors = [];
            
            if (!formFactor || !['laptop', 'desktop'].includes(formFactor)) {
                validationErrors.push('Invalid form factor selected');
            }
            
            const validUsages = ['gaming', 'productivity', 'coding', 'content'];
            if (!usage || !validUsages.includes(usage)) {
                validationErrors.push('Invalid usage type selected');
            }
            
            if (!budget || isNaN(budget)) {
                validationErrors.push('Invalid budget amount');
            } else if (budget < 15000) {
                validationErrors.push('Minimum budget is ₹15,000');
            } else if (budget > 10000000) {
                validationErrors.push('Maximum budget is ₹1,00,00,000');
            }
            
            if (validationErrors.length > 0) {
                alert('⚠️ Validation Error:\n\n' + validationErrors.join('\n'));
                return;
            }
            
            if (formFactor === 'laptop') {
                // Filter laptops within budget range (allow 5% over for better options)
                let potentialLaptops = db.laptops.filter(l => l.price <= budget * 1.05);
                if (potentialLaptops.length === 0) {
                    // If no laptops in budget, show closest options
                    potentialLaptops = db.laptops.filter(l => l.price <= budget * 1.2).slice(0, 3);
                    if (potentialLaptops.length === 0) potentialLaptops = db.laptops.slice(0, 3);
                }

                // Score laptops based on usage and specs
                let scoredLaptops = potentialLaptops.map(laptop => {
                    let score = 0;
                    
                    // Usage-based scoring
                    if (usage === 'gaming') {
                        if (laptop.type === 'gaming') score += 50;
                        if (laptop.gpuTier === 'high' || laptop.gpuTier === 'ultra') score += 30;
                        else if (laptop.gpuTier === 'mid') score += 20;
                        else if (laptop.gpuTier === 'entry') score += 10;
                        if (laptop.refresh && parseInt(laptop.refresh) >= 144) score += 15;
                    } else if (usage === 'productivity') {
                        if (laptop.type === 'office' || laptop.type === 'creative') score += 50;
                        if (laptop.ram && laptop.ram.includes('16GB')) score += 20;
                        if (laptop.ram && laptop.ram.includes('32GB')) score += 30;
                        if (laptop.storage && laptop.storage.includes('1TB')) score += 10;
                    } else if (usage === 'coding') {
                        if (laptop.type === 'office' || laptop.type === 'creative') score += 40;
                        if (laptop.ram && (laptop.ram.includes('16GB') || laptop.ram.includes('32GB'))) score += 25;
                        if (laptop.storage && laptop.storage.includes('SSD')) score += 15;
                        if (laptop.battery && parseInt(laptop.battery) >= 8) score += 10;
                    } else if (usage === 'content') {
                        if (laptop.type === 'creative') score += 50;
                        if (laptop.screen && laptop.screen.includes('OLED')) score += 20;
                        if (laptop.ram && laptop.ram.includes('32GB')) score += 15;
                    }
                    
                    // Budget efficiency scoring
                    const budgetUtilization = laptop.price / budget;
                    if (budgetUtilization >= 0.85 && budgetUtilization <= 1.0) score += 25;
                    else if (budgetUtilization >= 0.70 && budgetUtilization < 0.85) score += 15;
                    else if (budgetUtilization >= 0.50 && budgetUtilization < 0.70) score += 10;
                    
                    // Brand preference
                    if (prefs.gpu !== 'Any') {
                        if (laptop.brand === prefs.gpu) score += 10;
                    }
                    
                    return { ...laptop, aiScore: score };
                });

                // Sort by AI score, then by price
                scoredLaptops.sort((a, b) => {
                    if (Math.abs(a.aiScore - b.aiScore) > 10) return b.aiScore - a.aiScore;
                    return b.price - a.price;
                });
                
                let topPicks = scoredLaptops.slice(0, 3);

                state.currentBuild = { type: 'laptop', data: topPicks };
                const best = topPicks[0];
                
                // Generate intelligent reasoning
                let reasoning = `Based on your ${usage} requirements with a ₹${budget.toLocaleString('en-IN')} budget, `;
                reasoning += `our AI analyzed ${potentialLaptops.length} laptops and scored them on performance, value, and compatibility. `;
                reasoning += `The ${best.name} (Score: ${best.aiScore}/100) is our top recommendation because it offers `;
                if (usage === 'gaming') reasoning += `excellent gaming performance with ${best.spec}.`;
                else if (usage === 'productivity') reasoning += `outstanding productivity features and battery life for work.`;
                else if (usage === 'coding') reasoning += `perfect development specs with great RAM and storage.`;
                else reasoning += `the best overall value for your use case.`;
                
                document.getElementById('build-reasoning').innerText = reasoning;
                renderResults();
                return;
            }

            // DESKTOP LOGIC
            let cpu, gpu, mobo, ram, storage, psu, userCase;
            let buildReason = "";

            if (budget <= 20000) {
                cpu = db.cpus.find(c => c.name.includes('Athlon')) || db.cpus[0];
                gpu = db.gpus.find(g => g.price === 0); 
                mobo = db.mobos.find(m => m.socket === 'AM4' && m.price < 4000) || db.mobos[0];
                ram = db.ram.find(r => r.price < 1500) || db.ram[0]; 
                storage = db.storage[0]; 
                psu = db.psu[0];
                userCase = db.case[0];
                buildReason = "For this ultra-budget entry point, we used an AMD Athlon APU. It handles web browsing, movies, and office work perfectly for a very low cost.";
            }
            else if (budget < 45000) {
                cpu = db.cpus.find(c => c.name.includes('5600G')) || db.cpus[0];
                gpu = db.gpus.find(g => g.price === 0); 
                mobo = db.mobos.filter(m => m.socket === cpu.socket).sort((a,b) => a.price - b.price)[0];
                ram = db.ram.find(r => r.name.includes('8GB')) || db.ram[1]; 
                storage = db.storage[0];
                psu = db.psu[0];
                userCase = db.case[0];
                buildReason = "Given the tight budget, we selected a Processor with high-performance Integrated Graphics (APU). This allows you to game and work without buying an expensive graphics card right now.";
            } 
            else {
                // STANDARD LOGIC
                let gpuBudget = usage === 'gaming' ? budget * 0.45 : budget * 0.25;
                let cpuBudget = usage === 'productivity' ? budget * 0.30 : budget * 0.20;

                if (budget > 200000) {
                    gpuBudget = budget * 0.50;
                    cpuBudget = budget * 0.20;
                }
                if (budget > 400000) gpuBudget = 200000;

                // Smart CPU selection with workload optimization
                let cpuList = db.cpus.filter(c => {
                    const inBudget = c.price <= cpuBudget * 1.5 && c.price >= cpuBudget * 0.4;
                    const notApu = !c.integrated && !c.name.includes('Athlon');
                    return inBudget && notApu;
                });
                
                if(cpuList.length === 0) {
                    cpuList = db.cpus.filter(c => !c.integrated && !c.name.includes('Athlon'));
                }
                
                // Apply brand preference
                if(prefs.cpu !== 'Any') {
                    let filtered = cpuList.filter(c => c.brand === prefs.cpu);
                    if(filtered.length > 0) cpuList = filtered;
                }
                
                // Score CPUs based on usage
                let scoredCPUs = cpuList.map(c => {
                    let score = 0;
                    const cores = parseInt(c.cores || 0);
                    const price = c.price;
                    
                    // Core count scoring for different workloads
                    if (usage === 'content' || usage === 'productivity') {
                        if (cores >= 16) score += 35;
                        else if (cores >= 12) score += 30;
                        else if (cores >= 8) score += 20;
                        else if (cores >= 6) score += 10;
                    } else if (usage === 'gaming') {
                        if (cores >= 8) score += 30;
                        else if (cores >= 6) score += 25;
                        else if (cores >= 4) score += 15;
                    } else if (usage === 'coding') {
                        if (cores >= 12) score += 30;
                        else if (cores >= 8) score += 25;
                        else if (cores >= 6) score += 15;
                    }
                    
                    // Budget utilization score
                    const budgetRatio = price / cpuBudget;
                    if (budgetRatio >= 0.85 && budgetRatio <= 1.2) score += 25;
                    else if (budgetRatio >= 0.7 && budgetRatio < 0.85) score += 15;
                    else if (budgetRatio >= 0.5 && budgetRatio < 0.7) score += 10;
                    
                    return { ...c, cpuScore: score };
                });
                
                cpu = scoredCPUs.sort((a,b) => {
                    if (Math.abs(a.cpuScore - b.cpuScore) > 5) return b.cpuScore - a.cpuScore;
                    return b.price - a.price;
                })[0] || db.cpus[2];

                let gpuList = db.gpus.filter(g => {
                    const inBudget = g.price <= gpuBudget * 1.3 && g.price >= gpuBudget * 0.5 && g.price > 0;
                    return inBudget;
                });
                
                if(gpuList.length === 0) {
                    gpuList = db.gpus.filter(g => g.price > 0 && g.price <= gpuBudget * 1.5);
                }
                if(gpuList.length === 0) gpuList = db.gpus.filter(g => g.price > 0);
                
                // Apply brand preference
                if(prefs.gpu !== 'Any') {
                    let filtered = gpuList.filter(g => g.brand === prefs.gpu);
                    if(filtered.length > 0) gpuList = filtered;
                }
                
                // Score GPUs for optimal selection
                let scoredGPUs = gpuList.map(g => {
                    let score = 0;
                    const vram = parseInt(g.vram?.match(/\d+/)?.[0] || 0);
                    const price = g.price;
                    
                    // VRAM scoring based on usage
                    if (usage === 'gaming') {
                        if (vram >= 16) score += 35;
                        else if (vram >= 12) score += 30;
                        else if (vram >= 8) score += 20;
                        else if (vram >= 6) score += 15;
                        else if (vram >= 4) score += 10;
                    } else if (usage === 'content') {
                        if (vram >= 24) score += 40;
                        else if (vram >= 16) score += 35;
                        else if (vram >= 12) score += 25;
                        else if (vram >= 8) score += 15;
                    } else {
                        if (vram >= 8) score += 25;
                        else if (vram >= 6) score += 20;
                        else if (vram >= 4) score += 15;
                    }
                    
                    // Budget efficiency
                    const budgetRatio = price / gpuBudget;
                    if (budgetRatio >= 0.85 && budgetRatio <= 1.15) score += 30;
                    else if (budgetRatio >= 0.7 && budgetRatio < 0.85) score += 20;
                    else if (budgetRatio >= 0.5 && budgetRatio < 0.7) score += 10;
                    
                    return { ...g, gpuScore: score };
                });
                
                gpu = scoredGPUs.sort((a,b) => {
                    if (Math.abs(a.gpuScore - b.gpuScore) > 5) return b.gpuScore - a.gpuScore;
                    return b.price - a.price;
                })[0] || db.gpus[1];

                let validMobos = db.mobos.filter(m => m.socket === cpu.socket);
                validMobos.sort((a,b) => a.price - b.price); // Sort by price ascending
                
                if (budget > 300000) {
                    // High-end: pick top-tier boards
                    let highEnd = validMobos.filter(m => m.price > 25000);
                    mobo = highEnd[Math.floor(highEnd.length * 0.7)] || validMobos[validMobos.length - 1];
                } else if (budget > 150000) {
                    // Mid-range: 15k-30k boards
                    let midRange = validMobos.filter(m => m.price >= 15000 && m.price <= 30000);
                    mobo = midRange[Math.floor(midRange.length / 2)] || validMobos[Math.floor(validMobos.length / 2)];
                } else if (budget > 80000) {
                    // Budget: 8k-18k boards
                    let budgetRange = validMobos.filter(m => m.price >= 8000 && m.price <= 18000);
                    mobo = budgetRange[Math.floor(budgetRange.length / 3)] || validMobos[Math.floor(validMobos.length / 3)];
                } else {
                    // Very low budget: cheapest compatible boards
                    let lowBudget = validMobos.filter(m => m.price < 10000);
                    mobo = lowBudget[Math.floor(lowBudget.length / 2)] || validMobos[0];
                }

                // Smart RAM selection based on motherboard and usage
                let validRam = db.ram.filter(r => {
                    // Check DDR generation compatibility
                    if (mobo.name.includes('DDR5')) return r.name.includes('DDR5');
                    if (mobo.name.includes('DDR4')) return r.name.includes('DDR4');
                    return true;
                });
                if (validRam.length === 0) validRam = db.ram;
                
                // Determine optimal RAM based on usage
                let targetRamSize = '16GB';
                if (usage === 'content' || usage === 'productivity') {
                    if (budget > 250000) targetRamSize = '64GB';
                    else if (budget > 120000) targetRamSize = '32GB';
                    else targetRamSize = '16GB';
                } else if (usage === 'gaming') {
                    if (budget > 200000) targetRamSize = '32GB';
                    else targetRamSize = '16GB';
                } else {
                    if (budget > 300000) targetRamSize = '32GB';
                    else targetRamSize = '16GB';
                }
                
                // Find RAM matching target size with good speed
                let targetRam = validRam.filter(r => r.name.includes(targetRamSize));
                if (targetRam.length > 0) {
                    // Prefer higher speed RAM for gaming
                    if (usage === 'gaming') {
                        ram = targetRam.sort((a, b) => {
                            const speedA = parseInt(a.name.match(/\d{4,5}MHz/)?.[0] || 3200);
                            const speedB = parseInt(b.name.match(/\d{4,5}MHz/)?.[0] || 3200);
                            return speedB - speedA;
                        })[0];
                    } else {
                        // For other uses, balance speed and price
                        ram = targetRam.sort((a, b) => a.price - b.price)[Math.floor(targetRam.length / 2)];
                    }
                } else {
                    ram = validRam.sort((a, b) => b.price - a.price)[0];
                }
                if (ram.price < 1500) ram = validRam[1] || validRam[0];

                // Intelligent storage selection
                let targetCapacity = '500GB';
                let needSpeed = usage === 'gaming' || usage === 'content' || usage === 'coding';
                
                if (budget > 300000) targetCapacity = '2TB';
                else if (budget > 150000) targetCapacity = '1TB';
                else if (budget > 80000) targetCapacity = '500GB';
                else targetCapacity = '256GB';
                
                // Prioritize NVMe Gen4 for high-end, Gen3 for mid-range
                let storageOptions = db.storage.filter(s => {
                    const hasTargetCapacity = s.name.includes(targetCapacity);
                    if (needSpeed) {
                        if (budget > 200000) return hasTargetCapacity && s.name.includes('Gen4');
                        else if (budget > 80000) return hasTargetCapacity && s.name.includes('NVMe');
                        else return hasTargetCapacity && s.name.includes('SSD');
                    }
                    return hasTargetCapacity;
                });
                
                if (storageOptions.length === 0) {
                    storageOptions = db.storage.filter(s => s.name.includes(targetCapacity));
                }
                
                if (storageOptions.length > 0) {
                    // Choose mid-range option for best value
                    storage = storageOptions.sort((a, b) => a.price - b.price)[Math.floor(storageOptions.length / 2)] || storageOptions[0];
                } else {
                    storage = db.storage[2];
                }

                // Intelligent PSU selection based on component power draw
                let estimatedWattage = 100; // Base system
                
                // Add CPU TDP
                if (cpu.tdp) {
                    const cpuWatts = parseInt(cpu.tdp.match(/\d+/)?.[0] || 65);
                    estimatedWattage += cpuWatts;
                }
                
                // Add GPU TDP
                if (gpu.tdp) {
                    const gpuWatts = parseInt(gpu.tdp.match(/\d+/)?.[0] || 150);
                    estimatedWattage += gpuWatts;
                } else if (gpu.price > 80000) {
                    estimatedWattage += 400; // High-end GPU estimate
                } else if (gpu.price > 40000) {
                    estimatedWattage += 250;
                } else if (gpu.price > 20000) {
                    estimatedWattage += 150;
                }
                
                // Add 20% headroom for efficiency and future upgrades
                const recommendedWattage = Math.ceil(estimatedWattage * 1.2);
                
                // Select PSU with appropriate wattage
                let validPSUs = db.psu.filter(p => {
                    const psuWattage = parseInt(p.name.match(/\d+W/)?.[0] || 500);
                    return psuWattage >= recommendedWattage;
                });
                
                if (validPSUs.length === 0) validPSUs = db.psu;
                
                // Choose PSU based on budget and efficiency
                if (budget > 300000) {
                    psu = validPSUs.filter(p => p.name.includes('Platinum') || p.name.includes('Titanium')).sort((a,b) => b.price - a.price)[0] || validPSUs[Math.floor(validPSUs.length * 0.7)];
                } else if (budget > 150000) {
                    psu = validPSUs.filter(p => p.name.includes('Gold')).sort((a,b) => a.price - b.price)[Math.floor(validPSUs.filter(p => p.name.includes('Gold')).length / 2)] || validPSUs[Math.floor(validPSUs.length / 2)];
                } else {
                    psu = validPSUs.sort((a,b) => a.price - b.price)[Math.floor(validPSUs.length / 3)] || validPSUs[0];
                }

                if (budget > 350000) userCase = db.case[7];
                else if (budget > 200000) userCase = db.case[6];
                else if (budget > 100000) userCase = db.case[4];
                else userCase = db.case[2];

                // --- CRITICAL BUDGET CHECK & DOWNGRADE LOGIC ---
                let totalCost = cpu.price + gpu.price + mobo.price + ram.price + storage.price + psu.price + userCase.price;
                
                // If Over Budget, Downgrade GPU first (most expensive part usually)
                while (totalCost > budget) {
                    // Try downgrading GPU
                    let currentGpuIndex = db.gpus.findIndex(g => g.id === gpu.id);
                    if (currentGpuIndex > 1) { // Don't go below entry discrete
                        let nextGpu = db.gpus[currentGpuIndex - 1];
                        if (nextGpu.price < gpu.price) {
                            gpu = nextGpu;
                            totalCost = cpu.price + gpu.price + mobo.price + ram.price + storage.price + psu.price + userCase.price;
                            continue;
                        }
                    }
                    
                    // If GPU can't go lower or still over budget, try CPU
                    let currentCpuIndex = db.cpus.findIndex(c => c.id === cpu.id);
                    if (currentCpuIndex > 2) {
                         let nextCpu = db.cpus[currentCpuIndex - 1];
                         // Ensure socket compatibility matches mobo or re-pick mobo
                         if (nextCpu.socket === mobo.socket && nextCpu.price < cpu.price) {
                             cpu = nextCpu;
                             totalCost = cpu.price + gpu.price + mobo.price + ram.price + storage.price + psu.price + userCase.price;
                             continue;
                         }
                    }

                    // Last Resort: Downgrade RAM/Storage/Case to basic
                    if (ram.price > 2000) ram = validRam[0];
                    if (storage.price > 3000) storage = db.storage[0];
                    if (userCase.price > 2000) userCase = db.case[0];
                    
                    // Re-calc and break to avoid infinite loop if impossible
                    totalCost = cpu.price + gpu.price + mobo.price + ram.price + storage.price + psu.price + userCase.price;
                    break; 
                }

                // Generate intelligent build reasoning with validation
                let warnings = [];
                let highlights = [];
                
                // CPU-GPU balance check
                if (usage === 'gaming') {
                    const cpuGpuRatio = cpu.price / gpu.price;
                    if (cpuGpuRatio > 1.8) warnings.push('CPU is significantly more expensive than GPU - may not be optimal for gaming');
                    if (cpuGpuRatio < 0.25) warnings.push('GPU may experience bottleneck with this CPU at high resolutions');
                }
                
                // Power supply validation
                const psuWattage = parseInt(psu.name.match(/\d+W/)?.[0] || 500);
                const cpuTdp = parseInt(cpu.tdp?.match(/\d+/)?.[0] || 65);
                const gpuTdp = parseInt(gpu.tdp?.match(/\d+/)?.[0] || 150);
                const totalTdp = cpuTdp + gpuTdp + 100;
                if (psuWattage < totalTdp * 1.1) warnings.push('PSU may be close to limit under full load');
                
                // Highlight key features
                if (gpu.vram && parseInt(gpu.vram) >= 12) highlights.push(`${gpu.vram} VRAM for excellent gaming at high resolutions`);
                if (cpu.cores && parseInt(cpu.cores) >= 12) highlights.push(`${cpu.cores} cores for exceptional multitasking`);
                if (ram.name.includes('32GB') || ram.name.includes('64GB')) highlights.push(`${ram.name.match(/\d+GB/)?.[0]} RAM for professional workloads`);
                if (storage.name.includes('Gen4')) highlights.push('PCIe Gen4 NVMe for blazing fast storage');
                
                // Build comprehensive reasoning
                buildReason = `🎯 ${usage.charAt(0).toUpperCase() + usage.slice(1)} Build Complete!\n\n`;
                buildReason += `💻 Core Components:\n`;
                buildReason += `• CPU: ${cpu.name} (${cpu.cores || 'Multi'}-core${cpu.threads ? ', ' + cpu.threads + ' threads' : ''})\n`;
                buildReason += `• GPU: ${gpu.name} (${gpu.vram || 'Dedicated graphics'})\n`;
                buildReason += `• Motherboard: ${mobo.socket} socket with ${mobo.name.includes('DDR5') ? 'DDR5' : 'DDR4'} support\n\n`;
                
                if (usage === 'gaming') {
                    buildReason += `🎮 Gaming Performance:\n`;
                    if (gpu.vram) {
                        const vram = parseInt(gpu.vram);
                        if (vram >= 16) buildReason += `• Excellent 4K gaming with ray tracing\n`;
                        else if (vram >= 12) buildReason += `• Smooth 1440p-4K gaming experience\n`;
                        else if (vram >= 8) buildReason += `• Great 1080p-1440p gaming\n`;
                        else buildReason += `• Solid 1080p gaming performance\n`;
                    }
                } else if (usage === 'content') {
                    buildReason += `🎨 Content Creation:\n`;
                    buildReason += `• GPU-accelerated rendering and editing\n`;
                    buildReason += `• Multi-core CPU for fast exports\n`;
                } else if (usage === 'coding') {
                    buildReason += `👨‍💻 Development:\n`;
                    buildReason += `• Fast compilation with ${cpu.cores}+ cores\n`;
                    buildReason += `• Plenty of RAM for VMs and containers\n`;
                }
                
                if (highlights.length > 0) {
                    buildReason += `\n✨ Key Features:\n`;
                    highlights.forEach(h => buildReason += `• ${h}\n`);
                }
                
                buildReason += `\n⚡ Power: ${psu.name} (${psuWattage}W) provides ${Math.round((psuWattage/totalTdp - 1) * 100)}% power headroom\n`;
                buildReason += `💾 Storage: ${storage.name} for fast boot and load times\n`;
                buildReason += `\n💰 Total: ₹${totalCost.toLocaleString('en-IN')} (${((totalCost/budget)*100).toFixed(1)}% of budget)`;
                
                if (warnings.length > 0) {
                    buildReason += `\n\n⚠️ Notes:\n`;
                    warnings.forEach(w => buildReason += `• ${w}\n`);
                }
            }

            state.currentBuild = { type: 'desktop', data: { cpu, gpu, mobo, ram, storage, psu, userCase } };
            document.getElementById('build-reasoning').innerText = buildReason;
            renderResults();
        }

        // --- 5. RENDER FUNCTIONS ---
        function renderResults() {
            const container = document.getElementById('parts-container');
            const res = state.currentBuild;

            document.getElementById('view-wizard').classList.add('hidden');
            document.getElementById('view-results').classList.remove('hidden');
            document.getElementById('res-usage').innerText = state.usage;
            document.getElementById('res-budget').innerHTML = '<span style="font-size: 0.9em; opacity: 0.9;">₹</span>' + state.budget.toLocaleString('en-IN');

            renderBenchmarks(res);

            if (res.type === 'laptop') {
                const laptops = res.data;
                document.getElementById('total-price').innerText = "Multiple Options";
                
                let html = '<div class="grid grid-cols-1 md:grid-cols-3 gap-6 p-6">';
                laptops.forEach((laptop, index) => {
                    const borderClass = index === 0 ? 'border-blue-500 ring-2 ring-blue-500/20' : 'border-slate-200';
                    const badge = index === 0 ? '<div class="absolute top-4 right-4 bg-blue-600 text-white px-3 py-1 rounded-full text-xs font-bold">Top Pick</div>' : '';

                    html += `
                    <div class="bg-white rounded-xl border ${borderClass} shadow-sm p-6 relative flex flex-col h-full hover:shadow-md transition">
                        ${badge}
                        <div class="text-center mb-4">
                            <i class="fa-solid fa-laptop text-4xl text-slate-400 mb-4"></i>
                            <h3 class="font-bold text-slate-800 text-lg leading-tight mb-1">${laptop.name}</h3>
                            <span class="text-xs font-bold text-blue-600 uppercase tracking-wider">${laptop.type} Class</span>
                        </div>
                        <div class="flex-1 space-y-3 mb-6">
                             <div class="bg-slate-50 p-3 rounded-lg text-sm text-slate-600">
                                <span class="block text-xs font-bold text-slate-400 uppercase">Specs</span>
                                ${laptop.spec}
                             </div>
                             <div class="bg-slate-50 p-3 rounded-lg text-sm text-slate-600">
                                <span class="block text-xs font-bold text-slate-400 uppercase">Est. Price</span>
                                <span style="font-size: 0.8em; opacity: 0.8;">₹</span>${laptop.price.toLocaleString('en-IN')}
                             </div>
                        </div>
                        <button onclick='openShopModal(${JSON.stringify(laptop.shopLinks)}, "${laptop.name.replace(/'/g, "\\'")}")' class="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 rounded-lg font-bold text-sm hover:from-blue-700 hover:to-purple-700 transition shadow-md hover:shadow-lg"><i class="fa-solid fa-store text-lg"></i> Compare & Buy</button>
                    </div>`;
                });
                html += '</div>';
                container.innerHTML = html;
            } else {
                const b = res.data;
                const total = Object.values(b).reduce((acc, part) => acc + part.price, 0);
                document.getElementById('total-price').innerHTML = '<span style="font-size: 0.7em; opacity: 0.8;">₹</span>' + total.toLocaleString('en-IN');

                const parts = [
                    { type: 'CPU', icon: 'fa-microchip', data: b.cpu },
                    { type: 'GPU', icon: 'fa-display', data: b.gpu },
                    { type: 'Motherboard', icon: 'fa-chess-board', data: b.mobo },
                    { type: 'Memory', icon: 'fa-memory', data: b.ram },
                    { type: 'Storage', icon: 'fa-hard-drive', data: b.storage },
                    { type: 'Power Supply', icon: 'fa-plug', data: b.psu },
                    { type: 'Case', icon: 'fa-box', data: b.userCase },
                ];

                let html = '';
                parts.forEach(p => {
                    html += `
                    <div class="flex items-center gap-4 p-4 border-b border-slate-100 last:border-0 hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 transition-all duration-300 rounded-lg group">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-100 to-purple-100 rounded-lg flex items-center justify-center text-blue-600 text-xl group-hover:scale-110 transition-transform">
                            <i class="fa-solid ${p.icon}"></i>
                        </div>
                        <div class="flex-1">
                            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">${p.type}</div>
                            <div class="font-bold text-slate-800 text-lg">${p.data.name}</div>
                            ${p.type === 'Motherboard' ? `<div class="text-xs text-green-600 mt-1"><i class="fa-solid fa-check-circle"></i> Socket Match: ${p.data.socket}</div>` : ''}
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-lg ${p.data.price === 0 ? 'text-green-600' : 'text-slate-800'}">
                                ${p.data.price === 0 ? '<span class="flex items-center gap-1"><i class="fa-solid fa-gift"></i> Included</span>' : '<span class="text-green-600" style="font-size: 14px;">₹</span>' + p.data.price.toLocaleString('en-IN')}
                            </div>
                            ${p.data.price > 0 && p.data.shopLinks ? '<button onclick=\'openShopModal(' + JSON.stringify(p.data.shopLinks) + ', "' + p.data.name.replace(/'/g, "\\'") + '")\' class="inline-flex items-center gap-1 text-xs text-blue-600 font-bold hover:text-blue-700 mt-1 bg-blue-50 px-3 py-1 rounded-full hover:bg-blue-100 transition"><i class="fa-solid fa-store"></i> Compare & Buy</button>' : ''}
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
            }
        }

        function renderBenchmarks(res) {
            let tier = 'integrated';
            if (res.type === 'laptop') {
                tier = res.data[0].gpuTier || 'integrated';
            } else {
                tier = res.data.gpu.tier || 'integrated';
            }

            const usageType = state.usage; 
            const categoryData = PERFORMANCE_METRICS[usageType] || PERFORMANCE_METRICS.gaming;
            const metricsList = categoryData.metrics[tier] || categoryData.metrics.integrated;

            document.getElementById('perf-icon').innerHTML = categoryData.icon;
            document.getElementById('perf-title').innerHTML = categoryData.label + ' <i class="fa-solid fa-chart-line ml-2 text-sm"></i>';

            const container = document.getElementById('benchmark-cards');
            container.innerHTML = '';

            metricsList.forEach(metric => {
                container.innerHTML += `
                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm text-center">
                        <div class="font-bold text-slate-800 mb-1">${metric.name}</div>
                        <div class="text-2xl font-black ${metric.color}">${metric.value}</div>
                    </div>`;
            });
        }

        // --- 6. CHAT FUNCTIONS ---
        function toggleAI() {
            document.getElementById('ai-chat-panel').classList.toggle('translate-y-[120%]');
        }

        function toggleLiveSupport() {
            const panel = document.getElementById('live-support-panel');
            if (panel) {
                panel.classList.toggle('hidden');
                // Scroll to top of expert chat when opening
                if (!panel.classList.contains('hidden')) {
                    const messages = document.getElementById('expert-chat-messages');
                    if (messages) {
                        messages.scrollTop = messages.scrollHeight;
                    }
                }
            }
        }

        function handleChat(e) {
            if (e.key === 'Enter') sendMessage();
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const rawText = input.value.trim();
            if(!rawText) return;

            // Sanitize input
            const txt = Security.sanitizeHTML(rawText).toLowerCase();
            
            // Rate limiting
            if (!Security.rateLimit.check()) {
                addChatMsg('Please wait a moment before sending another message.', 'ai');
                return;
            }

            addChatMsg(rawText, 'user');
            input.value = '';

            // Show typing indicator
            const typingId = addTypingIndicator();

            setTimeout(() => {
                removeTypingIndicator(typingId);
                const response = generateIntelligentResponse(txt, rawText);
                addChatMsg(response, 'ai');
            }, 600 + Math.random() * 400); // Natural typing delay
        }

        function generateIntelligentResponse(txt, originalText) {
            // Context-aware response system with human-like responses
            
            // Greetings
            if (/\b(hello|hi|hey|greetings)\b/.test(txt)) {
                const greetings = [
                    "Hey! 👋 Good to have you here. I've been building PCs for years and I'm happy to help. What's on your mind?",
                    "Hi there! Whether you're building your first PC or upgrading, I've got you covered. What do you need help with?",
                    "Hey! 🙂 Ready to help you find the perfect setup. Got a specific question or just browsing?"
                ];
                return greetings[Math.floor(Math.random() * greetings.length)];
            }

            // Budget-related queries
            if (/budget|price|cost|afford|spend|money|expensive|cheap/i.test(txt)) {
                const budgetMatch = txt.match(/(\d+)k|₹\s*(\d+)|rs\s*(\d+)/);
                if (budgetMatch) {
                    const amount = (parseInt(budgetMatch[1] || budgetMatch[2] || budgetMatch[3]) || 50) * 1000;
                    if (amount < 20000) {
                        return `Hmm, ₹${amount.toLocaleString('en-IN')} is tight, but not impossible!\n\nHonestly, at this budget I'd suggest:\n• A refurbished ThinkPad (great value)\n• Or an AMD Athlon APU build if desktop\n\nYou won't be gaming, but for browsing, Office work, and light coding — totally doable. Want me to show you a build?`;
                    } else if (amount < 50000) {
                        return `₹${amount.toLocaleString('en-IN')} is actually a sweet spot! You've got options.\n\nFor a desktop, the AMD 5600G is brilliant — no graphics card needed, plays most games at 1080p medium.\n\nFor laptop, look at Ryzen 5 models with Vega graphics.\n\nWhat are you mainly going to use it for?`;
                    } else if (amount < 100000) {
                        return `Nice budget! ₹${amount.toLocaleString('en-IN')} opens up some really solid builds.\n\nYou're looking at:\n• RTX 4060 territory for gaming\n• i5/Ryzen 5 + decent GPU combo\n• 1080p high settings, easy\n\nGaming, work, or a bit of both?`;
                    } else {
                        return `₹${amount.toLocaleString('en-IN')}+ — now we're talking! 🔥\n\nAt this budget, you can go all out:\n• RTX 4070/4080 for 1440p or 4K\n• Ryzen 7/i7 or even higher\n• DDR5 RAM, fast NVMe storage\n\nAre you going for pure gaming performance, or do you need workstation power too?`;
                    }
                }
                
                if (state.budget) {
                    return `Your budget is ₹${state.budget.toLocaleString('en-IN')} — solid choice.\n\nQuick tip: For gaming, put most money into GPU (around 40%). For editing/rendering, balance CPU and GPU equally.\n\nWant me to break down how I'd spend this budget?`;
                }
                
                return "Budget's the most important factor! Here's my rough guide:\n\n• Under ₹30K: APU builds, basic work\n• ₹30-60K: Entry gaming, RTX 4060\n• ₹60-100K: Solid 1080p/1440p gaming\n• ₹100K+: High refresh 1440p or 4K\n\nWhat's your range?";
            }

            // Component compatibility
            if (/compatib|work.*together|match|fit|socket|support/i.test(txt)) {
                if (state.currentBuild && state.currentBuild.type === 'desktop') {
                    const build = state.currentBuild.data;
                    return `✅ Compatibility Check for your build:\n\n🔌 CPU-Mobo: ${build.cpu.socket} socket - ✓ Compatible\n💾 RAM-Mobo: DDR${build.mobo.name.includes('DDR5') ? '5' : '4'} - ✓ Compatible\n⚡ PSU: ${build.psu.name} - ✓ Adequate for components\n📦 All components fit standard ATX cases\n\nEverything looks good! Any specific concerns?`;
                }
                return "🔍 To check compatibility, I need to know:\n• CPU socket type (AM4, AM5, LGA1700, etc.)\n• Motherboard chipset\n• RAM generation (DDR4/DDR5)\n• PSU wattage vs. component TDP\n\nGenerate a build first, or tell me your components!";
            }

            // Performance queries
            if (/fps|frame.*rate|perform|benchmark|how.*fast|speed|run/i.test(txt)) {
                if (txt.includes('4k') || txt.includes('2160p')) {
                    return "🎮 4K Gaming Performance:\n• RTX 4080+: 60-120 FPS (AAA titles)\n• RTX 4070 Ti: 50-80 FPS (high settings)\n• RTX 4060 Ti: 30-50 FPS (medium settings)\n\nPair with Ryzen 7/i7+ to avoid bottlenecks!\n\nBudget needed: ₹1,50,000+";
                } else if (txt.includes('1440p')) {
                    return "🎮 1440p Gaming Performance:\n• RTX 4070: 100-144 FPS (AAA titles)\n• RTX 4060 Ti: 80-120 FPS (high settings)\n• RTX 4060: 60-90 FPS (medium-high)\n\nSweet spot for price-performance!\n\nBudget: ₹80,000-₹1,50,000";
                } else {
                    return "🎮 1080p Gaming Performance:\n• RTX 4060: 120-200+ FPS (most games)\n• RTX 4050: 80-120 FPS (high settings)\n• GTX 1650: 50-80 FPS (medium settings)\n\nAll paired with Ryzen 5/i5 or better.\n\nBudget: ₹50,000-₹1,00,000";
                }
            }

            // Specific component queries - GPU
            if (/gpu|graphics.*card|rtx|gtx|radeon|rx|vram|video.*card/i.test(txt)) {
                if (/4090/i.test(txt)) {
                    return "🚀 RTX 4090 - The Absolute Beast!\n• VRAM: 24GB GDDR6X\n• Performance: 4K gaming at 120+ FPS\n• Price: ₹1,70,000 - ₹2,00,000\n• TDP: 450W (needs 850W+ PSU)\n\n⚠️ Pair with Ryzen 9 7950X or i9-14900K to avoid bottlenecks!";
                } else if (/4080/i.test(txt)) {
                    return "💎 RTX 4080 - Enthusiast Powerhouse\n• VRAM: 16GB GDDR6X\n• Performance: 4K @ 100+ FPS, 1440p @ 165+ FPS\n• Price: ₹1,10,000 - ₹1,30,000\n• TDP: 320W (needs 750W+ PSU)\n\n✨ Best for 4K gaming without breaking the bank!";
                } else if (/4070/i.test(txt)) {
                    return "⭐ RTX 4070/4070 Ti - Sweet Spot\n• VRAM: 12GB GDDR6X\n• Performance: 1440p @ 120+ FPS, 4K @ 60+ FPS\n• Price: ₹55,000 - ₹75,000\n• TDP: 200-285W (needs 650W PSU)\n\n🎯 Perfect balance of price and performance!";
                } else if (/4060/i.test(txt)) {
                    return "🎮 RTX 4060/4060 Ti - Value King\n• VRAM: 8GB/16GB GDDR6\n• Performance: 1080p @ 144+ FPS, 1440p @ 80+ FPS\n• Price: ₹32,000 - ₹48,000\n• TDP: 160-170W (needs 550W PSU)\n\n💰 Best value for 1080p-1440p gaming!";
                } else if (/amd|radeon|rx/i.test(txt)) {
                    return "🔴 AMD Radeon Options:\n• RX 7900 XTX: Competes with RTX 4080 (₹95k-₹1.1L)\n• RX 7800 XT: Between 4070-4070 Ti (₹50k-₹60k)\n• RX 7600: Entry 1080p gaming (₹25k-₹30k)\n\n✨ Great value, excellent rasterization, more VRAM!\n⚠️ Ray tracing not as strong as NVIDIA.";
                } else {
                    return "🎮 GPU Selection Guide:\n\n💎 Budget:\n• ₹25k-₹35k: RTX 4060, RX 7600 (1080p)\n• ₹40k-₹60k: RTX 4060 Ti, RX 7700 XT (1440p)\n• ₹65k-₹90k: RTX 4070 Ti, RX 7800 XT (1440p-4K)\n• ₹1L+: RTX 4080/4090 (4K ultra)\n\n🎯 Gaming: Prioritize VRAM (8GB min, 12GB+ ideal)\n🎨 Content: 12GB+ for rendering\n\nWhat's your budget and resolution target?";
                }
            }

            // Specific component queries - CPU
            if (/cpu|processor|ryzen|intel|core.*i[3579]|thread|clock.*speed/i.test(txt)) {
                if (/gaming/i.test(txt)) {
                    return "🎮 Gaming CPU Recommendations:\n\n⭐ Best: Ryzen 7 7800X3D (₹35k-₹40k)\n• 8 cores, 3D V-Cache = best gaming CPU\n\n💎 Great: i5-14600K or Ryzen 5 7600X (₹25k-₹30k)\n• 6 cores sufficient for most games\n\n💰 Budget: i3-13100F or Ryzen 5 5600 (₹8k-₹12k)\n• Solid 1080p gaming performance\n\n🔑 Gaming needs: 6+ cores, high single-thread speed";
                } else if (/content|render|edit|stream/i.test(txt)) {
                    return "🎨 Content Creation CPU Recommendations:\n\n🚀 Pro: Ryzen 9 7950X or i9-14900K (₹45k-₹60k)\n• 16-24 cores for fast rendering\n\n⭐ Great: Ryzen 7 7700X or i7-14700K (₹30k-₹40k)\n• 8-12 cores, excellent multitasking\n\n💰 Budget: Ryzen 5 7600 (₹18k-₹22k)\n• 6 cores, good for light editing\n\n🔑 Content needs: More cores = faster exports!";
                } else {
                    return "💻 CPU Selection Guide:\n\n🎮 Gaming: 6-8 cores, high clock speed\n• Ryzen 7800X3D, i5-14600K\n\n🎨 Content: 12-16 cores, multi-thread\n• Ryzen 9 7950X, i9-14900K\n\n💼 Productivity: 8-12 cores, balanced\n• Ryzen 7 7700X, i7-14700K\n\n💰 Budget: 4-6 cores\n• Ryzen 5 5600, i3-13100F\n\nWhat's your primary use case?";
                }
            }

            // RAM queries
            if (/ram|memory|ddr4|ddr5|gb.*ram|how.*much.*ram/i.test(txt)) {
                return "🧠 RAM Recommendations:\n\n🎮 Gaming:\n• 16GB DDR4/DDR5 (minimum)\n• 32GB for AAA titles + multitasking\n• 3200MHz+ DDR4 or 5600MHz+ DDR5\n\n🎨 Content Creation:\n• 32GB minimum (4K editing)\n• 64GB for heavy projects\n• Speed matters less, capacity first\n\n💼 Productivity:\n• 16GB for office work\n• 32GB for VMs/development\n\n💰 Prices:\n• 16GB DDR4: ₹3k-₹5k\n• 32GB DDR5: ₹10k-₹15k";
            }

            // Storage queries
            if (/ssd|nvme|storage|hard.*drive|hdd|gen4|m\.2/i.test(txt)) {
                return "💾 Storage Recommendations:\n\n⚡ Best: PCIe Gen4 NVMe SSD\n• 7000+ MB/s read speeds\n• WD Black SN850X, Samsung 990 Pro\n• ₹6k-₹10k for 1TB\n\n✨ Great: PCIe Gen3 NVMe SSD\n• 3500+ MB/s, excellent value\n• WD Blue SN570, Samsung 980\n• ₹4k-₹6k for 1TB\n\n💰 Budget: SATA SSD\n• 550 MB/s, still way better than HDD\n• ₹2.5k-₹4k for 1TB\n\n📊 Capacity:\n• 500GB: OS + few games\n• 1TB: Recommended minimum\n• 2TB: Ideal for large game libraries";
            }

            // PSU queries
            if (/psu|power.*supply|watt|efficiency|80.*plus|gold|platinum/i.test(txt)) {
                if (state.currentBuild && state.currentBuild.type === 'desktop') {
                    const build = state.currentBuild.data;
                    const cpuTdp = parseInt(build.cpu.tdp?.match(/\d+/)?.[0] || 65);
                    const gpuTdp = parseInt(build.gpu.tdp?.match(/\d+/)?.[0] || 150);
                    const totalTdp = cpuTdp + gpuTdp + 100;
                    const recommended = Math.ceil(totalTdp * 1.2);
                    
                    return `⚡ PSU Analysis for Your Build:\n\n📊 Power Requirements:\n• CPU: ${cpuTdp}W\n• GPU: ${gpuTdp}W\n• System: 100W\n• Total: ${totalTdp}W\n\n✅ Recommended: ${recommended}W+ (20% headroom)\n\n🏆 Quality:\n• 80+ Gold: Best value\n• 80+ Platinum: High efficiency\n• Brands: Corsair, Seasonic, EVGA\n\nCurrent PSU: ${build.psu.name}`;
                }
                
                return "⚡ PSU Selection Guide:\n\n🎯 Wattage:\n• Budget build: 450-550W\n• Mid-range: 650-750W\n• High-end: 850W+\n• RTX 4090: 1000W+\n\n🏆 Efficiency:\n• 80+ Bronze: Basic\n• 80+ Gold: Best value ⭐\n• 80+ Platinum: High efficiency\n\n💡 Rule: (CPU TDP + GPU TDP + 100W) × 1.2\n\n✅ Trusted Brands:\nCorsair, Seasonic, EVGA, Cooler Master";
            }

            // Laptop specific queries
            if (/laptop|notebook|portable|mobile/i.test(txt)) {
                if (/gaming.*laptop|laptop.*gaming/i.test(txt)) {
                    return "🎮 Gaming Laptop Guide:\n\n💎 Premium (₹1.5L+):\n• RTX 4070+, 165Hz screen\n• ASUS ROG, MSI Raider, Legion 7\n\n⭐ Mid-Range (₹80k-₹1.5L):\n• RTX 4060, 144Hz screen\n• Legion 5, TUF A15, Nitro 5\n\n💰 Budget (₹50k-₹80k):\n• RTX 4050/3050, 120Hz\n• Victus, IdeaPad Gaming\n\n🔑 Must-haves:\n• 144Hz+ display\n• 16GB RAM (upgradeable)\n• Good cooling system";
                } else if (/productivity|work|office/i.test(txt)) {
                    return "💼 Productivity Laptop Guide:\n\n🏆 Premium (₹1L+):\n• ThinkPad X1, Dell XPS, MacBook Air M2\n• 16GB+ RAM, 512GB+ SSD\n• 10+ hour battery\n\n⭐ Mid-Range (₹50k-₹1L):\n• ThinkPad E/T series, HP EliteBook\n• 8-16GB RAM, good keyboard\n\n💰 Budget (₹30k-₹50k):\n• IdeaPad, Inspiron, VivoBook\n• 8GB RAM, basic needs\n\n🔑 Priorities:\n• Battery life > Performance\n• Build quality matters\n• Good keyboard & trackpad";
                } else {
                    return "💻 Laptop vs Desktop:\n\n✅ Choose Laptop if:\n• Need portability\n• College/travel frequently\n• Limited desk space\n\n✅ Choose Desktop if:\n• Gaming/heavy work\n• Need upgradability\n• Better price-performance\n\n🎮 Gaming: Desktop = 30-40% better value\n💼 Work: Laptop = better flexibility\n\nWhat's your priority? Performance or portability?";
                }
            }

            // Build review/help
            if (/review|check|suggest|recommend|help.*build|good.*build/i.test(txt)) {
                if (state.currentBuild) {
                    if (state.currentBuild.type === 'laptop') {
                        const best = state.currentBuild.data[0];
                        return `📊 Your Laptop Selection Analysis:\n\n✅ Top Pick: ${best.name}\n• Price: ₹${best.price.toLocaleString('en-IN')}\n• Usage: ${state.usage}\n• Specs: ${best.spec}\n\n${best.aiScore ? `🎯 AI Score: ${best.aiScore}/100` : ''}\n\n💡 This laptop ${best.aiScore > 80 ? 'is an excellent match' : 'fits your needs well'} for ${state.usage} tasks!\n\nWant alternatives or have specific questions?`;
                    } else {
                        const build = state.currentBuild.data;
                        return `📊 Your Desktop Build Analysis:\n\n✅ Components:\n• CPU: ${build.cpu.name}\n• GPU: ${build.gpu.name}\n• RAM: ${build.ram.name}\n• Storage: ${build.storage.name}\n\n🎯 Usage: ${state.usage}\n💰 Budget: ₹${state.budget.toLocaleString('en-IN')}\n\n✨ This build is optimized for ${state.usage} with balanced performance!\n\nNeed component upgrades or have compatibility questions?`;
                    }
                }
                return "🤔 I can help you build the perfect PC!\n\n1️⃣ Tell me your budget (₹50,000? ₹1,00,000?)\n2️⃣ What's your use case? (Gaming, editing, work?)\n3️⃣ Any brand preferences? (Intel/AMD, NVIDIA/AMD)\n\nOr use the wizard above to generate a build, then I can review it for you!";
            }

            // Upgrade queries
            if (/upgrade|improve|better|replace|swap/i.test(txt)) {
                return "⬆️ Upgrade Priority Guide:\n\n🎮 Gaming PC:\n1. GPU (biggest FPS boost)\n2. CPU (if bottlenecking)\n3. RAM (16GB → 32GB)\n4. Storage (HDD → SSD)\n\n🎨 Content Creation:\n1. RAM (32GB → 64GB)\n2. CPU (more cores)\n3. Storage (larger/faster SSD)\n4. GPU (rendering acceleration)\n\n💡 General Rule:\n• Upgrade GPU every 3-4 years\n• CPU every 5-6 years\n• RAM/Storage as needed\n\nWhat component are you thinking of upgrading?";
            }

            // Thanks/goodbye
            if (/thank|thanks|appreciate|bye|goodbye/i.test(txt)) {
                return "😊 You're welcome! Happy building!\n\nFeel free to ask if you have more questions. Good luck with your new PC! 🚀";
            }

            // Generic game-specific queries
            if (/fortnite|pubg|valorant|apex|warzone|gta|cyberpunk|minecraft/i.test(txt)) {
                const game = txt.match(/fortnite|pubg|valorant|apex|warzone|gta|cyberpunk|minecraft/i)?.[0];
                const specs = {
                    fortnite: { gpu: 'RTX 4050+', cpu: 'Ryzen 5/i5', ram: '16GB', budget: '₹60k+' },
                    valorant: { gpu: 'RTX 4050', cpu: 'Ryzen 5/i5', ram: '8GB', budget: '₹50k+' },
                    cyberpunk: { gpu: 'RTX 4070+', cpu: 'Ryzen 7/i7', ram: '16GB', budget: '₹1.2L+' },
                    gta: { gpu: 'RTX 4060', cpu: 'Ryzen 5/i5', ram: '16GB', budget: '₹75k+' },
                    minecraft: { gpu: 'RTX 4050', cpu: 'Ryzen 5/i5', ram: '8GB', budget: '₹45k+' },
                    warzone: { gpu: 'RTX 4060', cpu: 'Ryzen 5/i5', ram: '16GB', budget: '₹80k+' },
                };
                
                const spec = specs[game.toLowerCase()] || { gpu: 'RTX 4060', cpu: 'Ryzen 5/i5', ram: '16GB', budget: '₹70k+' };
                
                return `🎮 ${game.charAt(0).toUpperCase() + game.slice(1)} Requirements:\n\n📊 Recommended:\n• GPU: ${spec.gpu}\n• CPU: ${spec.cpu}\n• RAM: ${spec.ram}\n• Budget: ${spec.budget}\n\n✨ For 1080p 144fps+ at high settings!\n\nWant a specific build for this game?`;
            }

            // Fallback with helpful suggestions
            return "🤔 I'm not sure I understood that completely.\n\n💡 I can help with:\n• 💰 Budget recommendations\n• 🔧 Component selection (CPU, GPU, RAM, etc.)\n• 🎮 Gaming performance estimates\n• ✅ Compatibility checking\n• ⬆️ Upgrade suggestions\n• 💻 Laptop recommendations\n\nTry asking:\n• \"What GPU for ₹50k?\"\n• \"Is my build compatible?\"\n• \"Can it run Cyberpunk?\"\n• \"Should I upgrade my CPU?\"";
        }

        function addTypingIndicator() {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            const id = 'typing-' + Date.now();
            div.id = id;
            div.className = 'flex gap-2 chat-msg';
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 text-xs">
                    <i class="fa-solid fa-robot"></i>
                </div>
                <div class="bg-white border-slate-100 p-3 rounded-2xl rounded-tl-none shadow-sm text-sm border flex gap-1 items-center">
                    <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                    <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                    <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                </div>
            `;
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
            return id;
        }

        function removeTypingIndicator(id) {
            const indicator = document.getElementById(id);
            if (indicator) indicator.remove();
        }

        function removeExpertTypingIndicator(id) {
            const indicator = document.getElementById(id);
            if (indicator) indicator.remove();
        }

        // Expert Chat Functions
        function handleExpertChat(e) {
            if (e.key === 'Enter') sendExpertMessage();
        }

        function sendQuickQuestion(question) {
            const input = document.getElementById('expert-chat-input');
            input.value = question;
            sendExpertMessage();
        }

        function sendExpertMessage() {
            const input = document.getElementById('expert-chat-input');
            const rawText = input.value.trim();
            if(!rawText) return;

            // Sanitize input
            const txt = Security.sanitizeHTML(rawText).toLowerCase();
            
            // Rate limiting
            if (!Security.rateLimit.check()) {
                addExpertChatMsg('Please wait a moment before sending another message.', 'expert');
                return;
            }

            addExpertChatMsg(rawText, 'user');
            input.value = '';

            // Show typing indicator
            const typingId = addExpertTypingIndicator();
            
            setTimeout(() => {
                removeExpertTypingIndicator(typingId);
                const response = getExpertResponse(txt);
                addExpertChatMsg(response, 'expert');
            }, 800 + Math.random() * 1200);
        }

        function addExpertChatMsg(msg, type) {
            const container = document.getElementById('expert-chat-messages');
            const div = document.createElement('div');
            
            if (type === 'user') {
                div.className = 'flex justify-end';
                div.innerHTML = `
                    <div class="bg-green-600 text-white p-3 rounded-lg rounded-tr-none shadow-sm max-w-[80%] text-sm">
                        ${msg}
                    </div>
                `;
            } else {
                div.className = 'flex items-start gap-2';
                div.innerHTML = `
                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-xs flex-shrink-0">
                        <i class="fa-solid fa-user-tie"></i>
                    </div>
                    <div class="bg-white rounded-lg p-3 shadow-sm max-w-[80%] text-sm text-slate-700" style="white-space: pre-line;">
                        ${msg}
                    </div>
                `;
            }
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function addExpertTypingIndicator() {
            const container = document.getElementById('expert-chat-messages');
            const div = document.createElement('div');
            const id = 'expert-typing-' + Date.now();
            div.id = id;
            div.className = 'flex items-start gap-2';
            div.innerHTML = `
                <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-xs flex-shrink-0">
                    <i class="fa-solid fa-user-tie"></i>
                </div>
                <div class="bg-white rounded-lg p-3 shadow-sm flex gap-1 items-center">
                    <div class="w-2 h-2 bg-green-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                    <div class="w-2 h-2 bg-green-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                    <div class="w-2 h-2 bg-green-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return id;
        }

        function getExpertResponse(txt) {
            // Current build context - more human responses
            if (state.currentBuild) {
                if (/check|review|look|analyze|thoughts/i.test(txt)) {
                    const build = state.currentBuild;
                    if (build.type === 'desktop') {
                        const data = build.data;
                        return `Alright, let me take a look at your build...\n\nOkay so you've got the ${data.gpu.name} — solid pick for ${state.usage}. Pairs nicely with the ${data.cpu.name}.\n\nHonest thoughts:\n• This combo won't bottleneck each other, which is good\n• PSU should handle it fine\n• I'd maybe add a couple extra fans down the line\n\nOverall? You're in good shape. 👍 Any specific concerns?`;
                    } else {
                        return `Let me check this laptop out...\n\n${build.data.name} at ₹${build.data.price.toLocaleString('en-IN')}\n\nFor ${state.usage}, this should work well. A few things I'd look into:\n• Check YouTube reviews for real-world thermals\n• Make sure you're getting at least 1 year warranty\n• See if RAM is upgradeable (some laptops solder it in)\n\nAnything specific bugging you about this choice?`;
                    }
                }
            }

            // Troubleshooting - conversational
            if (/problem|issue|error|crash|not.*work|fail|blue.*screen|bsod/i.test(txt)) {
                if (/boot|start|turn.*on|power/i.test(txt)) {
                    return `Oof, no boot is stressful. Let's figure this out.\n\nFirst, the basics:\n1. Is the PSU switch on? (Back of the power supply)\n2. Check the 24-pin motherboard cable and 8-pin CPU cable\n3. Try reseating your RAM — pull them out, put them back\n4. If you have 2 RAM sticks, try just one\n\nDoes the motherboard light up at all? Any beeps or LED codes? That'll tell us a lot.`;
                } else if (/overheat|hot|temp|thermal/i.test(txt)) {
                    return `Overheating sucks. Let's cool things down.\n\nQuick wins:\n• Clean out dust (seriously, grab some compressed air)\n• Check if all fans are spinning\n• Make sure your cooler is mounted properly\n\nIf it's a new build, you might need to reapply thermal paste. Use a pea-sized amount.\n\nWhat temps are you seeing? And is it CPU, GPU, or both running hot?`;
                } else if (/fps|stutter|lag|performance/i.test(txt)) {
                    return `Performance issues can be tricky. Let's narrow it down.\n\nFirst things first:\n1. Update your GPU drivers (use DDU for a clean install)\n2. Check if XMP is enabled in BIOS — big difference for RAM speed\n3. Open Task Manager while gaming — is CPU or GPU at 100%?\n\nAlso, what game and what settings? Sometimes just turning down shadows makes a huge difference.`;
                } else {
                    return `Hmm, let me help you troubleshoot this.\n\nCan you tell me:\n• What exactly is happening?\n• When did it start?\n• Did you change anything recently?\n• What are your specs?\n\nThe more details the better — even small things can be clues!`;
                }
            }

            // Upgrade advice - more conversational
            if (/upgrade|improve|better|should.*i/i.test(txt)) {
                if (/gpu|graphics/i.test(txt)) {
                    return `GPU upgrade, nice! That's usually the biggest performance jump.\n\nBefore we pick one, I need to know:\n• What's your current GPU?\n• What resolution/FPS are you targeting?\n• What's your PSU wattage?\n• And your CPU (to check for bottlenecks)?\n\nIn general right now:\n• ₹35K: RTX 4060 (great 1080p card)\n• ₹55-65K: RTX 4070 (1440p sweet spot)\n• ₹80K+: RTX 4070 Ti Super\n\nWhat's your setup looking like?`;
                } else if (/cpu|processor/i.test(txt)) {
                    return `CPU upgrade can be tricky because it might need a new motherboard too.\n\nWhat CPU and motherboard do you have now? That'll tell us if you can just drop in a newer chip or need a whole platform change.\n\nIf you're on AM4 (older Ryzen), a 5600X or 5800X3D is a solid upgrade.\nOn LGA1700 (Intel 12th-14th gen), you have options within the same board.\n\nWhat games/apps are feeling slow?`;
                } else if (/ram|memory/i.test(txt)) {
                    return `RAM upgrade is usually pretty easy!\n\nQuick questions:\n• How much do you have now? (16GB is fine for most people)\n• DDR4 or DDR5?\n• What speed is it running at?\n\nHonest take: If you're at 16GB and just gaming, you probably don't need more. But if you do video editing, run VMs, or have tons of Chrome tabs open... 32GB helps.\n\nAnd make sure XMP is enabled in BIOS — free performance!`;
                } else {
                    return `Upgrade advice really depends on what you're trying to improve.\n\nFor gaming: GPU first, always. That's your biggest FPS boost.\nFor editing/streaming: More RAM and a better CPU help a lot.\nFor general speed: An SSD if you're still on hard drive (game changer).\n\nWhat's feeling slow for you right now?`;
                }
            }

            // Component recommendations - more natural
            if (/recommend|suggest|best|good|which/i.test(txt)) {
                if (/motherboard|mobo/i.test(txt)) {
                    return `Motherboard recs depend on your CPU, but here's the gist:\n\nFor AMD Ryzen 7000:\n• Budget: B650M DS3H (~₹12K)\n• Mid: MSI B650 Tomahawk (~₹20K)\n• High-end: X670E boards (~₹35K+)\n\nFor Intel 13th/14th Gen:\n• Budget: B760M (~₹12K)\n• Mid: Z790 Gaming Plus (~₹22K)\n\nWhat CPU are you going with? That'll narrow it down.`;
                } else if (/psu|power.*supply/i.test(txt)) {
                    return `PSU is important — don't cheap out here!\n\nBrands I trust: Corsair RM/RMx, Seasonic, MSI MPG, EVGA G6.\n\nWattage guide:\n• RTX 4060 builds: 550-650W is fine\n• RTX 4070 builds: 650-750W\n• RTX 4080/4090: 850W minimum\n\nAlways go 80+ Gold or better, and fully modular makes building way easier.\n\nWhat GPU are you running?`;
                } else if (/case/i.test(txt)) {
                    return `Cases are honestly down to preference, but I'll share my favorites:\n\nBest airflow:\n• Lian Li Lancool 216 (~₹9K) — my go-to recommendation\n• Corsair 4000D Airflow (~₹8K)\n\nGood looking + functional:\n• NZXT H510 Flow (~₹8K)\n• Lian Li O11 Dynamic (~₹15K) if you want that showcase build\n\nJust make sure it has a mesh front panel. Solid fronts = hot components.\n\nATX or smaller build?`;
                } else if (/cooler|cooling/i.test(txt)) {
                    return `Cooler depends on your CPU's heat output.\n\nFor 65W CPUs (most Ryzen, i5): Stock cooler is fine, or grab a DeepCool AK400 (~₹2K) for quieter operation.\n\nFor 105W+ CPUs: You want something beefier:\n• Air: Noctua NH-U12S (~₹6K) or Thermalright Peerless Assassin\n• AIO: Arctic Liquid Freezer II or DeepCool LT520\n\nWhat CPU are you cooling?`;
                }
            }

            // Compatibility checks
            if (/fit|compatible|work.*with|support/i.test(txt)) {
                return `🔍 Compatibility Check Service:\n\n📝 To help you, I need:\n1️⃣ CPU model\n2️⃣ Motherboard model\n3️⃣ RAM type & speed\n4️⃣ GPU model\n5️⃣ PSU wattage\n6️⃣ Case size\n\n✅ I'll verify:\n✓ CPU socket match\n✓ RAM compatibility\n✓ PCIe slot availability\n✓ PSU power adequacy\n✓ Physical clearances\n✓ BIOS update needs\n\nList your components!`;
            }

            // Price/value questions
            if (/worth|price|cost|value|deal|should.*buy/i.test(txt)) {
                return `💰 Value Assessment Expert:\n\n🎯 Current Market (Dec 2024):\n\n✅ Good Deals:\n• RTX 4070: ₹55-60k\n• Ryzen 7 7800X3D: ₹36-38k\n• RTX 4060: ₹30-33k\n\n⚠️ Wait/Overpriced:\n• RTX 3000 series (outdated)\n• Intel 12th gen (13th/14th better value)\n\n💡 Value Tips:\n• Check launch vs current price\n• Compare to next tier up\n• Consider used market (GPUs)\n• Wait for sales (holidays)\n\nWhat component are you eyeing?`;
            }

            // Building help
            if (/build|assemble|install|how.*to|guide|tutorial/i.test(txt)) {
                if (/first.*time|beginner|never/i.test(txt)) {
                    return `👷 First Build? You got this!\n\n📺 Watch:\n1. Linus Tech Tips build guide\n2. JayzTwoCents beginners guide\n\n⚠️ Common Mistakes:\n❌ Forgetting I/O shield\n❌ Not using motherboard standoffs\n❌ Forgetting to flip PSU switch\n❌ Not connecting CPU power (8-pin)\n❌ Overtightening screws\n\n💡 Pro Tips:\n✓ Build on table first (test boot)\n✓ Install RAM in slots 2&4\n✓ Apply pea-sized thermal paste\n✓ Cable management = better airflow\n\nTake your time! Any specific step?`;
                } else {
                    return `🔧 Build Assembly Order:\n\n1️⃣ Install I/O shield in case\n2️⃣ Mount motherboard standoffs\n3️⃣ Install CPU on motherboard\n4️⃣ Apply thermal paste\n5️⃣ Mount CPU cooler\n6️⃣ Install RAM\n7️⃣ Mount motherboard in case\n8️⃣ Install PSU\n9️⃣ Install storage drives\n🔟 Install GPU\n1️⃣1️⃣ Connect all cables\n1️⃣2️⃣ Cable management\n1️⃣3️⃣ Test boot!\n\nWhich step needs help?`;
                }
            }

            // Default expert responses
            const expertResponses = [
                `👨‍💻 I'm here to help with expert advice!\n\nI can assist with:\n🔧 Troubleshooting\n💡 Component selection\n⚡ Performance optimization\n🎮 Gaming builds\n💼 Workstation setups\n🔍 Compatibility checks\n\nWhat specific question do you have?`,
                
                `💬 Let me help you with that!\n\nFor the best advice, tell me:\n• Your budget\n• Your use case (gaming/work/both)\n• Current components (if upgrading)\n• Specific concerns\n\nThe more details, the better I can help!`,
                
                `🎯 Expert tip: Always verify component compatibility before buying!\n\nKey checks:\n✓ CPU socket matches motherboard\n✓ RAM type (DDR4/DDR5)\n✓ PSU wattage for your GPU\n✓ Case size fits your motherboard\n✓ Cooler height clearance\n\nNeed a compatibility check?`
            ];

            return expertResponses[Math.floor(Math.random() * expertResponses.length)];
        }

        function addChatMsg(text, sender) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = `flex gap-2 chat-msg ${sender === 'user' ? 'flex-row-reverse' : ''}`;
            const icon = sender === 'ai' 
                ? '<div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 text-xs"><i class="fa-solid fa-robot"></i></div>' 
                : '<div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-xs"><i class="fa-solid fa-user"></i></div>';
            
            // Sanitize text for display
            const safeText = Security.sanitizeHTML(text);
            const formattedText = safeText.replace(/\n/g, '<br>');
            
            const bubble = `<div class="${sender === 'ai' ? 'bg-white border-slate-100 text-slate-700' : 'bg-blue-600 text-white'} p-3 rounded-2xl ${sender === 'ai' ? 'rounded-tl-none' : 'rounded-tr-none'} shadow-sm text-sm max-w-[80%] border whitespace-pre-line">${formattedText}</div>`;
            div.innerHTML = icon + bubble;
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
        }
    </script>
</body>
</html>